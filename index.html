<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VibeMarketing</title>
    <style>
        /* ===== LIGHT THEME (default) ===== */
        :root {
            --bg: #f4f5f8;
            --panel: #ffffff;
            --border: #d8dbe5;
            --text: #1e2030;
            --dim: #6b7085;
            --accent: #3b7bef;
            --purple: #6a4de0;
            --green: #22a870;

            --hover-bg: #e8eaf0;
            --active-bg: #dce6f5;
            --save-bg: #d4edda;
            --save-border: #5cb85c;
            --save-flash-bg: #b8e6c8;
            --del-bg: #fde8e8;
            --del-bg-hover: #fbd0d0;
            --del-border: #e57373;
            --del-text: #d32f2f;
            --news-hover-bg: #d4edda;
            --on-accent: #fff;
            --confirm-ok-bg: #c62828;
            --confirm-ok-hover: #e53935;
            --tooltip-bg: rgba(255,255,255,.96);
            --tooltip-shadow: 0 8px 30px rgba(0,0,0,.12);
            --overlay-bg: rgba(0,0,0,.35);
            --upload-bg: rgba(240,242,248,.95);
            --cell-border: rgba(0,0,0,.12);
            --cell-glow: rgba(59,123,239,.4);
            --card-shadow: 0 12px 40px rgba(0,0,0,.1);
            --menu-shadow: 0 4px 20px rgba(0,0,0,.1);
            --error-border: #e11d48;
            --bar-text: #fff;
            --color-sw-sel: #333;
            --tl-hover-glow: rgba(0,0,0,.15);

            --scene-bg: #f4f5f8;
            --empty-wire: #b0b8d0;
            --empty-fill: #d8dde8;
            --plane-grid: #b0bcd5;
            --label-company: #4a5070;
            --label-event: #6840a0;
            --label-week: #7078a0;
        }
        /* ===== DARK THEME ===== */
        [data-theme="dark"] {
            --bg: #0b0d14;
            --panel: #13151f;
            --border: #1f2233;
            --text: #d8dae8;
            --dim: #6a6d82;
            --accent: #4f8cff;
            --purple: #7c5cfc;
            --green: #34d399;

            --hover-bg: #1a1d2a;
            --active-bg: #1a2a40;
            --save-bg: #1a3a2a;
            --save-border: #2d6b4a;
            --save-flash-bg: #0d5a3a;
            --del-bg: #3a1520;
            --del-bg-hover: #4a1828;
            --del-border: #6b2030;
            --del-text: #f87171;
            --news-hover-bg: #1a3a2a;
            --on-accent: #fff;
            --confirm-ok-bg: #b91c1c;
            --confirm-ok-hover: #dc2626;
            --tooltip-bg: rgba(13,15,22,.94);
            --tooltip-shadow: 0 8px 30px rgba(0,0,0,.5);
            --overlay-bg: rgba(0,0,0,.6);
            --upload-bg: rgba(11,13,20,.92);
            --cell-border: rgba(255,255,255,.15);
            --cell-glow: rgba(79,140,255,.5);
            --card-shadow: 0 12px 40px rgba(0,0,0,.6);
            --menu-shadow: 0 4px 20px rgba(0,0,0,.5);
            --error-border: #f43f5e;
            --bar-text: #fff;
            --color-sw-sel: #fff;
            --tl-hover-glow: rgba(255,255,255,.3);

            --scene-bg: #0b0d14;
            --empty-wire: #3a4570;
            --empty-fill: #1a2040;
            --plane-grid: #2a3560;
            --label-company: #8890b0;
            --label-event: #9070c8;
            --label-week: #5a6080;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg); color: var(--text);
            overflow: hidden; height: 100vh;
        }
        #topbar {
            position:fixed; top:0; left:0; right:0; height:48px;
            background: var(--panel); border-bottom:1px solid var(--border);
            display:flex; align-items:center; padding:0 16px; gap:10px; z-index:100;
        }
        #topbar h1 {
            font-size:15px; font-weight:600; white-space:nowrap;
            background:linear-gradient(135deg,var(--accent),var(--purple));
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        }
        .sep { width:1px; height:24px; background:var(--border); }
        .btn {
            padding:5px 12px; border-radius:5px; border:1px solid var(--border);
            background:var(--panel); color:var(--text); font-size:12px; cursor:pointer;
            white-space:nowrap;
        }
        .btn:hover { border-color:var(--accent); background:var(--hover-bg); }
        .btn-p { background:var(--accent); border-color:var(--accent); color:var(--on-accent); }
        .btn.active { border-color:var(--accent); background:var(--active-bg); }
        .btn-save { background:var(--save-bg); border-color:var(--save-border); color:var(--green); }
        .btn-icon {
            padding:5px 8px; border-radius:5px; border:1px solid var(--border);
            background:var(--panel); color:var(--dim); cursor:pointer; display:flex;
            align-items:center; justify-content:center; width:32px; height:32px;
        }
        .btn-icon:hover { border-color:var(--accent); color:var(--text); background:var(--hover-bg); }
        .btn-icon.active { border-color:var(--accent); color:var(--accent); background:var(--active-bg); }
        .btn-icon svg { width:16px; height:16px; fill:currentColor; }

        /* Pill-tabs for view navigation */
        .tb-tabs { display:inline-flex; background:var(--hover-bg); border-radius:7px; padding:2px; gap:1px; }
        .tb-tab { padding:4px 10px; border-radius:5px; border:none; background:none;
            color:var(--dim); font-size:12px; cursor:pointer; white-space:nowrap; transition:all .15s; }
        .tb-tab:hover { color:var(--text); background:var(--panel); }
        .tb-tab.active { background:var(--panel); color:var(--accent); font-weight:600;
            box-shadow:0 1px 3px rgba(0,0,0,.08); }

        /* Dropdown menus (settings, user) */
        .tb-dropdown { position:relative; display:inline-flex; align-items:center; }
        .tb-dropdown-toggle { padding:3px 6px; border-radius:5px; border:1px solid transparent;
            background:none; color:var(--dim); cursor:pointer; font-size:15px; line-height:1;
            display:flex; align-items:center; justify-content:center; transition:all .15s; }
        .tb-dropdown-toggle:hover { border-color:var(--border); color:var(--text); background:var(--hover-bg); }
        .tb-dropdown-toggle.tb-settings { font-size:20px; width:34px; height:34px; }
        .tb-dropdown-menu { position:absolute; top:calc(100% + 4px); right:0;
            background:var(--panel); border:1px solid var(--border); border-radius:8px;
            box-shadow:0 8px 24px rgba(0,0,0,.15); min-width:210px; padding:4px 0;
            display:none; z-index:200; }
        .tb-dropdown-menu.open { display:block; }
        .tb-dropdown-menu button { width:100%; padding:9px 16px; border:none; background:none;
            text-align:left; font-size:13px; color:var(--text); cursor:pointer;
            display:flex; align-items:center; gap:10px; white-space:nowrap; }
        .tb-dropdown-menu button:hover { background:var(--hover-bg); }
        .tb-dropdown-sep { height:1px; background:var(--border); margin:4px 8px; }

        /* User avatar button */
        .tb-avatar { width:30px; height:30px; border-radius:50%; border:1px solid var(--border);
            background:var(--hover-bg); color:var(--text); font-size:11px; font-weight:700;
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            transition:all .15s; letter-spacing:-0.5px; }
        .tb-avatar:hover { border-color:var(--accent); background:var(--active-bg); }

        /* Grouped toolbar sections */
        .tb-group { display:inline-flex; align-items:center; gap:4px;
            background:var(--hover-bg); border-radius:6px; padding:2px 6px; }

        .flt-btns { display:flex; gap:4px; margin-bottom:4px; }
        .flt-btns button { font-size:10px; padding:2px 8px; border:1px solid var(--border); border-radius:3px; background:var(--panel); color:var(--dim); cursor:pointer; }
        .flt-btns button:hover { border-color:var(--accent); color:var(--text); }
        .stats { font-size:11px; color:var(--dim); display:flex; gap:6px 12px; white-space:nowrap; flex-shrink:0; align-items:center; }
        .stats b { color:var(--text); }
        @media (max-width:1100px) { .stats { font-size:10px; gap:4px 8px; } }
        @media (max-width:900px) { .stats { display:none; } }

        #canvas-wrap { position:fixed; top:48px; left:0; right:320px; bottom:0; }
        #canvas-wrap.full { right:0; }
        canvas { display:block; }

        #panel {
            position:fixed; top:48px; right:0; width:320px; bottom:0;
            background:var(--panel); border-left:1px solid var(--border);
            overflow-y:auto; padding:14px; z-index:90; transition:transform .25s;
        }
        #panel.hide { transform:translateX(320px); }
        #panel .panel-close {
            position:absolute; top:10px; right:10px; background:none; border:1px solid var(--border);
            color:var(--dim); font-size:18px; cursor:pointer; width:28px; height:28px;
            border-radius:5px; display:flex; align-items:center; justify-content:center; line-height:1;
        }
        #panel .panel-close:hover { border-color:var(--accent); color:var(--text); background:var(--hover-bg); }
        #panel h3 { font-size:11px; text-transform:uppercase; letter-spacing:.5px; color:var(--dim); margin:12px 0 6px; }
        #panel h3:first-child { margin-top:0; }
        .leg { display:flex; align-items:center; gap:6px; padding:2px 0; font-size:12px; }
        .leg-dot { width:10px; height:10px; border-radius:2px; flex-shrink:0; }
        .flt label { display:flex; align-items:center; gap:6px; padding:2px 0; font-size:12px; cursor:pointer; }
        .flt input { accent-color:var(--accent); }

        #tip {
            position:fixed; pointer-events:none; display:none;
            background:var(--tooltip-bg); border:1px solid var(--border);
            border-radius:8px; padding:10px 14px; font-size:12px; line-height:1.6;
            max-width:320px; z-index:200; box-shadow:var(--tooltip-shadow);
        }
        #tip .t-name { font-size:14px; font-weight:600; }
        #tip .t-dim { color:var(--dim); }
        #tip .t-badge {
            display:inline-block; padding:1px 8px; border-radius:3px;
            font-size:11px; font-weight:600; margin-top:4px;
        }

        #upload {
            position:fixed; top:48px; left:0; right:0; bottom:0;
            background:var(--upload-bg); display:flex; align-items:center;
            justify-content:center; z-index:150;
        }
        #upload.gone { display:none; }
        .ucard {
            background:var(--panel); border:2px dashed var(--border);
            border-radius:14px; padding:50px 70px; text-align:center;
        }
        .ucard.over { border-color:var(--accent); }
        .ucard h2 { font-size:18px; margin-bottom:6px; }
        .ucard p { color:var(--dim); font-size:13px; margin-bottom:20px; }
        .ucard .or { color:var(--dim); font-size:12px; margin:14px 0; }
        #finp { display:none; }

        #detail {
            position:fixed; top:48px; left:0; width:350px; bottom:0;
            background:var(--panel); border-right:1px solid var(--border);
            overflow-y:auto; padding:18px; z-index:90;
            transform:translateX(-350px); transition:transform .25s;
        }
        #detail.open { transform:translateX(0); }
        #detail h2 { font-size:15px; margin-bottom:3px; }
        .dmeta { color:var(--dim); font-size:12px; margin-bottom:14px; line-height:1.6; }
        .tl { padding-left:20px; position:relative; }
        .tl::before { content:''; position:absolute; left:6px; top:2px; bottom:2px; width:2px; background:var(--border); }
        .tl-i { position:relative; margin-bottom:14px; }
        .tl-i::before {
            content:''; position:absolute; left:-18px; top:3px;
            width:8px; height:8px; border-radius:50%;
            border:2px solid var(--accent); background:var(--bg);
        }
        .tl-i.done::before { background:var(--accent); }
        .tl-i .t { font-size:12px; font-weight:600; }
        .tl-i .d { font-size:11px; color:var(--dim); }
        .tl-i .e { font-size:11px; color:var(--accent); }
        .cls { position:absolute; top:14px; right:14px; background:none; border:none; color:var(--dim); font-size:18px; cursor:pointer; }

        #keys {
            position:fixed; bottom:12px; left:12px;
            background:var(--panel); border:1px solid var(--border);
            border-radius:8px; padding:10px 16px; font-size:11px; color:var(--dim);
            z-index:100; line-height:2; max-width:calc(100vw - 360px);
            transition: transform .25s, opacity .25s;
        }
        #keys.hide { transform:translateY(100px); opacity:0; pointer-events:none; }
        #keys kbd {
            display:inline-block; padding:0 5px; background:var(--hover-bg);
            border:1px solid var(--border); border-radius:3px; font-size:10px; color:var(--text);
        }
        #keys b { color:var(--text); font-size:10px; }

        /* Edit mode */
        #editPanel {
            position:fixed; top:48px; left:0; width:350px; bottom:0;
            background:var(--panel); border-right:1px solid var(--border);
            overflow-y:auto; padding:18px; z-index:90;
            transform:translateX(-350px); transition:transform .25s;
        }
        #editPanel.open { transform:translateX(0); }
        #editPanel h2 { font-size:14px; margin-bottom:12px; color:var(--accent); }
        #editPanel label { display:block; font-size:12px; color:var(--dim); margin:8px 0 3px; }
        #editPanel select, #editPanel input[type=date] {
            width:100%; padding:6px 8px; background:var(--hover-bg); border:1px solid var(--border);
            color:var(--text); border-radius:4px; font-size:12px;
        }
        #editPanel select:focus, #editPanel input:focus { border-color:var(--accent); outline:none; }
        .edit-actions { display:flex; gap:8px; margin-top:14px; }
        .edit-actions button { flex:1; padding:6px; border-radius:4px; font-size:12px; cursor:pointer; border:1px solid var(--border); }
        .edit-save { background:var(--accent); border-color:var(--accent)!important; color:var(--on-accent); }
        .edit-save:hover { opacity:0.9; }
        .edit-del { background:var(--del-bg); border-color:var(--del-border)!important; color:var(--del-text); }
        .edit-del:hover { background:var(--del-bg-hover); }
        .edit-cancel { background:var(--panel); color:var(--dim); }
        .edit-cancel:hover { border-color:var(--accent); color:var(--text); }
        .edit-info { font-size:12px; color:var(--dim); padding:4px 0; line-height:1.6; }
        .edit-info b { color:var(--text); }

        /* Context menu */
        #ctxMenu {
            position:fixed; display:none; z-index:300;
            background:var(--panel); border:1px solid var(--border);
            border-radius:6px; padding:4px 0; box-shadow:var(--menu-shadow);
            min-width:160px;
        }
        #ctxMenu .ctx-item {
            padding:6px 14px; font-size:12px; cursor:pointer; display:flex; align-items:center; gap:8px;
        }
        #ctxMenu .ctx-item:hover { background:var(--hover-bg); }
        #ctxMenu .ctx-item.ctx-del { color:var(--del-text); }
        #ctxMenu .ctx-sep { height:1px; background:var(--border); margin:4px 0; }

        /* Mode indicator */
        .mode-indicator {
            position:fixed; bottom:50px; left:50%; transform:translateX(-50%);
            background:var(--accent); color:var(--on-accent); padding:5px 16px; border-radius:20px;
            font-size:12px; font-weight:600; z-index:100; pointer-events:none;
            transition:opacity .3s; opacity:0;
        }
        .mode-indicator.show { opacity:1; }

        /* 2D View */
        #view2d {
            position:fixed; top:48px; left:0; right:320px; bottom:0;
            background:var(--bg); overflow:auto; display:none; z-index:80;
        }
        #view2d.full { right:0; }
        #view2d.active { display:block; }
        #view2d table { border-collapse:collapse; margin:20px; }
        #view2d th { font-size:10px; color:var(--dim); padding:3px 4px; text-align:center; min-width:32px;
            position:sticky; top:0; background:var(--bg); z-index:2; }
        #view2d th.co-header { text-align:right; padding-right:8px; font-size:11px; color:var(--text);
            position:sticky; left:0; background:var(--bg); z-index:3; white-space:nowrap; max-width:180px; overflow:hidden; text-overflow:ellipsis; }
        #view2d th.corner { position:sticky; left:0; top:0; z-index:4; background:var(--bg); }
        #view2d td { padding:2px; text-align:center; }
        .cell2d {
            width:28px; height:28px; border-radius:3px; display:inline-block; cursor:pointer;
            border:1px solid transparent; transition:transform .15s, box-shadow .15s;
        }
        .cell2d:hover { transform:scale(1.3); box-shadow:0 0 8px var(--cell-glow); z-index:10; position:relative; }
        .cell2d.empty-cell { background:var(--hover-bg); border-color:var(--border); opacity:0.3; }
        .cell2d.empty-cell:hover { opacity:0.7; border-color:var(--accent); }
        .cell2d.filled { border-color:var(--cell-border); }
        .cell2d.blink2d {
            animation: blink2d 1.2s ease-in-out infinite;
        }
        @keyframes blink2d {
            0%, 100% { opacity:1; box-shadow:0 0 4px rgba(79,140,255,.3); }
            50% { opacity:0.4; box-shadow:0 0 12px rgba(79,140,255,.7); }
        }

        /* Custom confirm dialog */
        #confirmOverlay {
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:var(--overlay-bg); z-index:500; display:none;
            align-items:center; justify-content:center;
        }
        #confirmOverlay.show { display:flex; }
        #confirmBox {
            background:var(--panel); border:1px solid var(--border); border-radius:12px;
            padding:24px 30px; max-width:400px; width:90%;
            box-shadow:var(--card-shadow);
        }
        #confirmBox .cf-title { font-size:14px; font-weight:600; margin-bottom:8px; color:var(--text); }
        #confirmBox .cf-msg { font-size:13px; color:var(--dim); margin-bottom:18px; line-height:1.5; }
        #confirmBox .cf-actions { display:flex; gap:10px; justify-content:flex-end; }
        #confirmBox .cf-btn { padding:7px 18px; border-radius:6px; font-size:12px; cursor:pointer; border:1px solid var(--border); }
        #confirmBox .cf-ok { background:var(--confirm-ok-bg); border-color:var(--confirm-ok-bg); color:var(--on-accent); }
        #confirmBox .cf-ok:hover { background:var(--confirm-ok-hover); }
        #confirmBox .cf-cancel { background:var(--panel); color:var(--dim); }
        #confirmBox .cf-cancel:hover { border-color:var(--accent); color:var(--text); }

        /* Ghost tooltip for 3D add mode */
        #ghostTip {
            position:fixed; pointer-events:none; display:none;
            background:rgba(79,140,255,.15); border:1px solid var(--accent);
            border-radius:6px; padding:6px 12px; font-size:11px; line-height:1.4;
            z-index:200; color:var(--accent); backdrop-filter:blur(6px);
            white-space:nowrap;
        }
        #ghostTip b { color:var(--text); }

        /* 2D company logo img */
        .co-logo { width:16px; height:16px; border-radius:2px; vertical-align:middle; margin-right:4px; }

        /* Timeline view */
        #viewTimeline {
            position:fixed; top:48px; left:0; right:320px; bottom:0;
            background:var(--bg); overflow:auto; display:none; z-index:80;
        }
        #viewTimeline.full { right:0; }
        #viewTimeline.active { display:block; }
        .tl-container { padding:16px; }
        .tl-header { display:flex; align-items:flex-end; margin-bottom:4px; padding-left:158px; }
        .tl-week-label { font-size:9px; color:var(--dim); text-align:center; flex-shrink:0; }
        .tl-row { display:flex; align-items:center; margin-bottom:1px; min-height:18px; }
        .tl-row-label { width:150px; flex-shrink:0; font-size:10px; color:var(--dim); text-align:right;
            padding-right:8px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .tl-row-bars { display:flex; position:relative; flex:1; height:16px; }
        .tl-bar {
            position:absolute; height:14px; border-radius:2px; top:1px;
            opacity:0.85; cursor:default; transition: opacity .15s;
            display:flex; align-items:center; justify-content:center; padding:0 2px;
            font-size:8px; color:var(--on-accent); font-weight:600; white-space:nowrap; overflow:hidden;
        }
        .tl-bar:hover { opacity:1; box-shadow:0 0 6px var(--tl-hover-glow); z-index:2; }
        .tl-co-row.tl-dimmed { opacity:0.15; transition:opacity .15s; }
        .tl-co-row { transition:opacity .15s; }
        .tl-ev-bar { user-select:none; }
        .tl-empty-cell {
            position:absolute; top:0; height:16px; border-radius:2px;
            background:transparent; cursor:cell; opacity:0; transition:opacity .15s, background .15s;
            border:1px dashed transparent; z-index:1;
        }
        .tl-empty-cell:hover {
            opacity:0.7; background:var(--hover-bg); border-color:var(--accent);
        }
        .tl-grid-line { position:absolute; top:0; bottom:0; width:1px; background:var(--border); opacity:0.3; }
        .tl-section { margin-bottom:16px; }
        .tl-section-title { font-size:12px; font-weight:600; color:var(--accent); padding-left:10px;
            margin-bottom:6px; border-left:3px solid var(--accent); }

        /* Events & Companies views */
        #viewEvents, #viewCompanies {
            position:fixed; top:48px; left:0; right:320px; bottom:0;
            background:var(--bg); overflow:auto; display:none; z-index:80;
        }
        #viewEvents.full, #viewCompanies.full { right:0; }
        #viewEvents.active, #viewCompanies.active { display:block; }
        .list-view { padding:20px 24px; max-width:1100px; }
        .list-view h2 { font-size:16px; font-weight:600; color:var(--accent); margin-bottom:14px; }
        .lv-card {
            background:var(--panel); border:1px solid var(--border); border-radius:8px;
            padding:14px 16px; margin-bottom:10px; display:flex; gap:14px; align-items:flex-start;
            transition: border-color .15s;
        }
        .lv-card:hover { border-color:var(--accent); }
        .lv-color { width:6px; border-radius:3px; align-self:stretch; flex-shrink:0; }
        .lv-logo { width:36px; height:36px; border-radius:6px; flex-shrink:0; object-fit:cover; }
        .lv-logo-init { width:36px; height:36px; border-radius:6px; flex-shrink:0; display:flex;
            align-items:center; justify-content:center; font-size:14px; font-weight:700; color:var(--on-accent); }
        .lv-body { flex:1; min-width:0; }
        .lv-title { font-size:14px; font-weight:600; color:var(--text); margin-bottom:2px; }
        .lv-meta { font-size:11px; color:var(--dim); line-height:1.6; }
        .lv-meta b { color:var(--text); font-weight:500; }
        .lv-meta .lv-badge {
            display:inline-block; padding:1px 7px; border-radius:3px;
            font-size:10px; font-weight:600; color:var(--on-accent); margin-left:4px;
        }
        .lv-notes { width:100%; margin-top:8px; padding:6px 8px; background:var(--hover-bg);
            border:1px solid var(--border); color:var(--text); border-radius:4px;
            font-size:12px; font-family:inherit; resize:vertical; min-height:36px; }
        .lv-notes:focus { border-color:var(--accent); outline:none; }
        .lv-notes::placeholder { color:var(--dim); }
        .lv-actions { display:flex; flex-direction:column; gap:4px; flex-shrink:0; align-self:center; }
        .lv-actions button { padding:4px 10px; border-radius:4px; font-size:11px; cursor:pointer;
            border:1px solid var(--border); background:var(--panel); color:var(--dim); white-space:nowrap; }
        .lv-actions button:hover { border-color:var(--accent); color:var(--text); }
        .lv-actions .lv-del { color:var(--del-text); }
        .lv-actions .lv-del:hover { border-color:var(--del-text); background:var(--del-bg); }
        .lv-actions .lv-news { color:var(--green); }
        .lv-actions .lv-news:hover { border-color:var(--green); background:var(--news-hover-bg); }
        .lv-add-btn { display:inline-block; margin-top:10px; padding:8px 20px; border-radius:6px;
            border:1px dashed var(--border); background:transparent; color:var(--accent);
            font-size:13px; cursor:pointer; transition: border-color .15s, background .15s; }
        .lv-add-btn:hover { border-color:var(--accent); background:var(--active-bg); }

        /* Finance modal */
        .fin-modal .fm-box { max-width:600px; }
        .fin-header { text-align:center; margin-bottom:16px; }
        .fin-header h2 { margin:0; font-size:17px; color:var(--text); }
        .fin-header .fin-sub { font-size:11px; color:var(--dim); margin-top:4px; }
        .fin-metrics { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
        .fin-metric {
            flex:1; min-width:110px; padding:12px 10px; border-radius:8px; text-align:center;
            background:var(--hover-bg); border:1px solid var(--border);
        }
        .fin-metric .fin-icon { font-size:20px; }
        .fin-metric .fin-value { font-size:18px; font-weight:700; color:var(--text); margin:4px 0 2px; }
        .fin-metric .fin-label { font-size:10px; color:var(--dim); }
        .fin-metric.positive .fin-value { color:var(--green); }
        .fin-metric.negative .fin-value { color:var(--del-text); }
        .fin-chart { width:100%; border-radius:8px; display:block; }
        .fin-loading { text-align:center; padding:50px 0; color:var(--dim); }
        .fin-spinner { display:inline-block; width:32px; height:32px; border:3px solid var(--border);
            border-top-color:var(--accent); border-radius:50%; animation:fin-spin .8s linear infinite; }
        @keyframes fin-spin { to { transform:rotate(360deg); } }
        .fin-not-found { text-align:center; padding:30px 0; color:var(--dim); font-size:13px; }
        .fin-not-found a { color:var(--accent); text-decoration:underline; }
        .fin-source { font-size:10px; color:var(--dim); text-align:right; margin-top:8px; }
        .fin-snippets { margin-top:12px; padding-top:12px; border-top:1px solid var(--border); }
        .fin-snippets summary { font-size:11px; color:var(--dim); cursor:pointer; }
        .fin-snippets .fin-snippet { font-size:11px; color:var(--text); margin-top:6px; line-height:1.5;
            padding:8px 10px; background:var(--hover-bg); border-radius:6px; }
        .fin-details { font-size:12px; color:var(--text); line-height:1.8; padding:10px;
            background:var(--hover-bg); border-radius:6px; margin-top:6px; }
        .fin-status-active { color:var(--green); font-weight:600; }
        .fin-status-warn { color:var(--del-text); font-weight:600; }
        .fin-key-setup { font-size:13px; color:var(--text); line-height:1.6; }
        .fin-key-setup a { color:var(--accent); }
        .fin-key-setup label { font-size:12px; font-weight:600; color:var(--dim); }

        /* DPrice scoring */
        .lv-dprice { background:linear-gradient(135deg,#667eea,#764ba2) !important; color:#fff !important; border:none !important; }
        .dp-modal .fm-box { max-width:520px; max-height:85vh; overflow-y:auto; padding:16px 22px; }
        .dp-score-ring { width:90px; height:90px; margin:10px auto; position:relative; }
        .dp-score-ring svg { width:90px; height:90px; transform:rotate(-90deg); }
        .dp-score-ring .dp-ring-bg { fill:none; stroke:var(--border); stroke-width:7; }
        .dp-score-ring .dp-ring-fg { fill:none; stroke-width:7; stroke-linecap:round;
            transition:stroke-dashoffset .8s ease, stroke .3s; }
        .dp-score-num { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
            font-size:24px; font-weight:800; color:var(--text); }
        .dp-score-num small { font-size:12px; font-weight:400; color:var(--dim); }
        .dp-factors { margin:8px 0; }
        .dp-factor { display:flex; align-items:center; gap:6px; padding:3px 0;
            border-bottom:1px solid var(--border); font-size:11px; }
        .dp-factor:last-child { border-bottom:none; }
        .dp-factor-name { flex:1; color:var(--text); min-width:0; }
        .dp-factor-score { font-weight:700; width:24px; text-align:center; font-size:11px; }
        .dp-factor-bar { width:50px; height:5px; border-radius:3px; background:var(--border); overflow:hidden; flex-shrink:0; }
        .dp-factor-bar-fill { height:100%; border-radius:3px; transition:width .5s ease; }
        .dp-factor-comment { font-size:10px; color:var(--dim); margin-top:1px; }
        .dp-summary { font-size:11px; color:var(--text); line-height:1.5; padding:8px 10px;
            background:var(--hover-bg); border-radius:6px; margin:8px 0; }
        .dp-recommendation { font-size:11px; color:var(--accent); font-weight:600;
            padding:6px 10px; border-left:3px solid var(--accent); margin:8px 0; }
        .dp-model-select { display:flex; gap:8px; align-items:center; justify-content:center;
            margin-bottom:10px; font-size:12px; }
        .dp-model-select select { padding:4px 8px; border-radius:6px; border:1px solid var(--border);
            background:var(--panel); color:var(--text); font-size:12px; }
        .dp-color-red { color:#e74c3c; }
        .dp-color-yellow { color:#f39c12; }
        .dp-color-green { color:#27ae60; }

        /* DPrice mini score circles on company cards */
        .lv-dp-scores { display:flex; gap:4px; margin-top:4px; flex-wrap:wrap; }
        .dp-mini { width:28px; height:28px; border-radius:50%; display:flex; align-items:center;
            justify-content:center; font-size:10px; font-weight:700; color:#fff; cursor:pointer;
            border:2px solid transparent; transition:transform .15s, border-color .15s; position:relative; }
        .dp-mini:hover { transform:scale(1.2); border-color:var(--accent); }
        .dp-mini[title] { cursor:pointer; }

        /* Batch DPrice progress modal */
        .dp-batch-overlay { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--overlay-bg);
            z-index:510; display:flex; align-items:center; justify-content:center; }
        .dp-batch-box { background:var(--panel); border:1px solid var(--border); border-radius:12px;
            padding:24px 30px; max-width:480px; width:90%; box-shadow:var(--card-shadow); text-align:center; }
        .dp-batch-box h3 { font-size:15px; font-weight:600; color:var(--accent); margin-bottom:12px; }
        .dp-batch-progress { width:100%; height:8px; background:var(--border); border-radius:4px;
            overflow:hidden; margin:12px 0; }
        .dp-batch-progress-fill { height:100%; background:linear-gradient(90deg,#667eea,#764ba2);
            border-radius:4px; transition:width .3s ease; }
        .dp-batch-status { font-size:12px; color:var(--dim); margin-top:8px; }
        .dp-batch-current { font-size:13px; font-weight:600; color:var(--text); margin-top:4px; }
        .dp-batch-counter { font-size:14px; font-weight:700; color:var(--accent); margin-bottom:8px; }

        /* Form modal */
        #formModal {
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:var(--overlay-bg); z-index:500; display:none;
            align-items:center; justify-content:center;
        }
        #formModal.show { display:flex; }
        .fm-box {
            background:var(--panel); border:1px solid var(--border); border-radius:12px;
            padding:24px 30px; max-width:440px; width:90%;
            box-shadow:var(--card-shadow);
        }
        .fm-box h2 { font-size:15px; font-weight:600; margin-bottom:14px; color:var(--accent); }
        .fm-box label { display:block; font-size:12px; color:var(--dim); margin:10px 0 3px; }
        .fm-box input[type=text], .fm-box input[type=number], .fm-box select {
            width:100%; padding:7px 10px; background:var(--hover-bg); border:1px solid var(--border);
            color:var(--text); border-radius:5px; font-size:13px;
        }
        .fm-box input:focus, .fm-box select:focus { border-color:var(--accent); outline:none; }
        .fm-row { display:flex; gap:8px; align-items:flex-end; }
        .fm-row > * { flex:1; }
        .fm-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:18px; }
        .fm-actions button { padding:7px 20px; border-radius:6px; font-size:12px; cursor:pointer; border:1px solid var(--border); }
        .fm-ok { background:var(--accent); border-color:var(--accent)!important; color:var(--on-accent); }
        .fm-ok:hover { opacity:0.9; }
        .fm-cancel { background:var(--panel); color:var(--dim); }
        .fm-cancel:hover { border-color:var(--accent); color:var(--text); }
        /* Color palette */
        .color-pal { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
        .color-sw {
            width:26px; height:26px; border-radius:50%; cursor:pointer;
            border:2px solid transparent; transition:transform .15s, border-color .15s;
        }
        .color-sw:hover { transform:scale(1.2); }
        .color-sw.sel { border-color:var(--color-sw-sel); transform:scale(1.2); }

        ::-webkit-scrollbar { width:5px; }
        ::-webkit-scrollbar-track { background:transparent; }
        ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

        /* Google Sheets sync indicator */
        .gs-status { display:inline-flex; align-items:center; gap:3px; margin-right:2px; font-size:11px; color:var(--dim); cursor:default; }
        .gs-dot { width:8px; height:8px; border-radius:50%; display:inline-block; }
        .gs-dot.off { background:#888; }
        .gs-dot.ok { background:#22c55e; }
        .gs-dot.pending { background:#eab308; animation:gspulse 1s infinite; }
        .gs-dot.error { background:#ef4444; }
        @keyframes gspulse { 0%,100%{opacity:1} 50%{opacity:.4} }

        /* Google Sheets settings modal */
        #gsModal {
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:var(--overlay-bg); z-index:600; display:none;
            align-items:center; justify-content:center;
        }
        #gsModal.show { display:flex; }
        .gs-box {
            background:var(--panel); border:1px solid var(--border); border-radius:12px;
            padding:24px 28px; width:520px; max-width:92vw; max-height:85vh; overflow-y:auto;
            box-shadow:var(--card-shadow);
        }
        .gs-box h2 { margin:0 0 16px; font-size:17px; color:var(--text); }
        .gs-box label { display:block; font-size:12px; color:var(--dim); margin-bottom:4px; }
        .gs-box input[type=text] {
            width:100%; padding:8px 10px; background:var(--hover-bg); border:1px solid var(--border);
            color:var(--text); border-radius:6px; font-size:13px; font-family:inherit; box-sizing:border-box;
        }
        .gs-box input[type=text]:focus { border-color:var(--accent); outline:none; }
        .gs-row { display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
        .gs-row .btn { font-size:12px; padding:6px 14px; }
        .gs-msg { margin-top:10px; font-size:12px; padding:6px 10px; border-radius:6px; display:none; }
        .gs-msg.ok { display:block; background:var(--save-bg); color:var(--green); border:1px solid var(--save-border); }
        .gs-msg.err { display:block; background:var(--del-bg); color:var(--del-text); border:1px solid var(--del-border); }
        .gs-msg.info { display:block; background:var(--active-bg); color:var(--accent); border:1px solid var(--accent); }
        .gs-section { margin-top:16px; padding-top:12px; border-top:1px solid var(--border); }
        .gs-section h3 { margin:0 0 8px; font-size:14px; color:var(--text); }
        .gs-check { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text); margin-top:8px; }
        .gs-check input { accent-color:var(--accent); }
        .gs-interval { width:50px; text-align:center; padding:4px 6px !important; display:inline-block; width:50px !important; }
        .gs-code-box {
            display:none; margin-top:12px; background:var(--hover-bg); border:1px solid var(--border);
            border-radius:8px; padding:12px; max-height:300px; overflow-y:auto;
        }
        .gs-code-box.show { display:block; }
        .gs-code-box pre { margin:0; font-size:11px; color:var(--text); white-space:pre-wrap; word-break:break-all; font-family:'Fira Code',monospace; }
        .gs-copy-btn { font-size:11px; padding:4px 10px; margin-top:6px; }

        /* Auth screen */
        #authScreen { position:fixed; top:0; left:0; right:0; bottom:0; background:var(--upload-bg); display:flex; align-items:center; justify-content:center; z-index:700; }
        #authScreen.gone { display:none; }
        .auth-card { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:40px 48px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,.12); min-width:320px; max-width:400px; }
        .auth-card h2 { margin:0 0 6px 0; font-size:22px; color:var(--text); }
        .auth-card .auth-sub { color:var(--dim); font-size:13px; margin-bottom:24px; }
        .auth-input { width:100%; box-sizing:border-box; padding:12px 14px; border:1px solid var(--border); border-radius:8px; font-size:15px; margin-bottom:12px; background:var(--panel); color:var(--text); outline:none; transition:border-color .2s; }
        .auth-input:focus { border-color:var(--accent); }
        .auth-btn { width:100%; padding:12px; border:none; border-radius:8px; background:var(--accent); color:#fff; font-size:15px; font-weight:600; cursor:pointer; margin-top:6px; transition:opacity .2s; }
        .auth-btn:hover { opacity:.85; }
        .auth-btn:disabled { opacity:.5; cursor:not-allowed; }
        .auth-err { color:#e74c3c; font-size:13px; margin-top:10px; min-height:18px; }
        .auth-user-bar { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--dim); }
        /* Admin users modal */
        #adminModal {
            position:fixed; top:0; left:0; right:0; bottom:0;
            background:var(--overlay-bg); z-index:650; display:none;
            align-items:center; justify-content:center;
        }
        #adminModal.show { display:flex; }
        .admin-box {
            background:var(--panel); border:1px solid var(--border); border-radius:12px;
            padding:24px 28px; width:560px; max-width:92vw; max-height:85vh; overflow-y:auto;
            box-shadow:var(--card-shadow);
        }
        .admin-box h2 { margin:0 0 16px; font-size:17px; color:var(--text); }
        .admin-table { width:100%; border-collapse:collapse; font-size:12px; margin-bottom:16px; }
        .admin-table th { text-align:left; padding:6px 8px; border-bottom:2px solid var(--border); color:var(--dim); font-weight:600; }
        .admin-table td { padding:6px 8px; border-bottom:1px solid var(--border); color:var(--text); }
        .admin-table tr:hover td { background:var(--hover-bg); }
        .admin-del-btn { background:none; color:var(--del-text); border:1px solid var(--border); border-radius:4px; padding:2px 8px; cursor:pointer; font-size:11px; }
        .admin-del-btn:hover { opacity:.7; }
        .admin-add-section { border-top:1px solid var(--border); padding-top:14px; margin-top:8px; }
        .admin-add-section h3 { font-size:14px; margin:0 0 10px; color:var(--text); }
        .admin-add-row { display:flex; gap:6px; flex-wrap:wrap; align-items:flex-end; margin-bottom:8px; }
        .admin-add-row label { font-size:11px; color:var(--dim); display:block; margin-bottom:2px; }
        .admin-add-row input, .admin-add-row select {
            padding:6px 8px; background:var(--hover-bg); border:1px solid var(--border);
            color:var(--text); border-radius:5px; font-size:12px;
        }
        .admin-add-row input:focus, .admin-add-row select:focus { border-color:var(--accent); outline:none; }
        .admin-msg { margin-top:8px; font-size:12px; min-height:16px; }
        .admin-msg.ok { color:#22c55e; }
        .admin-msg.err { color:var(--del-text); }
    </style>
</head>
<body>
<div id="authScreen">
    <div class="auth-card">
        <h2>üîê VibeMarketing</h2>
        <div class="auth-sub">–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞</div>
        <input type="text" class="auth-input" id="authLogin" placeholder="–õ–æ–≥–∏–Ω" autocomplete="username">
        <input type="password" class="auth-input" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password">
        <button class="auth-btn" id="authBtn" onclick="doAuth()">–í–æ–π—Ç–∏</button>
        <div class="auth-err" id="authErr"></div>
        <details id="authFirstSetup" style="margin-top:20px;text-align:left;font-size:12px;color:var(--dim);display:none">
            <summary style="cursor:pointer;font-weight:600">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</summary>
            <div style="margin-top:8px;line-height:1.6">
                <p>–û—Ç–∫—Ä–æ–π—Ç–µ Google –¢–∞–±–ª–∏—Ü—É ‚Üí –ª–∏—Å—Ç <code>users</code></p>
                <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å—Ç—Ä–æ–∫—É: <code>login</code>, <code>passHash</code>, <code>name</code>, <code>role</code></p>
                <div style="margin:8px 0">
                    <b>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä passHash:</b>
                    <div style="display:flex;gap:4px;margin-top:4px">
                        <input type="text" id="authHashInput" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1;padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--panel);color:var(--text)">
                        <button onclick="sha256(document.getElementById('authHashInput').value).then(h=>{document.getElementById('authHashResult').textContent=h;navigator.clipboard.writeText(h)})" style="padding:6px 10px;font-size:11px;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--text);cursor:pointer">SHA-256</button>
                    </div>
                    <div id="authHashResult" style="font-size:10px;color:var(--accent);margin-top:4px;word-break:break-all"></div>
                </div>
                <p>–í—Å—Ç–∞–≤—å—Ç–µ —Ö–µ—à –≤ –∫–æ–ª–æ–Ω–∫—É <code>passHash</code>. –†–æ–ª—å: <code>admin</code> –∏–ª–∏ <code>user</code></p>
            </div>
        </details>
    </div>
</div>
<div id="topbar">
    <h1>VibeMarketing</h1>
    <div class="sep"></div>
    <button class="btn tb-always" id="bLoad">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    <button class="btn tb-always" id="bDemo">–î–µ–º–æ</button>
    <div class="sep"></div>
    <div class="tb-tabs">
        <button class="tb-tab" id="bTo3D" title="3D –≤–∏–¥ (T)">3D</button>
        <button class="tb-tab active" id="bTo2D" title="2D –≤–∏–¥ (T)">2D</button>
        <button class="tb-tab" id="bToTimeline" title="–¢–∞–π–º–ª–∞–π–Ω (Y)">–¢–∞–π–º–ª–∞–π–Ω</button>
        <button class="tb-tab" id="bToEvents" title="–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è">–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</button>
        <button class="tb-tab" id="bToCompanies" title="–ö–æ–º–ø–∞–Ω–∏–∏">–ö–æ–º–ø–∞–Ω–∏–∏</button>
    </div>
    <div class="sep tb-3d"></div>
    <button class="btn tb-3d" id="bReset">–°–±—Ä–æ—Å –∫–∞–º–µ—Ä—ã</button>
    <button class="btn-icon active tb-3d" id="bLabels" title="–ü–æ–¥–ø–∏—Å–∏ (L)"><svg viewBox="0 0 24 24"><path d="M5 4v3h5.5v12h3V7H19V4z"/></svg></button>
    <button class="btn-icon tb-3d" id="bGrid" title="–°–µ—Ç–∫–∞ –≤—Å–µ (G)"><svg viewBox="0 0 24 24"><path d="M3 3v18h18V3H3zm8 16H5v-6h6v6zm0-8H5V5h6v6zm8 8h-6v-6h6v6zm0-8h-6V5h6v6z"/></svg></button>
    <button class="btn-icon tb-3d" id="bGridXY" title="–°–µ—Ç–∫–∞ XY (–∫–æ–º–ø–∞–Ω–∏–∏√ó–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)"><svg viewBox="0 0 24 24"><path d="M3 3h18v18H3V3zm2 2v14h14V5H5z"/><path d="M5 9h14M5 13h14M5 17h14M9 5v14M13 5v14M17 5v14" stroke="currentColor" stroke-width="1" fill="none"/></svg></button>
    <button class="btn-icon tb-3d" id="bGridXZ" title="–°–µ—Ç–∫–∞ XZ (–º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è√ó–Ω–µ–¥–µ–ª–∏)"><svg viewBox="0 0 24 24"><path d="M3 21L12 3l9 18H3z" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M6 15h12M9 9h6" stroke="currentColor" stroke-width="1" fill="none"/></svg></button>
    <button class="btn-icon tb-3d" id="bGridYZ" title="–°–µ—Ç–∫–∞ YZ (–∫–æ–º–ø–∞–Ω–∏–∏√ó–Ω–µ–¥–µ–ª–∏)"><svg viewBox="0 0 24 24"><path d="M4 4l8 4v12l-8-4V4z" fill="none" stroke="currentColor" stroke-width="1.5"/><path d="M12 8l8-4v12l-8 4V8z" fill="none" stroke="currentColor" stroke-width="1.5"/></svg></button>
    <button class="btn-icon active tb-3d" id="bBlink" title="–ú–∏–≥–∞–Ω–∏–µ –ø–æ—Å–ª. –Ω–µ–¥–µ–ª–∏ (B)"><svg viewBox="0 0 24 24"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg></button>
    <button class="btn-icon tb-3d" id="bAddMode" title="–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (N)"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
    <div class="sep tb-viz"></div>
    <button class="btn-icon active tb-viz" id="bKeys" title="–ü–æ–¥—Å–∫–∞–∑–∫–∏ (H)"><svg viewBox="0 0 24 24"><path d="M20 5H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm-9 3h2v2h-2V8zm0 3h2v2h-2v-2zM8 8h2v2H8V8zm0 3h2v2H8v-2zm-1 2H5v-2h2v2zm0-3H5V8h2v2zm9 7H8v-2h8v2zm0-4h-2v-2h2v2zm0-3h-2V8h2v2zm3 3h-2v-2h2v2zm0-3h-2V8h2v2z"/></svg></button>
    <button class="btn-icon active tb-viz" id="bPanel" title="–ü–∞–Ω–µ–ª—å (P)"><svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></button>
    <div class="sep tb-always"></div>
    <div class="tb-group tb-always">
        <button class="btn" id="bAddEvent" title="–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ">+–ú</button>
        <button class="btn" id="bAddCompany" title="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é">+–ö</button>
        <button class="btn tb-viz" id="bAddWeek" title="–î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–µ–ª—é">+–ù</button>
    </div>
    <button class="btn btn-save tb-always" id="bSave" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å (Ctrl+S)">üíæ</button>
    <div class="tb-group stats tb-always" style="margin-left:auto">
        <span>–ö: <b id="sC">0</b></span>
        <span>–ú: <b id="sE">0</b></span>
        <span>–ù: <b id="sW">0</b></span>
        <span>–¢: <b id="sA">0</b></span>
    </div>
    <span class="gs-status tb-always" id="gsStatus" title="Google Sheets: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ" style="display:none"><span class="gs-dot off" id="gsDot"></span></span>
    <span class="auth-user-bar tb-always" id="authBar" style="display:none">
        <div class="tb-dropdown" id="adminMenu" style="display:none">
            <button class="tb-dropdown-toggle tb-settings" id="adminMenuBtn" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">&#9881;&#65039;</button>
            <div class="tb-dropdown-menu" id="adminMenuList">
                <button id="ddGS">&#9729;&#65039; Google Sheets</button>
                <button id="ddUsers">&#128101; –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                <button id="ddApiKeys">&#128273; API-–∫–ª—é—á–∏</button>
                <div class="tb-dropdown-sep"></div>
                <button id="ddTheme"><span id="ddThemeIcon">&#127769;</span> <span id="ddThemeLabel">–¢—ë–º–Ω–∞—è —Ç–µ–º–∞</span></button>
            </div>
        </div>
        <div class="tb-dropdown" id="userMenu">
            <button class="tb-avatar" id="userMenuBtn" title="–ü—Ä–æ—Ñ–∏–ª—å"></button>
            <div class="tb-dropdown-menu" id="userMenuList">
                <button id="ddUserName" style="font-weight:600;cursor:default;pointer-events:none"></button>
                <div class="tb-dropdown-sep"></div>
                <button id="ddLogout" style="color:var(--red, #ef4444)">&#128682; –í—ã–π—Ç–∏</button>
            </div>
        </div>
    </span>
</div>

<div id="upload">
    <div class="ucard" id="ucard">
        <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <p>Excel —Ñ–∞–π–ª (.xlsx) –∏–ª–∏ –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</p>
        <button class="btn btn-p" id="bFile">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
        <input type="file" id="finp" accept=".xlsx,.xls,.csv">
        <div class="or">–∏–ª–∏</div>
        <button class="btn" id="bDemoU">–î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ</button>
    </div>
</div>
<script>
// Theme: apply saved preference immediately (prevent flash)
if (localStorage.getItem('vibeMarketing_theme') === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
// Immediately hide upload screen if saved data exists (prevent flash)
if (localStorage.getItem('marketingPipelineData')) document.getElementById('upload').classList.add('gone');
// Auth: hide login screen immediately if session exists (prevent flash)
(function(){
    var s = sessionStorage.getItem('vibeAuth');
    if (s) {
        document.getElementById('authScreen').classList.add('gone');
        try {
            var u = JSON.parse(s);
            if (u.role === 'admin') {
                document.getElementById('adminMenu').style.display = '';
                document.getElementById('gsStatus').style.display = '';
            }
            var bar = document.getElementById('authBar');
            if (bar) bar.style.display = '';
            var uname = u.name || '';
            var parts = uname.split(/\s+/);
            var initials = parts.map(function(p){ return p.charAt(0).toUpperCase(); }).join('').substring(0,2);
            var avatar = document.getElementById('userMenuBtn');
            if (avatar) avatar.textContent = initials || '?';
            var ddName = document.getElementById('ddUserName');
            if (ddName) ddName.textContent = uname;
        } catch(e){}
    }
})();
</script>

<!-- Google Sheets settings modal -->
<div id="gsModal">
    <div class="gs-box">
        <h2>‚òÅÔ∏è –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è Google Sheets</h2>
        <label for="gsUrlInput">URL –≤–∞—à–µ–≥–æ Apps Script (Web App):</label>
        <input type="text" id="gsUrlInput" placeholder="https://script.google.com/macros/s/...../exec">
        <div class="gs-row">
            <button class="btn" id="gsTestBtn">üîó –ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button class="btn" id="gsLoadBtn">‚¨áÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="btn" id="gsSaveBtn">‚¨ÜÔ∏è –í—ã–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="btn" id="gsDisconnect" style="margin-left:auto; color:var(--del-text)">–û—Ç–∫–ª—é—á–∏—Ç—å</button>
        </div>
        <div class="gs-msg" id="gsMsg"></div>
        <div class="gs-section">
            <label class="gs-check"><input type="checkbox" id="gsAutoCheck" checked> –ê–≤—Ç–æ-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–∞–∂–¥—ã–µ
                <input type="text" class="gs-interval" id="gsIntervalInput" value="30"> —Å–µ–∫
            </label>
        </div>
        <div class="gs-section">
            <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ</h3>
            <ol style="font-size:12px;color:var(--text);padding-left:18px;line-height:1.7">
                <li>–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é <b>Google –¢–∞–±–ª–∏—Ü—É</b></li>
                <li>–î–æ–±–∞–≤—å—Ç–µ 4 –ª–∏—Å—Ç–∞: <code>companies</code>, <code>activities</code>, <code>meta</code>, <code>users</code></li>
                <li>–í –ª–∏—Å—Ç–µ <code>users</code> –¥–æ–±–∞–≤—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏: <code>login</code>, <code>passHash</code>, <code>name</code>, <code>role</code></li>
                <li>–î–æ–±–∞–≤—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (passHash = SHA-256 –ø–∞—Ä–æ–ª—è, —Å–º. –∫–æ–Ω—Å–æ–ª—å)</li>
                <li>–û—Ç–∫—Ä–æ–π—Ç–µ <b>–†–∞—Å—à–∏—Ä–µ–Ω–∏—è ‚Üí Apps Script</b></li>
                <li>–£–¥–∞–ª–∏—Ç–µ –≤—Å—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –Ω–∏–∂–µ ‚Üì</li>
                <li>–ù–∞–∂–º–∏—Ç–µ <b>–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ ‚Üí –ù–æ–≤–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ</b></li>
                <li>–¢–∏–ø: <b>–í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</b>, –î–æ—Å—Ç—É–ø: <b>–í—Å–µ</b></li>
                <li>–°–∫–æ–ø–∏—Ä—É–π—Ç–µ URL –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤—ã—à–µ</li>
            </ol>
            <div class="gs-section" style="margin-top:8px">
                <b>üîë –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä passHash:</b>
                <div style="display:flex;gap:6px;margin-top:4px">
                    <input type="text" id="gsPassInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="flex:1;padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:12px;background:var(--panel);color:var(--text)">
                    <button class="btn" id="gsHashBtn" style="font-size:12px;padding:6px 12px">SHA-256</button>
                </div>
                <div id="gsHashResult" style="font-size:11px;color:var(--dim);margin-top:4px;word-break:break-all"></div>
            </div>
            <button class="btn" id="gsShowCode">üìÑ –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–¥ Apps Script</button>
            <div class="gs-code-box" id="gsCodeBox">
                <div style="display:flex;gap:8px;margin-bottom:8px;position:sticky;top:0;z-index:1;background:var(--hover-bg);padding:4px 0">
                    <button class="btn gs-copy-btn" id="gsCopyCode">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥</button>
                    <button class="btn gs-copy-btn" id="gsCodeClose">OK</button>
                </div>
                <pre id="gsCodePre"></pre>
            </div>
        </div>
        <div class="gs-row" style="justify-content:flex-end; margin-top:16px;">
            <button class="btn" id="gsClose">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<!-- Admin users modal -->
<div id="adminModal">
    <div class="admin-box">
        <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
        <table class="admin-table">
            <thead><tr><th>–õ–æ–≥–∏–Ω</th><th>–ò–º—è</th><th>–†–æ–ª—å</th><th></th></tr></thead>
            <tbody id="adminUsersTbody"></tbody>
        </table>
        <div class="admin-add-section">
            <h3>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <div class="admin-add-row">
                <div><label>–õ–æ–≥–∏–Ω</label><input type="text" id="adminNewLogin" placeholder="login" style="width:120px"></div>
                <div><label>–ü–∞—Ä–æ–ª—å</label><input type="text" id="adminNewPass" placeholder="–ø–∞—Ä–æ–ª—å" style="width:120px"></div>
                <div><label>–ò–º—è</label><input type="text" id="adminNewName" placeholder="–ò–º—è" style="width:120px"></div>
                <div><label>–†–æ–ª—å</label><select id="adminNewRole" style="width:90px"><option value="user">user</option><option value="admin">admin</option></select></div>
                <div><label>&nbsp;</label><button class="btn" id="adminAddBtn" style="font-size:12px;padding:6px 14px">–î–æ–±–∞–≤–∏—Ç—å</button></div>
            </div>
        </div>
        <div class="admin-msg" id="adminMsg"></div>
        <div style="display:flex;justify-content:flex-end;margin-top:14px;">
            <button class="btn" id="adminCloseBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

<div id="panel">
    <button class="panel-close" id="clsPanel" title="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å (P)">&times;</button>
    <h3>–≠—Ç–∞–ø—ã –≤–æ—Ä–æ–Ω–∫–∏</h3>
    <div class="flt-btns"><button id="fltSAll">–í—Å–µ</button><button id="fltSNone">–°–Ω—è—Ç—å</button></div>
    <div id="fltS" class="flt"></div>
    <h3>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h3>
    <div class="flt-btns"><button id="fltEAll">–í—Å–µ</button><button id="fltENone">–°–Ω—è—Ç—å</button></div>
    <div id="fltE" class="flt"></div>
    <h3>–†–µ–≥–∏–æ–Ω—ã</h3>
    <div class="flt-btns"><button id="fltRAll">–í—Å–µ</button><button id="fltRNone">–°–Ω—è—Ç—å</button></div>
    <div id="fltR" class="flt"></div>
</div>

<div id="detail">
    <button class="cls" id="clsDet">&times;</button>
    <div id="detC"></div>
</div>

<div id="tip"></div>

<div id="editPanel">
    <button class="cls" id="clsEdit">&times;</button>
    <h2 id="editTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
    <div class="edit-info" id="editInfo"></div>
    <label>–≠—Ç–∞–ø –≤–æ—Ä–æ–Ω–∫–∏</label>
    <select id="editStage"></select>
    <label>–î–∞—Ç–∞</label>
    <input type="date" id="editDate">
    <div class="edit-actions">
        <button class="edit-save" id="editSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button class="edit-del" id="editDel">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="edit-cancel" id="editCancel">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="ctxMenu">
    <div class="ctx-item" id="ctxEdit">&#9998; –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
    <div class="ctx-item" id="ctxAdd">&#10010; –î–æ–±–∞–≤–∏—Ç—å —Ä—è–¥–æ–º</div>
    <div class="ctx-sep"></div>
    <div class="ctx-item ctx-del" id="ctxDel">&#10006; –£–¥–∞–ª–∏—Ç—å</div>
</div>

<div class="mode-indicator" id="modeInd">–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (Shift+Click)</div>

<div id="keys">
    <b>–¢–∞—á–ø—ç–¥:</b>
    <kbd>–õ–ö–ú</kbd>+—Ç—è–Ω—É—Ç—å ‚Äî –≤—Ä–∞—â–µ–Ω–∏–µ &nbsp;
    <kbd>2 –ø–∞–ª—å—Ü–∞</kbd> —Å–≤–∞–π–ø ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ ‚Üï‚Üî &nbsp;
    <kbd>–©–∏–ø–æ–∫</kbd> ‚Äî –º–∞—Å—à—Ç–∞–± &nbsp;
    <kbd>–ö–ª–∏–∫</kbd> ‚Äî –¥–µ—Ç–∞–ª–∏
    <br>
    <b>–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞:</b>
    <kbd>‚Üê‚Üí‚Üë‚Üì</kbd> –≤—Ä–∞—â–µ–Ω–∏–µ &nbsp;
    <kbd>W</kbd><kbd>A</kbd><kbd>S</kbd><kbd>D</kbd> –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ ‚Üï‚Üî &nbsp;
    <kbd>Q</kbd> –≤–≤–µ—Ä—Ö <kbd>E</kbd> –≤–Ω–∏–∑ &nbsp;
    <kbd>Z</kbd><kbd>X</kbd> / <kbd>+</kbd><kbd>‚àí</kbd> –º–∞—Å—à—Ç–∞–± &nbsp;
    <kbd>1</kbd>-<kbd>6</kbd> –≤–∏–¥—ã &nbsp;
    <kbd>R</kbd> —Å–±—Ä–æ—Å &nbsp;
    <kbd>L</kbd> –ø–æ–¥–ø–∏—Å–∏ &nbsp;
    <kbd>G</kbd> —Å–µ—Ç–∫–∞ &nbsp;
    <kbd>B</kbd> –º–∏–≥–∞–Ω–∏–µ &nbsp;
    <kbd>N</kbd> –¥–æ–±–∞–≤–∏—Ç—å &nbsp;
    <kbd>T</kbd> 2D/3D &nbsp;
    <kbd>Y</kbd> —Ç–∞–π–º–ª–∞–π–Ω &nbsp;
    <kbd>Del</kbd> —É–¥–∞–ª–∏—Ç—å &nbsp;
    <kbd>Ctrl+S</kbd> —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å &nbsp;
    <kbd>H</kbd> –ª–µ–≥–µ–Ω–¥–∞ &nbsp;
    <kbd>P</kbd> –ø–∞–Ω–µ–ª—å &nbsp;
    <kbd>F</kbd> –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω &nbsp;
    <kbd>Esc</kbd> –∑–∞–∫—Ä—ã—Ç—å
</div>

<div id="ghostTip"></div>

<div id="confirmOverlay">
    <div id="confirmBox">
        <div class="cf-title" id="cfTitle">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
        <div class="cf-msg" id="cfMsg"></div>
        <div class="cf-actions">
            <button class="cf-btn cf-cancel" id="cfCancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="cf-btn cf-ok" id="cfOk">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<div id="formModal">
    <div class="fm-box" id="fmBox"></div>
</div>


<div id="view2d"></div>
<div id="viewTimeline"></div>
<div id="viewEvents"></div>
<div id="viewCompanies"></div>
<div id="canvas-wrap"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ============================
// THEME HELPERS
// ============================
function getCSSVar(name) { return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function isDarkTheme() { return document.documentElement.getAttribute('data-theme') === 'dark'; }

// ============================
// CONFIG & DATA
// ============================
const STAGES = [
    { id:'first_contact',  name:'–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç',        order:1 },
    { id:'second_contact', name:'–í—Ç–æ—Ä–æ–π –∫–æ–Ω—Ç–∞–∫—Ç',        order:2 },
    { id:'third_contact',  name:'–¢—Ä–µ—Ç–∏–π –∫–æ–Ω—Ç–∞–∫—Ç',        order:3 },
    { id:'presentation',   name:'–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è',           order:4 },
    { id:'discussion',     name:'–û–±—Å—É–∂–¥–µ–Ω–∏–µ',            order:5 },
    { id:'demo',           name:'–î–µ–º–æ –ø—Ä–æ–¥—É–∫—Ç–∞',         order:6 },
    { id:'mockup',         name:'–ú–∞–∫–µ—Ç',                 order:7 },
    { id:'trial',          name:'–¢–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–∏–æ–¥',       order:8 },
    { id:'negotiation',    name:'–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ',          order:9 },
    { id:'pre_contract',   name:'–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞',  order:10 },
    { id:'contract',       name:'–ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ–¥–ø–∏—Å–∞–Ω',     order:11 },
];
const SCOLORS = [
    '#6b7280','#8b95a5','#4f8cff','#7c5cfc','#a855f7',
    '#ec4899','#f97316','#fbbf24','#84cc16','#22d3ee','#34d399',
];
// Events with timing metadata:
//   weekStart: earliest week the event can start (0-based)
//   duration:  how many weeks the event spans (for timeline view)
const EVENTS_META = [
    { name:'Email-—Ä–∞—Å—Å—ã–ª–∫–∞',   weekStart:0, duration:1,  color:'#6366f1' },
    { name:'–í—ã—Å—Ç–∞–≤–∫–∞',         weekStart:2, duration:1,  color:'#f43f5e' },
    { name:'–ü–æ–¥–∫–∞—Å—Ç',          weekStart:1, duration:3,  color:'#8b5cf6' },
    { name:'–ö–æ—Ä–ø. –∑–∞–≤—Ç—Ä–∞–∫',    weekStart:3, duration:1,  color:'#f97316' },
    { name:'–í–µ–±–∏–Ω–∞—Ä',          weekStart:1, duration:1,  color:'#0ea5e9' },
    { name:'–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–∞–π—Ç',    weekStart:0, duration:99, color:'#10b981' }, // –¥–ª–∏—Ç—Å—è –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥
    { name:'–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è',      weekStart:4, duration:1,  color:'#e11d48' },
    { name:'–•–æ–ª–æ–¥–Ω—ã–π –∑–≤–æ–Ω–æ–∫',  weekStart:0, duration:1,  color:'#64748b' },
    { name:'–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è',     weekStart:2, duration:1,  color:'#a855f7' },
    { name:'–°–æ—Ü—Å–µ—Ç–∏',          weekStart:0, duration:99, color:'#06b6d4' }, // –¥–ª—è—Ç—Å—è –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥
];
let EVENTS = EVENTS_META.map(e => e.name);
let EVENT_COLORS = {};
EVENTS_META.forEach(e => EVENT_COLORS[e.name] = e.color);

function rebuildEventsDerived() {
    EVENTS = EVENTS_META.map(e => e.name);
    EVENT_COLORS = {};
    EVENTS_META.forEach(e => EVENT_COLORS[e.name] = e.color);
}

// Company logo URLs ‚Äî use Google favicons (reliable, no CORS issues)
const LOGO_DOMAINS = {
    '–ü–ò–ö': 'pik.ru',
    '–õ–°–† –ì—Ä—É–ø–ø': 'lsr.ru',
    '–°–∞–º–æ–ª—ë—Ç': 'samolet.ru',
    '–≠—Ç–∞–ª–æ–Ω': 'etalongroup.ru',
    '–ë—Ä—É—Å–Ω–∏–∫–∞': 'brusnika.ru',
    '–ê101': 'a101.ru',
    '–î–æ–Ω—Å—Ç—Ä–æ–π': 'donstroy.moscow',
    'Setl Group': 'setlgroup.ru',
    '–Æ–≥–°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç': 'gk-usi.ru',
    '–£–Ω–∏—Å—Ç—Ä–æ–π': 'unistroyrf.ru',
    '–¢–∞–ª–∞–Ω': 'talan.ru',
    '–ñ–µ–ª–µ–∑–Ω–æ': 'zhcom.ru',
    'DOGMA': 'dogma.ru',
    '–°—Ç—Ä–∞–Ω–∞ –î–µ–≤.': 'strana.com',
    '–°–ü–± –†–µ–Ω–æ–≤–∞—Ü–∏—è': 'spbren.ru',
    '–ì–ö –ú–æ–Ω–æ–ª–∏—Ç': 'gk-monolit.ru',
    '–ê–°–ö': 'ask-yug.com',
    '–ê—Ç–æ–º—Å—Ç—Ä–æ–π–∫–æ–º–ø–ª–µ–∫—Å': 'atomstroy.net',
    '–Æ–ò–¢ –†–æ—Å—Å–∏—è': 'yit.ru',
    'KR Properties': 'kr-pro.ru',
    '–ì–ö –°–∞–¥–æ–≤–æ–µ –ö–æ–ª—å—Ü–æ': 'sadovoe-kolco.ru',
    '–°–∏–±–ø—Ä–æ–º—Å—Ç—Ä–æ–π': 'sibpromstroy.ru',
    '–ì–ö –ü–µ—Ä–≤—ã–π –¢—Ä–µ—Å—Ç': '1trest.ru',
    '–î–µ–≤–µ–ª–æ–ø–º–µ–Ω—Ç-–Æ–≥': 'develug.ru',
    '–ò–ù–ö–û': 'gkinko.ru',
};
// Build logo URLs using Google Favicons API (no CORS, reliable)
const LOGO_URLS = {};
Object.entries(LOGO_DOMAINS).forEach(([name, domain]) => {
    LOGO_URLS[name] = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
});

function genDemo() {
    const companies = [
        {name:'–ü–ò–ö',region:'–ú–æ—Å–∫–≤–∞',contact:'–ö–∞—Ä–∞–ø–µ—Ç—è–Ω –ï.–ì.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–õ–°–† –ì—Ä—É–ø–ø',region:'–°–ü–±',contact:'–ö—É—Ç—É–∑–æ–≤ –î.–í.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–°–∞–º–æ–ª—ë—Ç',region:'–ú–æ—Å–∫–≤–∞',contact:'–ê–∫–∏–Ω—å—à–∏–Ω–∞ –ê.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–≠—Ç–∞–ª–æ–Ω',region:'–°–ü–±',contact:'–ë—É–∑—É–ª—É—Ü–∫–∏–π –ú.',pos:'–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç'},
        {name:'–ë—Ä—É—Å–Ω–∏–∫–∞',region:'–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',contact:'–©–∏–≥–æ–ª—å –ê.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–ê101',region:'–ú–æ—Å–∫–≤–∞',contact:'–î–∞–Ω–∏–ª–∏–¥–∏ –ò.–°.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–î–æ–Ω—Å—Ç—Ä–æ–π',region:'–ú–æ—Å–∫–≤–∞',contact:'–ë–∞–≥–∞–µ–≤ –ê.–í.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'Setl Group',region:'–°–ü–±',contact:'–ò–∑–∞–∫ –Ø.–õ.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–Æ–≥–°—Ç—Ä–æ–π–ò–Ω–≤–µ—Å—Ç',region:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',contact:'–ò–≤–∞–Ω–æ–≤ –Æ.–ò.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–£–Ω–∏—Å—Ç—Ä–æ–π',region:'–ö–∞–∑–∞–Ω—å',contact:'–°–∞–ª–∏–º–≥–∞—Ä–∞–µ–≤ –†.–í.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–¢–∞–ª–∞–Ω',region:'–ò–∂–µ–≤—Å–∫',contact:'–ú–∞–∫–∞—Ä–æ–≤ –ö.–ú.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–ñ–µ–ª–µ–∑–Ω–æ',region:'–ö–∏—Ä–æ–≤',contact:'–ó–∞—Ö–∞—Ä–æ–≤ –Æ.–ê.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'DOGMA',region:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',contact:'–ú–æ—Ä–æ–∑–æ–≤ –î.',pos:'–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç'},
        {name:'–°—Ç—Ä–∞–Ω–∞ –î–µ–≤.',region:'–¢—é–º–µ–Ω—å',contact:'–ì–∞–π–¥—É–∫–æ–≤ –ê.–û.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–°–ü–± –†–µ–Ω–æ–≤–∞—Ü–∏—è',region:'–°–ü–±',contact:'–õ–µ–≤–∏–Ω –ü.–ò.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–ì–ö –ú–æ–Ω–æ–ª–∏—Ç',region:'–í–æ—Ä–æ–Ω–µ–∂',contact:'–ë–µ–∑—Ä—É–∫–æ–≤ –ï.–ê.',pos:'–î–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–ê–°–ö',region:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',contact:'–ú–∏—Ä–æ—à–Ω–∏—á–µ–Ω–∫–æ –ê.–í.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–ê—Ç–æ–º—Å—Ç—Ä–æ–π–∫–æ–º–ø–ª–µ–∫—Å',region:'–ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',contact:'–ê–Ω–∞–Ω—å–µ–≤ –í.–ú.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–Æ–ò–¢ –†–æ—Å—Å–∏—è',region:'–ú–æ—Å–∫–≤–∞',contact:'–ë–µ–ª–æ–º–µ—Å—Ç–Ω–æ–≤ –Æ.–ü.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'KR Properties',region:'–ú–æ—Å–∫–≤–∞',contact:'–ú–∞—Ç—é—Ö–∏–Ω –°.–í.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–ì–ö –°–∞–¥–æ–≤–æ–µ –ö–æ–ª—å—Ü–æ',region:'–ú–æ—Å–∫–≤–∞',contact:'–ö–æ–ª—É–Ω–æ–≤ –ò.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–°–∏–±–ø—Ä–æ–º—Å—Ç—Ä–æ–π',region:'–°—É—Ä–≥—É—Ç',contact:'–§–æ–º–∞–≥–∏–Ω –í.–ë.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–ì–ö –ü–µ—Ä–≤—ã–π –¢—Ä–µ—Å—Ç',region:'–£—Ñ–∞',contact:'–ó–∞–π–Ω—É—Ç–¥–∏–Ω–æ–≤ –õ.–§.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
        {name:'–î–µ–≤–µ–ª–æ–ø–º–µ–Ω—Ç-–Æ–≥',region:'–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä',contact:'–ò–≤–∞–Ω–æ–≤ –°.–ü.',pos:'–ü—Ä–µ–∑–∏–¥–µ–Ω—Ç'},
        {name:'–ò–ù–ö–û',region:'–ü–µ–Ω–∑–∞',contact:'–ß–∏–∂–æ–≤ –û.',pos:'–ì–µ–Ω. –¥–∏—Ä–µ–∫—Ç–æ—Ä'},
    ];
    const acts = [];
    const baseDate = new Date(2024, 0, 8);
    companies.forEach(c => {
        // Each company has ONE initiating event (marketing activity)
        const ei = Math.floor(Math.random() * EVENTS.length);
        const evMeta = EVENTS_META[ei];
        const ev = evMeta.name;
        // First contact happens AFTER the event starts ‚Äî spread across weeks
        // Event weekStart defines earliest possible first contact
        const startWeek = evMeta.weekStart + Math.floor(Math.random() * 3); // 0-2 weeks after event
        // Random pipeline depth: minimum 2 stages, up to 11
        const luck = Math.random();
        let ms;
        if (luck < .20) ms = 11;
        else if (luck < .45) ms = 7 + Math.floor(Math.random() * 4);
        else if (luck < .75) ms = 4 + Math.floor(Math.random() * 3);
        else ms = 2 + Math.floor(Math.random() * 2);
        let curWeek = startWeek;
        for (let s = 0; s < ms && curWeek < nWeeks; s++) {
            const sd = new Date(baseDate);
            sd.setDate(sd.getDate() + curWeek * 7);
            acts.push({
                company: c.name, region: c.region, contact: c.contact, position: c.pos,
                event: ev, stage: STAGES[s].id, stageName: STAGES[s].name,
                stageOrder: STAGES[s].order, date: sd.toISOString().slice(0, 10),
            });
            const gap = Math.random();
            if (gap < 0.10) curWeek += 3;
            else if (gap < 0.35) curWeek += 2;
            else curWeek += 1;
        }
    });
    return { companies, activities: acts };
}

function parseExcel(file) {
    return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = e => {
            try {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const cs = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                const as = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]] || wb.Sheets[wb.SheetNames[0]]);
                const companies = cs.map(r => ({
                    name: r['–ö–æ–º–ø–∞–Ω–∏—è'] || r['company'] || '',
                    region: r['–†–µ–≥–∏–æ–Ω'] || r['region'] || '',
                    contact: r['–ö–æ–Ω—Ç–∞–∫—Ç'] || r['contact'] || '',
                    pos: r['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] || r['position'] || '',
                })).filter(c => c.name);
                const activities = as.map(r => {
                    const si = STAGES.find(s => s.id === (r['–≠—Ç–∞–ø ID'] || r['stage']) || s.name === (r['–≠—Ç–∞–ø'] || r['stageName']));
                    return {
                        company: r['–ö–æ–º–ø–∞–Ω–∏—è'] || r['company'] || '',
                        region: r['–†–µ–≥–∏–æ–Ω'] || r['region'] || '',
                        contact: r['–ö–æ–Ω—Ç–∞–∫—Ç'] || r['contact'] || '',
                        position: r['–î–æ–ª–∂–Ω–æ—Å—Ç—å'] || r['position'] || '',
                        event: r['–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ'] || r['event'] || '',
                        stage: si ? si.id : '', stageName: si ? si.name : '',
                        stageOrder: si ? si.order : 0, date: r['–î–∞—Ç–∞'] || r['date'] || '',
                    };
                }).filter(a => a.company && a.event);
                res({ companies, activities });
            } catch (err) { rej(err); }
        };
        r.onerror = rej;
        r.readAsArrayBuffer(file);
    });
}

// ============================
// 3D ENGINE
// ============================
let scene, cam, rend, ctrl;
let dGroup, connGroup, floorGroup, labelMeshes = [];
let allCubes = [], curData = null, hovered = null;
const ray = new THREE.Raycaster(), mouse = new THREE.Vector2();
let filters = { events: new Set(), regions: new Set(), stages: new Set() };
let dims = { totalX: 0, totalY: 0, totalZ: 0, cx: 0, cy: 0, cz: 0 };
let labelsVisible = true;
let keysVisible = true;
let gridVisible = false;
let gridXY = false, gridXZ = false, gridYZ = false; // individual plane toggles
let blinkEnabled = true;
let nWeeks = 12;
let maxWeekIdx = 11; // last week index (0-based)
let CELL = 4.6;
let addMode = false;
let ghostCube = null;
let selectedCube = null;
let editingData = null;
let dirty = false; // unsaved changes flag
let gsSaveTimer = null;

function markDirty() {
    dirty = true;
    // Auto-save on every change to localStorage
    if (curData) {
        localStorage.setItem(LS_KEY, JSON.stringify({ curData, nWeeks, eventsMeta: EVENTS_META }));
        dirty = false;
    }
    // If Google Sheets connected ‚Äî debounced push (2 sec)
    if (gsUrl) {
        clearTimeout(gsSaveTimer);
        gsSaveTimer = setTimeout(() => gsSave(true), 2000);
    }
}
function markClean() {
    dirty = false;
    const btn = document.getElementById('bSave');
    if (btn) { btn.style.background = ''; btn.style.borderColor = ''; btn.textContent = 'üíæ Save'; }
}

const LS_KEY = 'marketingPipelineData';

function saveToStorage() {
    if (!curData) return;
    localStorage.setItem(LS_KEY, JSON.stringify({ curData, nWeeks, eventsMeta: EVENTS_META }));
    markClean();
    // Brief visual feedback
    const btn = document.getElementById('bSave');
    if (btn) {
        const orig = btn.textContent;
        btn.textContent = '‚úì Saved';
        btn.style.background = 'var(--save-flash-bg)';
        setTimeout(() => { btn.textContent = 'üíæ Save'; btn.style.background = ''; }, 1200);
    }
}

function loadFromStorage() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return null;
    try {
        const d = JSON.parse(raw);
        if (d && d.curData && d.curData.activities) return d;
    } catch (e) {}
    return null;
}

// Preloaded logo images cache
const logoCache = {};
let logosReady = false;

// Generate a colored circle with initials as fallback logo
function generateInitialsLogo(name) {
    const c = document.createElement('canvas');
    c.width = 64; c.height = 64;
    const ctx = c.getContext('2d');
    // Hash name to color
    let hash = 0;
    for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
    const hue = Math.abs(hash) % 360;
    ctx.fillStyle = `hsl(${hue}, 55%, 45%)`;
    ctx.beginPath(); ctx.arc(32, 32, 30, 0, Math.PI * 2); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 28px Segoe UI, sans-serif';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    // Get 1-2 letter initials
    const parts = name.replace(/[^\w–ê-–Ø–∞-—è–Å—ë]/g, ' ').trim().split(/\s+/);
    const initials = parts.length > 1 ? (parts[0][0] + parts[1][0]).toUpperCase() : name.substring(0, 2).toUpperCase();
    ctx.fillText(initials, 32, 34);
    const img = new Image();
    img.src = c.toDataURL();
    return img;
}

// Custom styled confirm dialog (replaces system confirm())
function customConfirm(message, title) {
    return new Promise(resolve => {
        const overlay = document.getElementById('confirmOverlay');
        const msgEl = document.getElementById('cfMsg');
        const titleEl = document.getElementById('cfTitle');
        titleEl.textContent = title || '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ';
        // Support newlines in message
        msgEl.innerHTML = message.replace(/\n/g, '<br>');
        overlay.classList.add('show');
        const ok = document.getElementById('cfOk');
        const cancel = document.getElementById('cfCancel');
        function cleanup() {
            overlay.classList.remove('show');
            ok.onclick = null; cancel.onclick = null;
            overlay.onclick = null;
        }
        ok.onclick = () => { cleanup(); resolve(true); };
        cancel.onclick = () => { cleanup(); resolve(false); };
        overlay.onclick = (e) => { if (e.target === overlay) { cleanup(); resolve(false); } };
    });
}

// Logo loading: try fetch (works from http://), fall back to plain img (for 2D HTML), or initials (for 3D canvas)
// When opened via file:// protocol, CORS blocks fetch() and crossOrigin images.
// In that case: 3D labels use colored initials, 2D view uses <img> tags directly (no CORS needed for HTML img).
// To get real logos in 3D, run: python -m http.server 8080
const isFileProtocol = location.protocol === 'file:';

function preloadLogos() {
    let loaded = 0;
    const total = Object.keys(LOGO_URLS).length;
    return new Promise(resolve => {
        const done = () => { loaded++; if (loaded >= total) { logosReady = true; resolve(); } };

        if (isFileProtocol) {
            // file:// ‚Äî can't fetch or use crossOrigin. Use initials for 3D canvas.
            // 2D view will use <img> tags directly.
            Object.keys(LOGO_URLS).forEach(name => {
                logoCache[name] = generateInitialsLogo(name);
                done();
            });
        } else {
            // http(s):// ‚Äî fetch+blob works, real logos in 3D
            Object.entries(LOGO_URLS).forEach(([name, url]) => {
                fetch(url, { mode: 'cors' })
                    .then(r => { if (!r.ok) throw new Error(); return r.blob(); })
                    .then(blob => {
                        const objUrl = URL.createObjectURL(blob);
                        const img = new Image();
                        img.onload = () => { logoCache[name] = img; done(); };
                        img.onerror = () => { logoCache[name] = generateInitialsLogo(name); done(); };
                        img.src = objUrl;
                    })
                    .catch(() => { logoCache[name] = generateInitialsLogo(name); done(); });
            });
            setTimeout(() => {
                Object.keys(LOGO_URLS).forEach(name => {
                    if (!logoCache[name]) logoCache[name] = generateInitialsLogo(name);
                });
                logosReady = true; resolve();
            }, 5000);
        }
    });
}
preloadLogos();

function init3D() {
    const wrap = document.getElementById('canvas-wrap');
    scene = new THREE.Scene();
    scene.background = new THREE.Color(getCSSVar('--scene-bg'));

    cam = new THREE.PerspectiveCamera(55, wrap.clientWidth / wrap.clientHeight, 0.1, 2000);

    rend = new THREE.WebGLRenderer({ antialias: true });
    rend.setSize(wrap.clientWidth, wrap.clientHeight);
    rend.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    rend.domElement.setAttribute('tabindex', '0');
    rend.domElement.style.outline = 'none';
    wrap.appendChild(rend.domElement);

    ctrl = new THREE.OrbitControls(cam, rend.domElement);
    ctrl.enableDamping = true; ctrl.dampingFactor = 0.1;
    ctrl.rotateSpeed = 0.5; ctrl.panSpeed = 0.7;
    ctrl.minDistance = 15; ctrl.maxDistance = 800;
    ctrl.mouseButtons = { LEFT: THREE.MOUSE.ROTATE, MIDDLE: THREE.MOUSE.DOLLY, RIGHT: THREE.MOUSE.PAN };
    ctrl.touches = { ONE: THREE.TOUCH.ROTATE, TWO: THREE.TOUCH.DOLLY_PAN };

    ctrl.enableZoom = false;
    rend.domElement.addEventListener('wheel', e => {
        e.preventDefault();
        if (e.ctrlKey) {
            const zoomDelta = -e.deltaY * 0.01;
            const dir = ctrl.target.clone().sub(cam.position).normalize();
            cam.position.add(dir.multiplyScalar(zoomDelta * cam.position.distanceTo(ctrl.target) * 0.15));
        } else {
            const panX = -e.deltaX * 0.05;
            const panY = e.deltaY * 0.05;
            const right = new THREE.Vector3();
            cam.getWorldDirection(right);
            right.crossVectors(right, cam.up).normalize();
            const up = cam.up.clone().normalize();
            const move = right.multiplyScalar(panX).add(up.multiplyScalar(panY));
            cam.position.add(move);
            ctrl.target.add(move);
        }
    }, { passive: false });

    scene.add(new THREE.AmbientLight(0xffffff, 0.55));
    const dl = new THREE.DirectionalLight(0xffffff, 0.65);
    dl.position.set(60, 100, 40); scene.add(dl);
    scene.add(new THREE.PointLight(0x4f8cff, 0.2, 400));

    dGroup = new THREE.Group(); scene.add(dGroup);
    connGroup = new THREE.Group(); scene.add(connGroup);
    floorGroup = new THREE.Group(); scene.add(floorGroup);

    rend.domElement.addEventListener('mousemove', onMove);

    // Right-click context menu
    rend.domElement.addEventListener('contextmenu', e => {
        e.preventDefault();
        const wrap = document.getElementById('canvas-wrap');
        const rect = wrap.getBoundingClientRect();
        mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
        mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
        ray.setFromCamera(mouse, cam);
        const hits = ray.intersectObjects(allCubes, false);
        if (hits.length > 0 && hits[0].object.userData.filled) {
            showCtxMenu(e.clientX, e.clientY, hits[0].object);
        }
    });

    // Track pointer to distinguish short click from drag/rotate
    let mdX = 0, mdY = 0, mdTime = 0;
    rend.domElement.addEventListener('pointerdown', e => {
        mdX = e.clientX; mdY = e.clientY; mdTime = Date.now();
    }, true);
    rend.domElement.addEventListener('pointerup', e => {
        if (e.button === 2) return; // right click handled by contextmenu
        const dx = e.clientX - mdX, dy = e.clientY - mdY;
        const dist = Math.sqrt(dx * dx + dy * dy);
        const dt = Date.now() - mdTime;
        if (dist < 8 && dt < 400) {
            const wrap = document.getElementById('canvas-wrap');
            const rect = wrap.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / rect.height) * 2 + 1;
            ray.setFromCamera(mouse, cam);

            // In add mode or shift+click: try to place on empty cell
            if (addMode || e.shiftKey) {
                // Raycast against floor group (empty cubes) to find placement position
                const emptyHits = ray.intersectObjects(floorGroup.children, false);
                if (emptyHits.length > 0) {
                    const h = emptyHits[0].object;
                    const ud = h.userData;
                    if (ud.gridCell && curData) {
                        // Find company and event for this cell
                        const coNames = [...new Set(curData.companies.map(c => c.name))];
                        const evNames = [...new Set(curData.activities.map(a => a.event))];
                        const company = coNames[ud.ci];
                        const event = evNames[ud.ei];
                        const comp = curData.companies.find(c => c.name === company);
                        // Pre-fill new activity data
                        const baseDate = new Date(Math.min(...curData.activities.map(a => new Date(a.date)).filter(d => !isNaN(d))));
                        const newDate = new Date(baseDate);
                        newDate.setDate(newDate.getDate() + ud.wi * 7);
                        openEditPanel({
                            userData: {
                                company, event, wi: ud.wi,
                                region: comp ? comp.region : '',
                                contact: comp ? comp.contact : '',
                                position: comp ? comp.pos : '',
                                stage: STAGES[0].id,
                                date: newDate.toISOString().slice(0, 10),
                            }
                        }, true);
                        if (!e.shiftKey) setAddMode(false);
                        return;
                    }
                }
            }

            // Normal click: select cube for detail/edit
            const hits = ray.intersectObjects(allCubes, false);
            if (hits.length > 0) {
                const o = hits[0].object;
                if (o.userData.filled) {
                    // Deselect previous
                    if (selectedCube && selectedCube !== o) {
                        selectedCube.material.emissiveIntensity = 0.2;
                        selectedCube.scale.set(1, 1, 1);
                    }
                    selectedCube = o;
                    showDetail(o.userData);
                    return;
                }
            }
            document.getElementById('detail').classList.remove('open');
            closeEditPanel();
        }
    }, true);

    window.addEventListener('resize', onResize);
    anim();
}

function clearAll() {
    [dGroup, connGroup, floorGroup].forEach(g => {
        while (g.children.length) {
            const c = g.children[0];
            if (c.geometry) c.geometry.dispose();
            if (c.material) {
                if (Array.isArray(c.material)) c.material.forEach(m => m.dispose());
                else c.material.dispose();
            }
            g.remove(c);
        }
    });
    labelMeshes.forEach(s => {
        scene.remove(s);
        if (s.material && s.material.map) s.material.map.dispose();
        if (s.material) s.material.dispose();
        if (s.geometry) s.geometry.dispose();
    });
    labelMeshes = [];
    allCubes = [];
}

// Create text on a plane, oriented along a specific axis
// alignAxis: 'z' = text runs along Z (depth), 'x' = text runs along X, 'y' = text runs along Y
// anchor: 'left' = left edge at position, 'right' = right edge at position, 'center' = centered
function makeTextPlane(text, fontSize, color, maxW, alignAxis, anchor, logoImg) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const scale = 3;
    const fs = fontSize * scale;
    ctx.font = `${fs}px Segoe UI, system-ui, sans-serif`;
    const m = ctx.measureText(text);
    const logoSize = logoImg ? fs * 1.2 : 0;
    const logoGap = logoImg ? fs * 0.3 : 0;
    const totalTextW = m.width + fs * 0.4 + logoSize + logoGap;
    const w = Math.min(totalTextW, (maxW || 600) * scale);
    const h = fs * 1.5;
    canvas.width = w; canvas.height = h;
    ctx.font = `${fs}px Segoe UI, system-ui, sans-serif`;
    ctx.fillStyle = color;
    ctx.textBaseline = 'middle';
    let textX = 0;
    if (logoImg) {
        try {
            const sz = fs * 1.0;
            ctx.drawImage(logoImg, 2, (h - sz) / 2, sz, sz);
        } catch(e) {}
        textX = logoSize + logoGap;
    }
    ctx.fillText(text, textX, h / 2);
    const tex = new THREE.CanvasTexture(canvas);
    tex.minFilter = THREE.LinearFilter;
    const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, depthTest: false, side: THREE.DoubleSide });
    const planeW = w / (scale * 8);
    const planeH = h / (scale * 8);
    const geo = new THREE.PlaneGeometry(planeW, planeH);
    const mesh = new THREE.Mesh(geo, mat);
    mesh.raycast = () => {};

    // Orient along the chosen axis
    if (alignAxis === 'z') {
        // Text runs along +Z direction. Plane faces up in XZ plane.
        // Default plane is in XY facing +Z. Rotate -90¬∞ around Y to face +X, then text runs along +Z
        mesh.rotation.set(0, -Math.PI / 2, 0);
        if (anchor === 'left') geo.translate(planeW / 2, 0, 0);
        else if (anchor === 'right') geo.translate(-planeW / 2, 0, 0);
    } else if (alignAxis === 'x') {
        // Text runs along +X direction. Default plane already faces +Z with text along X.
        // No rotation needed for the text direction, but we want it visible from above
        // Keep default (faces +Z)
        if (anchor === 'left') geo.translate(planeW / 2, 0, 0);
        else if (anchor === 'right') geo.translate(-planeW / 2, 0, 0);
    } else if (alignAxis === 'y') {
        // Text runs along +Y (upward)
        mesh.rotation.set(0, 0, Math.PI / 2);
        if (anchor === 'left') geo.translate(planeW / 2, 0, 0);
        else if (anchor === 'right') geo.translate(-planeW / 2, 0, 0);
    }

    mesh.userData._planeW = planeW;
    mesh.userData._planeH = planeH;
    return mesh;
}

// Billboarded sprite (for week labels)
function makeSprite(text, fontSize, color, maxW) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const scale = 3;
    const fs = fontSize * scale;
    ctx.font = `${fs}px Segoe UI, system-ui, sans-serif`;
    const m = ctx.measureText(text);
    const w = Math.min(m.width + fs * 0.4, (maxW || 600) * scale);
    const h = fs * 1.5;
    canvas.width = w; canvas.height = h;
    ctx.font = `${fs}px Segoe UI, system-ui, sans-serif`;
    ctx.fillStyle = color;
    ctx.textBaseline = 'middle';
    ctx.fillText(text, 0, h / 2);
    const tex = new THREE.CanvasTexture(canvas);
    tex.minFilter = THREE.LinearFilter;
    const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, depthTest: false });
    const sprite = new THREE.Sprite(mat);
    sprite.scale.set(w / (scale * 8), h / (scale * 8), 1);
    return sprite;
}

// ============================
// BUILD VISUALIZATION
// ============================
function build(data, keepCamera) {
    // Save camera state before clearing
    const savedCamPos = keepCamera && cam ? cam.position.clone() : null;
    const savedTarget = keepCamera && ctrl ? ctrl.target.clone() : null;
    clearAll();
    // Reset edit state
    selectedCube = null;
    editingData = null;
    if (ghostCube) { scene.remove(ghostCube); ghostCube = null; }
    setAddMode(false);
    curData = data;
    const { companies, activities } = data;
    const evNames = [...new Set(activities.map(a => a.event))];
    const coNames = [...new Set(companies.map(c => c.name))];

    // Include all EVENTS_META names + any from activities (covers custom events with no activities yet)
    filters.events = new Set([...evNames, ...EVENTS_META.map(e => e.name)]);
    filters.regions = new Set([...new Set(companies.map(c => c.region))]);
    filters.stages = new Set(STAGES.map(s => s.id));

    const allDates = activities.map(a => new Date(a.date)).filter(d => !isNaN(d));
    const minDate = new Date(Math.min(...allDates));
    const dayOfWeek = minDate.getDay();
    const weekStart = new Date(minDate);
    weekStart.setDate(weekStart.getDate() - ((dayOfWeek + 6) % 7));

    function dateToWeek(dateStr) {
        const d = new Date(dateStr);
        const diff = d - weekStart;
        return Math.floor(diff / (7 * 24 * 60 * 60 * 1000));
    }

    // nWeeks is global, can be increased with +W button
    maxWeekIdx = nWeeks - 1;
    const CS = 4;
    const GAP = 0.6;
    CELL = CS + GAP;

    const nE = evNames.length, nC = coNames.length;
    const totalX = nE * CELL;
    const totalY = nC * CELL;
    const totalZ = nWeeks * CELL;
    dims = { totalX, totalY, totalZ, CELL, nE, nC, nWeeks };

    const coIdx = {}; coNames.forEach((n, i) => coIdx[n] = i);
    const evIdx = {}; evNames.forEach((n, i) => evIdx[n] = i);
    const cellMap = {};

    activities.forEach(act => {
        const ci = coIdx[act.company], ei = evIdx[act.event];
        const wi = dateToWeek(act.date);
        if (ci === undefined || ei === undefined || wi < 0 || wi >= nWeeks) return;
        const si = STAGES.findIndex(s => s.id === act.stage);
        cellMap[`${ci}|${ei}|${wi}`] = { ...act, si: si >= 0 ? si : 0 };
    });

    const cubeGeo = new THREE.BoxGeometry(CS, CS, CS);
    const wireGeo = new THREE.EdgesGeometry(cubeGeo);
    const emptyWireMat = new THREE.LineBasicMaterial({ color: new THREE.Color(getCSSVar('--empty-wire')), transparent: true, opacity: 0.25 });
    const emptyFillMat = new THREE.MeshPhongMaterial({ color: new THREE.Color(getCSSVar('--empty-fill')), transparent: true, opacity: 0.08, depthWrite: false });

    for (let ci = 0; ci < nC; ci++) {
        for (let ei = 0; ei < nE; ei++) {
            for (let wi = 0; wi < nWeeks; wi++) {
                const x = ei * CELL + CELL / 2;
                const y = ci * CELL + CELL / 2;
                const z = wi * CELL + CELL / 2;
                const act = cellMap[`${ci}|${ei}|${wi}`];
                if (act) {
                    const col = new THREE.Color(SCOLORS[act.si]);
                    const mat = new THREE.MeshPhongMaterial({
                        color: col, emissive: col, emissiveIntensity: 0.2,
                        transparent: true, opacity: 0.82,
                    });
                    const cube = new THREE.Mesh(cubeGeo, mat);
                    cube.position.set(x, y, z);
                    cube.userData = { ...act, ci, ei, wi, filled: true };
                    dGroup.add(cube);
                    allCubes.push(cube);
                    const edgeMat = new THREE.LineBasicMaterial({ color: col, transparent: true, opacity: 0.5 });
                    const edge = new THREE.LineSegments(wireGeo, edgeMat);
                    edge.position.set(x, y, z);
                    edge.userData = { company: act.company, event: act.event, region: act.region, stage: act.stage };
                    connGroup.add(edge);
                } else {
                    const fill = new THREE.Mesh(cubeGeo, emptyFillMat.clone());
                    fill.position.set(x, y, z);
                    fill.userData = { gridCell: true, ci, ei, wi, isEmpty: true };
                    floorGroup.add(fill);
                    const wire = new THREE.LineSegments(wireGeo, emptyWireMat);
                    wire.position.set(x, y, z);
                    wire.userData = { gridCell: true, ci, ei, wi };
                    floorGroup.add(wire);
                }
            }
        }
    }

    // ---- PLANE GRIDS (2D line grids for XY, XZ, YZ) ----
    const planeMat = new THREE.LineBasicMaterial({ color: new THREE.Color(getCSSVar('--plane-grid')), transparent: true, opacity: 0.35 });

    // XY planes (company √ó event): one grid at each week boundary
    for (let wi = 0; wi <= nWeeks; wi++) {
        const z = wi * CELL;
        const pts = [];
        for (let ci = 0; ci <= nC; ci++) { pts.push(new THREE.Vector3(0, ci * CELL, z), new THREE.Vector3(totalX, ci * CELL, z)); }
        for (let ei = 0; ei <= nE; ei++) { pts.push(new THREE.Vector3(ei * CELL, 0, z), new THREE.Vector3(ei * CELL, totalY, z)); }
        const geo = new THREE.BufferGeometry().setFromPoints(pts);
        const line = new THREE.LineSegments(geo, planeMat);
        line.userData = { planeType: 'xy' };
        line.visible = false;
        floorGroup.add(line);
    }
    // XZ planes (event √ó week): one grid at each company boundary
    for (let ci = 0; ci <= nC; ci++) {
        const y = ci * CELL;
        const pts = [];
        for (let ei = 0; ei <= nE; ei++) { pts.push(new THREE.Vector3(ei * CELL, y, 0), new THREE.Vector3(ei * CELL, y, totalZ)); }
        for (let wi = 0; wi <= nWeeks; wi++) { pts.push(new THREE.Vector3(0, y, wi * CELL), new THREE.Vector3(totalX, y, wi * CELL)); }
        const geo = new THREE.BufferGeometry().setFromPoints(pts);
        const line = new THREE.LineSegments(geo, planeMat);
        line.userData = { planeType: 'xz' };
        line.visible = false;
        floorGroup.add(line);
    }
    // YZ planes (company √ó week): one grid at each event boundary
    for (let ei = 0; ei <= nE; ei++) {
        const x = ei * CELL;
        const pts = [];
        for (let ci = 0; ci <= nC; ci++) { pts.push(new THREE.Vector3(x, ci * CELL, 0), new THREE.Vector3(x, ci * CELL, totalZ)); }
        for (let wi = 0; wi <= nWeeks; wi++) { pts.push(new THREE.Vector3(x, 0, wi * CELL), new THREE.Vector3(x, totalY, wi * CELL)); }
        const geo = new THREE.BufferGeometry().setFromPoints(pts);
        const line = new THREE.LineSegments(geo, planeMat);
        line.userData = { planeType: 'yz' };
        line.visible = false;
        floorGroup.add(line);
    }

    // Find actual max week with filled cubes (for blinking)
    let actualMaxWeek = 0;
    allCubes.forEach(c => { if (c.userData.wi > actualMaxWeek) actualMaxWeek = c.userData.wi; });
    maxWeekIdx = actualMaxWeek;

    // ---- AXIS LABELS ----

    // Y axis: Company names (left side) ‚Äî text runs along Z (into depth)
    // Text reads left-to-right along +Z, right edge touching the cube grid front face
    coNames.forEach((name, i) => {
        const comp = companies.find(c => c.name === name);
        const txt = name + (comp ? ' [' + comp.region + ']' : '');
        const logo = logoCache[name] || null;
        const lbl = makeTextPlane(txt, 12, getCSSVar('--label-company'), 260, 'z', 'left', logo);
        // Position: x = well left of grid to avoid overlap with grid mesh, y = row center, z = start of depth
        lbl.position.set(-8, i * CELL + CELL / 2, 0);
        scene.add(lbl); labelMeshes.push(lbl);
        lbl.userData.type = 'axisLabel';
    });

    // X axis: Event names (top) ‚Äî text runs along Z (into depth)
    evNames.forEach((name, j) => {
        const lbl = makeTextPlane(name, 11, getCSSVar('--label-event'), 160, 'z', 'left', null);
        lbl.position.set(j * CELL + CELL / 2, totalY + 3, 0);
        scene.add(lbl); labelMeshes.push(lbl);
        lbl.userData.type = 'axisLabel';
    });

    // Z axis: Week labels ‚Äî just week numbers
    for (let wi = 0; wi < nWeeks; wi++) {
        const sp = makeSprite(`${wi + 1}w`, 10, getCSSVar('--label-week'), 60);
        sp.position.set(-2, -2, wi * CELL + CELL / 2);
        sp.center.set(1, 0.5);
        scene.add(sp); labelMeshes.push(sp);
        sp.userData = { type: 'axisLabel' };
    }

    // Axis titles ‚Äî now as oriented text planes along their respective axes
    // "–ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø ‚Üí" runs along X axis (above event names)
    // But since events are along X and their labels go along Z,
    // the title should indicate the X direction. Place it along Z like the event labels.
    const titleEv = makeTextPlane('–ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø ‚Üí', 20, '#7c5cfc', 350, 'x', 'center', null);
    titleEv.position.set(totalX / 2, totalY + 8, -3);
    scene.add(titleEv); labelMeshes.push(titleEv);
    titleEv.userData = { type: 'axisTitle' };

    // "–ö–û–ú–ü–ê–ù–ò–ò" runs along Y axis (vertical)
    const titleCo = makeTextPlane('–ö–û–ú–ü–ê–ù–ò–ò', 20, '#4f8cff', 300, 'y', 'center', null);
    titleCo.position.set(-16, totalY / 2, -3);
    scene.add(titleCo); labelMeshes.push(titleCo);
    titleCo.userData = { type: 'axisTitle' };

    // "–í–†–ï–ú–Ø (–ù–ï–î–ï–õ–ò) ‚Üí" runs along Z axis (depth)
    const titleTime = makeTextPlane('–í–†–ï–ú–Ø (–ù–ï–î–ï–õ–ò) ‚Üí', 20, '#34d399', 400, 'z', 'center', null);
    titleTime.position.set(-6, -6, totalZ / 2);
    scene.add(titleTime); labelMeshes.push(titleTime);
    titleTime.userData = { type: 'axisTitle' };

    // Stats
    document.getElementById('sC').textContent = nC;
    document.getElementById('sE').textContent = nE;
    document.getElementById('sW').textContent = nWeeks;
    document.getElementById('sA').textContent = allCubes.length;

    // Use EVENTS_META order as canonical, then append any extra events from data
    const allEvNames = [...EVENTS_META.map(e => e.name), ...evNames.filter(n => !EVENTS_META.some(e => e.name === n))];
    buildFilters([...new Set(allEvNames)], [...new Set(companies.map(c => c.region))]);

    // Camera
    const cx = totalX / 2, cy = totalY / 2, cz = totalZ / 2;
    dims.cx = cx; dims.cy = cy; dims.cz = cz;

    if (savedCamPos && savedTarget) {
        // Restore camera position after edit/add/delete
        cam.position.copy(savedCamPos);
        ctrl.target.copy(savedTarget);
    } else {
        // Initial camera ‚Äî isometric-like view from upper-left-front
        const diag = Math.sqrt(totalX * totalX + totalY * totalY + totalZ * totalZ);
        const fovRad = cam.fov * Math.PI / 180;
        const fitDist = (diag * 0.5) / Math.tan(fovRad / 2);
        ctrl.target.set(cx, cy, cz);
        cam.position.set(
            cx - fitDist * 0.38,
            cy + fitDist * 0.32,
            cz - fitDist * 0.58
        );
    }
    ctrl.update();

    setLabelsVisible(labelsVisible);
    updateGridVisibility();
}

// ---- TOGGLES ----
function setLabelsVisible(vis) {
    labelsVisible = vis;
    labelMeshes.forEach(sp => {
        if (sp.userData.type === 'axisLabel') sp.visible = vis;
    });
    document.getElementById('bLabels').classList.toggle('active', vis);
}

function setKeysVisible(vis) {
    keysVisible = vis;
    document.getElementById('keys').classList.toggle('hide', !vis);
    document.getElementById('bKeys').classList.toggle('active', vis);
}

function setGridVisible(vis) {
    gridVisible = vis;
    updateGridVisibility();
    document.getElementById('bGrid').classList.toggle('active', vis);
}
function setGridPlane(plane, vis) {
    if (plane === 'xy') gridXY = vis;
    else if (plane === 'xz') gridXZ = vis;
    else if (plane === 'yz') gridYZ = vis;
    document.getElementById('bGridXY').classList.toggle('active', gridXY);
    document.getElementById('bGridXZ').classList.toggle('active', gridXZ);
    document.getElementById('bGridYZ').classList.toggle('active', gridYZ);
    updateGridVisibility();
}
function updateGridVisibility() {
    // floorGroup has two kinds: gridCell cubes/wires and gridPlane lines
    floorGroup.children.forEach(c => {
        const ud = c.userData;
        if (ud.gridCell) {
            // 3D cube grid: visible only when main toggle is on
            c.visible = gridVisible;
        } else if (ud.planeType) {
            // 2D plane grids
            c.visible = (ud.planeType === 'xy' && gridXY) ||
                        (ud.planeType === 'xz' && gridXZ) ||
                        (ud.planeType === 'yz' && gridYZ);
        }
    });
}

function setBlinkEnabled(vis) {
    blinkEnabled = vis;
    document.getElementById('bBlink').classList.toggle('active', vis);
    // Reset opacity on all last-week cubes when disabling
    if (!vis) {
        allCubes.forEach(s => {
            if (s.userData.wi === maxWeekIdx) {
                s.material.opacity = 0.82;
                s.material.emissiveIntensity = 0.2;
            }
        });
    }
    // Rebuild 2D view to add/remove blink animation classes
    rebuildCurrentView();
}

// ---- LEGEND & FILTERS ----
function buildStageFilters() {
    const sc = document.getElementById('fltS'); sc.innerHTML = '';
    STAGES.forEach((s, i) => {
        const l = document.createElement('label');
        l.innerHTML = `<input type="checkbox" checked data-st="${s.id}"> <span class="leg-dot" style="background:${SCOLORS[i]};display:inline-block"></span> ${s.order}. ${s.name}`;
        l.querySelector('input').onchange = e => {
            if (e.target.checked) filters.stages.add(s.id); else filters.stages.delete(s.id);
            applyF();
        };
        sc.appendChild(l);
    });
    document.getElementById('fltSAll').onclick = () => {
        filters.stages = new Set(STAGES.map(s => s.id));
        sc.querySelectorAll('input').forEach(i => i.checked = true);
        applyF();
    };
    document.getElementById('fltSNone').onclick = () => {
        filters.stages.clear();
        sc.querySelectorAll('input').forEach(i => i.checked = false);
        applyF();
    };
}
function buildFilters(evs, regs) {
    buildStageFilters();

    const ec = document.getElementById('fltE'); ec.innerHTML = '';
    evs.forEach(ev => {
        const l = document.createElement('label');
        const evColor = EVENT_COLORS[ev] || '#888';
        l.innerHTML = `<input type="checkbox" checked data-ev="${ev}"> <span class="leg-dot" style="background:${evColor}"></span> ${ev}`;
        l.querySelector('input').onchange = e => {
            if (e.target.checked) filters.events.add(ev); else filters.events.delete(ev);
            applyF();
        };
        ec.appendChild(l);
    });
    document.getElementById('fltEAll').onclick = () => {
        filters.events = new Set(evs);
        ec.querySelectorAll('input').forEach(i => i.checked = true);
        applyF();
    };
    document.getElementById('fltENone').onclick = () => {
        filters.events.clear();
        ec.querySelectorAll('input').forEach(i => i.checked = false);
        applyF();
    };

    const rc = document.getElementById('fltR'); rc.innerHTML = '';
    regs.forEach(rg => {
        const l = document.createElement('label');
        l.innerHTML = `<input type="checkbox" checked data-rg="${rg}"> ${rg}`;
        l.querySelector('input').onchange = e => {
            if (e.target.checked) filters.regions.add(rg); else filters.regions.delete(rg);
            applyF();
        };
        rc.appendChild(l);
    });
    document.getElementById('fltRAll').onclick = () => {
        filters.regions = new Set(regs);
        rc.querySelectorAll('input').forEach(i => i.checked = true);
        applyF();
    };
    document.getElementById('fltRNone').onclick = () => {
        filters.regions.clear();
        rc.querySelectorAll('input').forEach(i => i.checked = false);
        applyF();
    };
}
function applyF() {
    allCubes.forEach(s => {
        const vis = filters.events.has(s.userData.event) && filters.regions.has(s.userData.region) && filters.stages.has(s.userData.stage);
        s.material.opacity = vis ? 0.82 : 0.04;
        s.material.emissiveIntensity = vis ? 0.2 : 0.0;
    });
    connGroup.children.forEach(c => {
        if (!c.userData.company) return;
        const vis = filters.events.has(c.userData.event) && filters.regions.has(c.userData.region) && (c.userData.stage ? filters.stages.has(c.userData.stage) : true);
        c.material.opacity = vis ? 0.5 : 0.02;
    });
    // Rebuild 2D view if active ‚Äî filters apply there too
    rebuildCurrentView();
}

// ---- INTERACTION ----
function onMove(ev) {
    const wrap = document.getElementById('canvas-wrap');
    const r = wrap.getBoundingClientRect();
    mouse.x = ((ev.clientX - r.left) / r.width) * 2 - 1;
    mouse.y = -((ev.clientY - r.top) / r.height) * 2 + 1;
    ray.setFromCamera(mouse, cam);
    const tip = document.getElementById('tip');

    if (hovered && hovered !== selectedCube) {
        hovered.material.emissiveIntensity = 0.2;
        hovered.scale.set(1, 1, 1);
        hovered = null;
    }

    // Ghost cube for add mode + tooltip showing company/event
    const ghostTip = document.getElementById('ghostTip');
    if (addMode && ghostCube) {
        const emptyHits = ray.intersectObjects(floorGroup.children, false);
        if (emptyHits.length > 0 && emptyHits[0].object.userData.gridCell) {
            ghostCube.visible = true;
            ghostCube.position.copy(emptyHits[0].object.position);
            // Show tooltip with company + event info
            const ud = emptyHits[0].object.userData;
            if (curData && ud.ci !== undefined && ud.ei !== undefined) {
                const coNames = [...new Set(curData.companies.map(c => c.name))];
                const evNames = [...new Set(curData.activities.map(a => a.event))];
                const company = coNames[ud.ci] || '?';
                const event = evNames[ud.ei] || '?';
                ghostTip.innerHTML = `<b>${company}</b><br>${event} ¬∑ –Ω–µ–¥.${(ud.wi||0)+1}`;
                ghostTip.style.display = 'block';
                ghostTip.style.left = (ev.clientX + 16) + 'px';
                ghostTip.style.top = (ev.clientY - 40) + 'px';
                // Ensure stays on screen
                const gr = ghostTip.getBoundingClientRect();
                if (gr.right > window.innerWidth - 8) ghostTip.style.left = (ev.clientX - gr.width - 16) + 'px';
                if (gr.top < 50) ghostTip.style.top = (ev.clientY + 16) + 'px';
            }
        } else {
            ghostCube.visible = false;
            ghostTip.style.display = 'none';
        }
    } else {
        ghostTip.style.display = 'none';
    }

    const hits = ray.intersectObjects(allCubes, false);

    if (hits.length > 0) {
        const o = hits[0].object;
        if (o.material.opacity > 0.1 && o.userData.filled) {
            hovered = o;
            if (o !== selectedCube) {
                o.material.emissiveIntensity = 0.6;
                o.scale.set(1.12, 1.12, 1.12);
            }
            const d = o.userData;
            tip.style.display = 'block';
            tip.style.left = (ev.clientX + 14) + 'px';
            tip.style.top = (ev.clientY - 8) + 'px';
            const tr = tip.getBoundingClientRect();
            if (tr.right > window.innerWidth - 8) tip.style.left = (ev.clientX - tr.width - 14) + 'px';
            if (tr.bottom > window.innerHeight - 8) tip.style.top = (ev.clientY - tr.height - 8) + 'px';
            tip.innerHTML = `
                <div class="t-name">${d.company}</div>
                <div class="t-dim">${d.region} ¬∑ ${d.contact}</div>
                <div class="t-dim">${d.position}</div>
                <div style="margin-top:6px"><b>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</b> ${d.event}<br><b>–î–∞—Ç–∞:</b> ${d.date}<br><b>–ù–µ–¥–µ–ª—è:</b> ${(d.wi || 0) + 1}w</div>
                <div class="t-badge" style="background:${SCOLORS[d.si]}22;color:${SCOLORS[d.si]}">${d.stageName}</div>
            `;
            rend.domElement.style.cursor = addMode ? 'cell' : 'pointer';
        }
    } else {
        tip.style.display = 'none';
        rend.domElement.style.cursor = addMode ? 'cell' : 'grab';
    }
}

function showDetail(d) {
    const p = document.getElementById('detail');
    const c = document.getElementById('detC');
    const chain = curData.activities.filter(a => a.company === d.company && a.event === d.event).sort((a, b) => a.stageOrder - b.stageOrder);
    const all = curData.activities.filter(a => a.company === d.company).sort((a, b) => new Date(a.date) - new Date(b.date));
    const ci = curData.companies.find(co => co.name === d.company) || d;
    c.innerHTML = `
        <h2>${d.company}</h2>
        <div class="dmeta">${ci.region}<br>${ci.contact}<br>${ci.pos || ci.position || ''}</div>
        <div style="margin-bottom:10px">
            <button class="btn" style="font-size:11px;padding:3px 10px;margin-right:6px" onclick="openEditForSelected()">‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="btn" style="font-size:11px;padding:3px 10px;color:var(--del-text);border-color:var(--del-border)" onclick="deleteSelected()">‚úï –£–¥–∞–ª–∏—Ç—å</button>
        </div>
        <h3 style="font-size:12px;color:var(--accent);margin-bottom:10px">${d.event} ‚Äî –ü—Ä–æ–≥—Ä–µ—Å—Å</h3>
        <div class="tl">${chain.map(a => {
            const si = STAGES.findIndex(s => s.id === a.stage);
            return `<div class="tl-i done"><div class="t" style="color:${SCOLORS[si]}">${a.stageName}</div><div class="d">${a.date}</div></div>`;
        }).join('')}</div>
        <h3 style="font-size:12px;color:var(--purple);margin:16px 0 10px">–í—Å–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
        <div class="tl">${all.map(a => {
            const si = STAGES.findIndex(s => s.id === a.stage);
            return `<div class="tl-i done"><div class="e">${a.event}</div><div class="t" style="color:${SCOLORS[si >= 0 ? si : 0]}">${a.stageName}</div><div class="d">${a.date}</div></div>`;
        }).join('')}</div>
    `;
    p.classList.add('open');
}
function openEditForSelected() {
    if (selectedCube) openEditPanel(selectedCube, false);
    document.getElementById('detail').classList.remove('open');
}
function deleteSelected() {
    if (selectedCube && curData) {
        const d = selectedCube.userData;
        customConfirm(
            `${d.company} ‚Äî ${d.stageName} (${d.event}, –Ω–µ–¥.${(d.wi||0)+1})`,
            '–£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?'
        ).then(ok => {
            if (ok) {
                const idx = curData.activities.findIndex(a =>
                    a.company === d.company && a.event === d.event && a.stage === d.stage && a.date === d.date
                );
                if (idx >= 0) { curData.activities.splice(idx, 1); markDirty(); closeEditPanel(); build(curData, true); rebuildCurrentView(); }
            }
        });
    }
}

function onResize() {
    const w = document.getElementById('canvas-wrap');
    cam.aspect = w.clientWidth / w.clientHeight;
    cam.updateProjectionMatrix();
    rend.setSize(w.clientWidth, w.clientHeight);
}

function anim() {
    requestAnimationFrame(anim);
    processKeys();
    ctrl.update();
    const t = Date.now() * 0.001;
    allCubes.forEach((s, i) => {
        if (s === hovered || s.material.opacity < 0.1) return;
        if (blinkEnabled && s.userData.wi === maxWeekIdx) {
            // Blink: pulsate between bright and dim
            const blink = (Math.sin(t * 5) + 1) * 0.5; // 0..1 oscillation ~2.5Hz
            s.material.emissiveIntensity = 0.3 + blink * 0.7;
            s.material.opacity = 0.5 + blink * 0.5;
        } else {
            s.material.emissiveIntensity = 0.2 + Math.sin(t * 1.2 + i * 0.15) * 0.05;
        }
    });
    rend.render(scene, cam);
}

// ---- UI WIRING ----
async function loadDemo() {
    document.getElementById('upload').classList.add('gone');
    // Wait for logos to finish loading (up to 5s)
    if (!logosReady) await preloadLogos();
    build(genDemo());
    markDirty(); // demo data is unsaved
    // Auto-switch to 2D view by default
    if (currentView === '3d') switchView('2d');
}
document.getElementById('bDemoU').onclick = loadDemo;
document.getElementById('bDemo').onclick = loadDemo;
document.getElementById('bFile').onclick = () => document.getElementById('finp').click();
document.getElementById('bLoad').onclick = () => document.getElementById('finp').click();
document.getElementById('finp').onchange = async e => {
    const f = e.target.files[0]; if (!f) return;
    try {
        const d = await parseExcel(f);
        document.getElementById('upload').classList.add('gone');
        if (!logosReady) await preloadLogos();
        build(d);
        // Auto-switch to 2D view by default
        if (currentView === '3d') switchView('2d');
    } catch (err) { alert('–û—à–∏–±–∫–∞: ' + err.message); }
};
const uc = document.getElementById('ucard');
['dragover', 'dragenter'].forEach(e => uc.addEventListener(e, ev => { ev.preventDefault(); uc.classList.add('over'); }));
['dragleave', 'drop'].forEach(e => uc.addEventListener(e, () => uc.classList.remove('over')));
uc.addEventListener('drop', async e => {
    e.preventDefault();
    const f = e.dataTransfer.files[0]; if (!f) return;
    try {
        const d = await parseExcel(f);
        document.getElementById('upload').classList.add('gone');
        if (!logosReady) await preloadLogos();
        build(d);
        if (currentView === '3d') switchView('2d');
    } catch (err) { alert('–û—à–∏–±–∫–∞: ' + err.message); }
});

document.getElementById('bReset').onclick = () => {
    if (!curData) return;
    const diag = Math.sqrt(dims.totalX**2 + dims.totalY**2 + dims.totalZ**2);
    const fovRad = cam.fov * Math.PI / 180;
    const fitDist = (diag * 0.5) / Math.tan(fovRad / 2);
    ctrl.target.set(dims.cx, dims.cy, dims.cz);
    cam.position.set(dims.cx - fitDist * 0.38, dims.cy + fitDist * 0.32, dims.cz - fitDist * 0.58);
    ctrl.update();
    rend.domElement.focus();
};

document.getElementById('bLabels').onclick = () => setLabelsVisible(!labelsVisible);
document.getElementById('bGrid').onclick = () => setGridVisible(!gridVisible);
document.getElementById('bGridXY').onclick = () => setGridPlane('xy', !gridXY);
document.getElementById('bGridXZ').onclick = () => setGridPlane('xz', !gridXZ);
document.getElementById('bGridYZ').onclick = () => setGridPlane('yz', !gridYZ);
document.getElementById('bKeys').onclick = () => setKeysVisible(!keysVisible);
document.getElementById('bBlink').onclick = () => setBlinkEnabled(!blinkEnabled);

document.getElementById('bAddWeek').onclick = () => {
    if (!curData) return;
    nWeeks++;
    markDirty();
    build(curData, true);
    rebuildCurrentView();
    document.getElementById('sW').textContent = nWeeks;
};

document.getElementById('bSave').onclick = () => { if (curData) saveToStorage(); };

// ============================
// THEME TOGGLE
// ============================
function setTheme(dark) {
    if (dark) document.documentElement.setAttribute('data-theme', 'dark');
    else document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('vibeMarketing_theme', dark ? 'dark' : 'light');
    // Update dropdown theme labels
    const icon = dark ? '\u2600\uFE0F' : '\uD83C\uDF19';
    const label = dark ? '\u0421\u0432\u0435\u0442\u043B\u0430\u044F \u0442\u0435\u043C\u0430' : '\u0422\u0451\u043C\u043D\u0430\u044F \u0442\u0435\u043C\u0430';
    const tico = document.getElementById('ddThemeIcon'); if (tico) tico.textContent = icon;
    const tlab = document.getElementById('ddThemeLabel'); if (tlab) tlab.textContent = label;
    // Update Three.js scene background
    if (typeof scene !== 'undefined' && scene) {
        scene.background = new THREE.Color(getCSSVar('--scene-bg'));
    }
    // Rebuild 3D labels if data loaded (they are bitmap textures)
    if (curData) build(curData, true);
    rebuildCurrentView();
}
// Sync theme labels on load
(function() {
    const dark = isDarkTheme();
    const icon = dark ? '\u2600\uFE0F' : '\uD83C\uDF19';
    const label = dark ? '\u0421\u0432\u0435\u0442\u043B\u0430\u044F \u0442\u0435\u043C\u0430' : '\u0422\u0451\u043C\u043D\u0430\u044F \u0442\u0435\u043C\u0430';
    const tico = document.getElementById('ddThemeIcon'); if (tico) tico.textContent = icon;
    const tlab = document.getElementById('ddThemeLabel'); if (tlab) tlab.textContent = label;
})();

const pan = document.getElementById('panel');
function togglePanel() {
    pan.classList.toggle('hide');
    document.getElementById('canvas-wrap').classList.toggle('full');
    document.getElementById('view2d').classList.toggle('full');
    document.getElementById('viewTimeline').classList.toggle('full');
    document.getElementById('viewEvents').classList.toggle('full');
    document.getElementById('viewCompanies').classList.toggle('full');
    onResize();
}
document.getElementById('bPanel').onclick = togglePanel;
document.getElementById('clsPanel').onclick = () => { if (!pan.classList.contains('hide')) togglePanel(); };
document.getElementById('clsDet').onclick = () => document.getElementById('detail').classList.remove('open');

// Refocus canvas after any button click so keyboard keeps working
document.querySelectorAll('.btn, .btn-icon, .panel-close, .cls, .flt-btns button').forEach(btn => {
    btn.addEventListener('click', () => {
        setTimeout(() => {
            if (rend && rend.domElement) rend.domElement.focus();
            else document.body.focus();
        }, 50);
    });
});

// ============================
// KEYBOARD CONTROLS
// ============================
const KEY_STATE = {};
const ROT_SPEED = 0.02;
const PAN_SPEED = 1.5;
const ZOOM_SPEED = 2.0;

window.addEventListener('keydown', e => {
    // Ctrl+S to save
    if ((e.ctrlKey || e.metaKey) && e.code === 'KeyS') {
        e.preventDefault();
        if (curData) saveToStorage();
        return;
    }
    // Escape works even from inputs (to close modals)
    if (e.code === 'Escape') {
        document.getElementById('detail').classList.remove('open'); document.getElementById('tip').style.display = 'none'; closeFormModal(); return;
    }
    const tag = document.activeElement?.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;
    KEY_STATE[e.code] = true;
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'Space',
        'Equal', 'Minus', 'NumpadAdd', 'NumpadSubtract'].includes(e.code)) {
        e.preventDefault();
    }
    if (e.code === 'KeyR' || e.code === 'Home') document.getElementById('bReset').click();
    if (e.code === 'KeyP') document.getElementById('bPanel').click();
    if (e.code === 'KeyL') document.getElementById('bLabels').click();
    if (e.code === 'KeyG') document.getElementById('bGrid').click();
    if (e.code === 'KeyH') document.getElementById('bKeys').click();
    if (e.code === 'KeyB') document.getElementById('bBlink').click();
    if (e.code === 'KeyN') document.getElementById('bAddMode').click();
    if (e.code === 'KeyD') setTheme(!isDarkTheme());
    if (e.code === 'KeyT') { if (currentView === '2d') switchView('3d'); else switchView('2d'); }
    if (e.code === 'KeyY') { if (currentView === 'timeline') switchView('3d'); else switchView('timeline'); }
    if ((e.code === 'Delete' || e.code === 'Backspace') && selectedCube && curData) {
        const d = selectedCube.userData;
        customConfirm(
            `${d.company} ‚Äî ${d.stageName} (${d.event}, –Ω–µ–¥.${(d.wi||0)+1})`,
            '–£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?'
        ).then(ok => {
            if (ok) {
                const idx = curData.activities.findIndex(a =>
                    a.company === d.company && a.event === d.event && a.stage === d.stage && a.date === d.date
                );
                if (idx >= 0) { curData.activities.splice(idx, 1); markDirty(); closeEditPanel(); build(curData, true); rebuildCurrentView(); }
            }
        });
    }
    if (e.code === 'KeyF') { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
    if (e.code === 'Digit1') setCamPreset('front');
    if (e.code === 'Digit2') setCamPreset('top');
    if (e.code === 'Digit3') setCamPreset('right');
    if (e.code === 'Digit4') setCamPreset('perspective');
    if (e.code === 'Digit5') setCamPreset('left');
    if (e.code === 'Digit6') setCamPreset('back');
});
window.addEventListener('keyup', e => { KEY_STATE[e.code] = false; });
// Clear all keys on window blur to prevent stuck keys
window.addEventListener('blur', () => { Object.keys(KEY_STATE).forEach(k => KEY_STATE[k] = false); });

function setCamPreset(view) {
    if (!curData) return;
    const cx = dims.cx, cy = dims.cy, cz = dims.cz;
    const d = Math.max(dims.totalX, dims.totalY, dims.totalZ) * 0.9;
    ctrl.target.set(cx, cy, cz);
    switch (view) {
        case 'front': cam.position.set(cx, cy, cz - d * 1.2); break;
        case 'top': cam.position.set(cx, cy + d * 1.2, cz); break;
        case 'right': cam.position.set(cx + d * 1.2, cy, cz); break;
        case 'left': cam.position.set(cx - d * 1.2, cy, cz); break;
        case 'back': cam.position.set(cx, cy, cz + d * 1.2); break;
        case 'perspective': {
            const diag = Math.sqrt(dims.totalX**2 + dims.totalY**2 + dims.totalZ**2);
            const fovRad = cam.fov * Math.PI / 180;
            const fitDist = (diag * 0.5) / Math.tan(fovRad / 2);
            cam.position.set(cx - fitDist * 0.38, cy + fitDist * 0.32, cz - fitDist * 0.58);
            break;
        }
    }
    ctrl.update();
}

function processKeys() {
    if (!curData) return;
    const forward = new THREE.Vector3();
    cam.getWorldDirection(forward);
    forward.y = 0; forward.normalize();
    const right = new THREE.Vector3();
    right.crossVectors(forward, new THREE.Vector3(0, 1, 0)).normalize();
    const up = new THREE.Vector3(0, 1, 0);

    if (KEY_STATE['ArrowLeft']) { const o = cam.position.clone().sub(ctrl.target); o.applyAxisAngle(up, ROT_SPEED); cam.position.copy(ctrl.target).add(o); }
    if (KEY_STATE['ArrowRight']) { const o = cam.position.clone().sub(ctrl.target); o.applyAxisAngle(up, -ROT_SPEED); cam.position.copy(ctrl.target).add(o); }
    if (KEY_STATE['ArrowUp']) { const o = cam.position.clone().sub(ctrl.target); o.applyAxisAngle(right, ROT_SPEED); cam.position.copy(ctrl.target).add(o); }
    if (KEY_STATE['ArrowDown']) { const o = cam.position.clone().sub(ctrl.target); o.applyAxisAngle(right, -ROT_SPEED); cam.position.copy(ctrl.target).add(o); }

    if (KEY_STATE['KeyW']) { const v = forward.clone().multiplyScalar(PAN_SPEED); ctrl.target.add(v); cam.position.add(v); }
    if (KEY_STATE['KeyS']) { const v = forward.clone().multiplyScalar(-PAN_SPEED); ctrl.target.add(v); cam.position.add(v); }
    if (KEY_STATE['KeyA']) { const v = right.clone().multiplyScalar(-PAN_SPEED); ctrl.target.add(v); cam.position.add(v); }
    if (KEY_STATE['KeyD']) { const v = right.clone().multiplyScalar(PAN_SPEED); ctrl.target.add(v); cam.position.add(v); }
    if (KEY_STATE['KeyQ'] || KEY_STATE['Space']) { const v = up.clone().multiplyScalar(PAN_SPEED); ctrl.target.add(v); cam.position.add(v); }
    if (KEY_STATE['KeyE']) { const v = up.clone().multiplyScalar(-PAN_SPEED); ctrl.target.add(v); cam.position.add(v); }

    if (KEY_STATE['Equal'] || KEY_STATE['NumpadAdd'] || KEY_STATE['KeyZ']) { cam.position.add(ctrl.target.clone().sub(cam.position).normalize().multiplyScalar(ZOOM_SPEED)); }
    if (KEY_STATE['Minus'] || KEY_STATE['NumpadSubtract'] || KEY_STATE['KeyX']) { cam.position.add(ctrl.target.clone().sub(cam.position).normalize().multiplyScalar(-ZOOM_SPEED)); }
}

// ============================
// EDIT MODE
// ============================
const editStageEl = document.getElementById('editStage');
// Stage dropdown is populated dynamically in openEditPanel()

function setAddMode(on) {
    addMode = on;
    document.getElementById('bAddMode').classList.toggle('active', on);
    const ind = document.getElementById('modeInd');
    if (on) {
        ind.textContent = '–†–µ–∂–∏–º –¥–æ–±–∞–≤–ª–µ–Ω–∏—è ‚Äî –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ø—É—Å—Ç—É—é —è—á–µ–π–∫—É ¬∑ Shift+Click —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç';
        ind.classList.add('show');
        rend.domElement.style.cursor = 'cell';
        // Make empty cubes visible and raycastable in add mode
        floorGroup.children.forEach(c => {
            if (c.userData.isEmpty) {
                c.visible = true;
                c.material.opacity = 0.04;
            }
        });
        // Create ghost cube
        if (!ghostCube) {
            const CS = CELL - 0.6;
            const geo = new THREE.BoxGeometry(CS, CS, CS);
            const mat = new THREE.MeshPhongMaterial({
                color: 0x4f8cff, emissive: new THREE.Color(0x4f8cff),
                emissiveIntensity: 0.4, transparent: true, opacity: 0.3, depthWrite: false,
            });
            ghostCube = new THREE.Mesh(geo, mat);
            ghostCube.visible = false;
            ghostCube.raycast = () => {};
            scene.add(ghostCube);
        }
    } else {
        ind.classList.remove('show');
        rend.domElement.style.cursor = 'grab';
        if (ghostCube) ghostCube.visible = false;
        // Restore empty cube visibility
        updateGridVisibility();
    }
}

function openEditPanel(cubeOrData, isNew) {
    const ep = document.getElementById('editPanel');
    const info = document.getElementById('editInfo');
    const d = cubeOrData.userData || cubeOrData;
    editingData = { ...d, isNew: !!isNew, sourceCube: cubeOrData.userData ? cubeOrData : null };

    document.getElementById('editTitle').textContent = isNew ? '+ –ù–æ–≤—ã–π —ç—Ç–∞–ø' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
    info.innerHTML = `<b>–ö–æ–º–ø–∞–Ω–∏—è:</b> ${d.company || '‚Äî'}<br><b>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ:</b> ${d.event || '‚Äî'}<br><b>–ù–µ–¥–µ–ª—è:</b> ${(d.wi || 0) + 1}w`;

    // Rebuild stage dropdown based on context
    editStageEl.innerHTML = '';
    if (isNew && curData && d.company) {
        // Find the highest stage this company has already reached
        const companyActs = curData.activities.filter(a => a.company === d.company);
        let maxOrder = 0;
        companyActs.forEach(a => {
            const si = STAGES.findIndex(s => s.id === a.stage);
            if (si >= 0 && STAGES[si].order > maxOrder) maxOrder = STAGES[si].order;
        });
        // Only show stages AFTER the last reached one
        STAGES.forEach((s, i) => {
            if (s.order > maxOrder) {
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = `${s.order}. ${s.name}`;
                opt.style.color = SCOLORS[i];
                editStageEl.appendChild(opt);
            }
        });
        // If no stages available (all 11 reached), show message
        if (editStageEl.options.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '‚Äî –í—Å–µ —ç—Ç–∞–ø—ã –ø—Ä–æ–π–¥–µ–Ω—ã ‚Äî';
            opt.disabled = true;
            editStageEl.appendChild(opt);
        }
        // Pre-select the first available (next stage)
        editStageEl.value = editStageEl.options[0]?.value || '';
        // Show current progress info
        const lastStage = maxOrder > 0 ? STAGES.find(s => s.order === maxOrder) : null;
        if (lastStage) {
            info.innerHTML += `<br><b>–ü–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø:</b> <span style="color:${SCOLORS[STAGES.indexOf(lastStage)]}">${lastStage.name}</span>`;
        }
    } else {
        // Editing existing ‚Äî show all stages
        STAGES.forEach((s, i) => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = `${s.order}. ${s.name}`;
            opt.style.color = SCOLORS[i];
            editStageEl.appendChild(opt);
        });
        editStageEl.value = d.stage || STAGES[0].id;
    }

    document.getElementById('editDate').value = d.date || new Date().toISOString().slice(0, 10);
    document.getElementById('editDel').style.display = isNew ? 'none' : '';

    ep.classList.add('open');
    // Close detail panel if open
    document.getElementById('detail').classList.remove('open');
}

function closeEditPanel() {
    document.getElementById('editPanel').classList.remove('open');
    if (selectedCube) {
        selectedCube.material.emissiveIntensity = 0.2;
        selectedCube.scale.set(1, 1, 1);
        selectedCube = null;
    }
    editingData = null;
}

document.getElementById('clsEdit').onclick = closeEditPanel;
document.getElementById('editCancel').onclick = closeEditPanel;

document.getElementById('editSave').onclick = () => {
    if (!editingData || !curData) return;
    const stageId = editStageEl.value;
    if (!stageId) return; // no valid stage selected (all stages reached)
    const si = STAGES.findIndex(s => s.id === stageId);
    if (si < 0) return;
    const stage = STAGES[si];
    const dateVal = document.getElementById('editDate').value;

    if (editingData.isNew) {
        // ADD new activity
        const newAct = {
            company: editingData.company,
            region: editingData.region || '',
            contact: editingData.contact || '',
            position: editingData.position || '',
            event: editingData.event,
            stage: stage.id,
            stageName: stage.name,
            stageOrder: stage.order,
            date: dateVal,
        };
        curData.activities.push(newAct);
        markDirty();
    } else {
        // EDIT existing: update in activities array
        const idx = curData.activities.findIndex(a =>
            a.company === editingData.company && a.event === editingData.event &&
            a.stage === editingData.stage && a.date === editingData.date
        );
        if (idx >= 0) {
            curData.activities[idx].stage = stage.id;
            curData.activities[idx].stageName = stage.name;
            curData.activities[idx].stageOrder = stage.order;
            curData.activities[idx].date = dateVal;
            markDirty();
        }
    }
    closeEditPanel();
    build(curData, true); // Rebuild visualization
    rebuildCurrentView();
};

document.getElementById('editDel').onclick = () => {
    if (!editingData || !curData) return;
    const ed = editingData;
    customConfirm(
        `${ed.company} ‚Äî ${ed.event}`,
        '–£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?'
    ).then(ok => {
        if (ok) {
            const idx = curData.activities.findIndex(a =>
                a.company === ed.company && a.event === ed.event &&
                a.stage === ed.stage && a.date === ed.date
            );
            if (idx >= 0) {
                curData.activities.splice(idx, 1);
                markDirty();
            }
            closeEditPanel();
            build(curData, true);
            rebuildCurrentView();
        }
    });
};

// Context menu
function showCtxMenu(x, y, cube) {
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block';
    menu.style.left = x + 'px';
    menu.style.top = y + 'px';
    // Adjust if off screen
    const r = menu.getBoundingClientRect();
    if (r.right > window.innerWidth - 5) menu.style.left = (x - r.width) + 'px';
    if (r.bottom > window.innerHeight - 5) menu.style.top = (y - r.height) + 'px';
    menu._cube = cube;
}
function hideCtxMenu() { document.getElementById('ctxMenu').style.display = 'none'; }

document.getElementById('ctxEdit').onclick = () => {
    const cube = document.getElementById('ctxMenu')._cube;
    if (cube) openEditPanel(cube, false);
    hideCtxMenu();
};
document.getElementById('ctxDel').onclick = () => {
    const cube = document.getElementById('ctxMenu')._cube;
    hideCtxMenu();
    if (cube && curData) {
        const d = cube.userData;
        customConfirm(
            `${d.company} ‚Äî ${d.stageName} (${d.event}, –Ω–µ–¥.${(d.wi||0)+1})`,
            '–£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?'
        ).then(ok => {
            if (ok) {
                const idx = curData.activities.findIndex(a =>
                    a.company === d.company && a.event === d.event &&
                    a.stage === d.stage && a.date === d.date
                );
                if (idx >= 0) {
                    curData.activities.splice(idx, 1);
                    markDirty();
                    build(curData, true);
                    rebuildCurrentView();
                }
            }
        });
    }
};
document.getElementById('ctxAdd').onclick = () => {
    hideCtxMenu();
    setAddMode(true);
};

document.addEventListener('click', e => {
    if (!document.getElementById('ctxMenu').contains(e.target)) hideCtxMenu();
});

document.getElementById('bAddMode').onclick = () => setAddMode(!addMode);

// ============================
// VIEW SWITCHING: 3D / 2D / Timeline
// ============================
let currentView = '3d'; // '3d', '2d', 'timeline'

function switchView(view) {
    currentView = view;
    const v2 = document.getElementById('view2d');
    const vt = document.getElementById('viewTimeline');
    const ve = document.getElementById('viewEvents');
    const vc = document.getElementById('viewCompanies');
    const cw = document.getElementById('canvas-wrap');
    const isPanelFull = cw.classList.contains('full');

    // Hide all views
    v2.classList.remove('active');
    vt.classList.remove('active');
    ve.classList.remove('active');
    vc.classList.remove('active');
    cw.style.display = 'none';

    // Pill-tabs: highlight active view
    const navMap = {bTo3D:'3d', bTo2D:'2d', bToTimeline:'timeline', bToEvents:'events', bToCompanies:'companies'};
    Object.entries(navMap).forEach(([id, v]) => {
        const el = document.getElementById(id);
        if (v === view) el.classList.add('active');
        else el.classList.remove('active');
    });

    // Toolbar visibility by view type
    const isViz = (view === '3d' || view === '2d' || view === 'timeline');
    const is3D  = (view === '3d');

    // tb-3d: only 3D
    document.querySelectorAll('#topbar .tb-3d').forEach(el => {
        el.style.display = is3D ? '' : 'none';
    });
    // tb-viz: 3D, 2D, Timeline
    document.querySelectorAll('#topbar .tb-viz').forEach(el => {
        el.style.display = isViz ? '' : 'none';
    });

    // Panel & keys: hide for non-viz views, restore for viz views
    const pan = document.getElementById('panel');
    const keys = document.getElementById('keys');
    if (!isViz) {
        pan.style.display = 'none';
        if (keys) keys.style.display = 'none';
    } else {
        pan.style.display = '';
        if (keys) keys.style.display = '';
    }

    const overlay = (el) => {
        if (!isViz || cw.classList.contains('full')) el.classList.add('full');
        else el.classList.remove('full');
    };

    if (view === '2d') {
        v2.classList.add('active'); overlay(v2); build2D();
    } else if (view === 'timeline') {
        vt.classList.add('active'); overlay(vt); buildTimeline();
    } else if (view === 'events') {
        ve.classList.add('active'); overlay(ve); buildEventsView();
    } else if (view === 'companies') {
        vc.classList.add('active'); overlay(vc); buildCompaniesView();
    } else {
        // 3D
        cw.style.display = '';
        onResize();
    }
}

// Getter for backward compat
Object.defineProperty(window, 'is2D', {
    get() { return currentView !== '3d'; },
});
// Rebuild the current overlay view
function rebuildCurrentView() {
    if (currentView === '2d') setTimeout(build2D, 50);
    else if (currentView === 'timeline') setTimeout(buildTimeline, 50);
    else if (currentView === 'events') setTimeout(buildEventsView, 50);
    else if (currentView === 'companies') setTimeout(buildCompaniesView, 50);
}

document.getElementById('bTo3D').onclick = () => switchView('3d');
document.getElementById('bTo2D').onclick = () => switchView('2d');
document.getElementById('bToTimeline').onclick = () => switchView('timeline');
document.getElementById('bToEvents').onclick = () => switchView('events');
document.getElementById('bToCompanies').onclick = () => switchView('companies');

// ============================
// ADD EVENT / ADD COMPANY MODALS
// ============================
const PALETTE = [
    '#6366f1','#f43f5e','#8b5cf6','#f97316','#0ea5e9','#10b981',
    '#e11d48','#64748b','#a855f7','#06b6d4','#eab308','#ec4899',
    '#14b8a6','#f472b6','#84cc16','#fb923c',
];

function showFormModal(html) {
    const m = document.getElementById('formModal');
    document.getElementById('fmBox').innerHTML = html;
    m.classList.add('show');
    // Close on overlay click
    m.onclick = e => { if (e.target === m) closeFormModal(); };
}
function closeFormModal() {
    document.getElementById('formModal').classList.remove('show');
}

function openAddEventModal() {
    let weekOpts = '';
    for (let w = 1; w <= nWeeks; w++) weekOpts += `<option value="${w-1}">${w}w</option>`;

    // Find colors already used
    const usedColors = new Set(EVENTS_META.map(e => e.color));
    let palHtml = '';
    PALETTE.forEach(c => {
        const used = usedColors.has(c) ? ' style="opacity:0.3"' : '';
        palHtml += `<div class="color-sw" data-color="${c}" style="background:${c}"${used}></div>`;
    });

    showFormModal(`
        <h2>+ –ù–æ–≤–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</h2>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input type="text" id="fmEvName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–µ–ª–æ–≤–æ–π —É–∂–∏–Ω">
        <label>–ù–µ–¥–µ–ª—è –Ω–∞—á–∞–ª–∞</label>
        <select id="fmEvWeek">${weekOpts}</select>
        <label>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
        <div class="fm-row">
            <div><input type="number" id="fmEvDur" value="1" min="1" max="99"></div>
            <div><select id="fmEvDurUnit">
                <option value="d">–¥–Ω–µ–π</option>
                <option value="w" selected>–Ω–µ–¥–µ–ª—å</option>
                <option value="m">–º–µ—Å—è—Ü–µ–≤</option>
            </select></div>
        </div>
        <label>–¶–≤–µ—Ç</label>
        <div class="color-pal" id="fmPalette">${palHtml}</div>
        <div class="fm-actions">
            <button class="fm-cancel" id="fmCancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="fm-ok" id="fmOk">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    `);

    // Color selection
    let selColor = PALETTE.find(c => !usedColors.has(c)) || PALETTE[0];
    const palEl = document.getElementById('fmPalette');
    function markSel() {
        palEl.querySelectorAll('.color-sw').forEach(s => s.classList.toggle('sel', s.dataset.color === selColor));
    }
    markSel();
    palEl.onclick = e => {
        const sw = e.target.closest('.color-sw');
        if (sw) { selColor = sw.dataset.color; markSel(); }
    };

    document.getElementById('fmCancel').onclick = closeFormModal;
    document.getElementById('fmOk').onclick = () => {
        const name = document.getElementById('fmEvName').value.trim();
        if (!name) { document.getElementById('fmEvName').style.borderColor = 'var(--error-border)'; return; }
        // Check duplicate
        if (EVENTS_META.some(e => e.name === name)) {
            document.getElementById('fmEvName').style.borderColor = 'var(--error-border)';
            document.getElementById('fmEvName').value = '';
            document.getElementById('fmEvName').placeholder = '–¢–∞–∫–æ–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ —É–∂–µ –µ—Å—Ç—å!';
            return;
        }
        const weekStart = parseInt(document.getElementById('fmEvWeek').value);
        const durVal = parseInt(document.getElementById('fmEvDur').value) || 1;
        const durUnit = document.getElementById('fmEvDurUnit').value;
        // Convert duration to weeks
        let durationWeeks;
        if (durUnit === 'd') durationWeeks = Math.max(1, Math.ceil(durVal / 7));
        else if (durUnit === 'm') durationWeeks = durVal * 4;
        else durationWeeks = durVal;

        EVENTS_META.push({ name, weekStart, duration: durationWeeks, color: selColor });
        rebuildEventsDerived();
        if (curData) {
            filters.events.add(name);
            markDirty();
            build(curData, true);
            rebuildCurrentView();
        }
        closeFormModal();
    };
}

// ============================
// FINANCE VISUALIZATION
// ============================

const finCache = {};

function finOpenModal(html) {
    const modal = document.getElementById('formModal');
    modal.classList.add('fin-modal');
    showFormModal(html);
    const closeBtn = document.getElementById('fmCancel');
    const closeFn = () => { modal.classList.remove('fin-modal'); closeFormModal(); };
    if (closeBtn) closeBtn.onclick = closeFn;
    modal.onclick = e => { if (e.target === modal) closeFn(); };
}

function finFormatRub(val) {
    // Format rubles: 1234567890 ‚Üí "1.23 –º–ª—Ä–¥ ‚ÇΩ", 12345678 ‚Üí "12.3 –º–ª–Ω ‚ÇΩ", etc.
    if (val === null || val === undefined) return null;
    const abs = Math.abs(val);
    const sign = val < 0 ? '‚àí' : '';
    if (abs >= 1e12) return sign + (abs / 1e12).toFixed(2) + ' —Ç—Ä–ª–Ω ‚ÇΩ';
    if (abs >= 1e9)  return sign + (abs / 1e9).toFixed(2) + ' –º–ª—Ä–¥ ‚ÇΩ';
    if (abs >= 1e6)  return sign + (abs / 1e6).toFixed(1) + ' –º–ª–Ω ‚ÇΩ';
    if (abs >= 1e3)  return sign + (abs / 1e3).toFixed(0) + ' —Ç—ã—Å ‚ÇΩ';
    return sign + abs.toFixed(0) + ' ‚ÇΩ';
}

function finRenderData(name, d) {
    const metrics = [];
    if (d.revenue !== null && d.revenue !== undefined) {
        metrics.push(`<div class="fin-metric"><div class="fin-icon">üí∞</div><div class="fin-value">${finFormatRub(d.revenue)}</div><div class="fin-label">–í—ã—Ä—É—á–∫–∞</div></div>`);
    }
    if (d.income !== null && d.income !== undefined) {
        const cls = d.income >= 0 ? 'positive' : 'negative';
        metrics.push(`<div class="fin-metric ${cls}"><div class="fin-icon">üìà</div><div class="fin-value">${finFormatRub(d.income)}</div><div class="fin-label">–ü—Ä–∏–±—ã–ª—å</div></div>`);
    }
    if (d.expense !== null && d.expense !== undefined) {
        metrics.push(`<div class="fin-metric"><div class="fin-icon">üìâ</div><div class="fin-value">${finFormatRub(d.expense)}</div><div class="fin-label">–†–∞—Å—Ö–æ–¥—ã</div></div>`);
    }
    if (d.assets !== null && d.assets !== undefined) {
        metrics.push(`<div class="fin-metric"><div class="fin-icon">üè¢</div><div class="fin-value">${finFormatRub(d.assets)}</div><div class="fin-label">–ê–∫—Ç–∏–≤—ã</div></div>`);
    }
    if (d.employees !== null && d.employees !== undefined) {
        const empDisplay = d.employees >= 1000 ? (d.employees / 1000).toFixed(1) + ' —Ç—ã—Å.' : String(d.employees);
        metrics.push(`<div class="fin-metric"><div class="fin-icon">üë•</div><div class="fin-value">${empDisplay}</div><div class="fin-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</div></div>`);
    }
    if (d.debt !== null && d.debt !== undefined && d.debt > 0) {
        metrics.push(`<div class="fin-metric negative"><div class="fin-icon">‚ö†Ô∏è</div><div class="fin-value">${finFormatRub(d.debt)}</div><div class="fin-label">–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</div></div>`);
    }

    const yearStr = d.year ? ` (${d.year})` : '';
    const sourceStr = d.source ? `<div class="fin-source">–ò—Å—Ç–æ—á–Ω–∏–∫: ${escHtml(d.source)}${yearStr}</div>` : '';

    // Additional details
    let detailsHtml = '';
    const details = [];
    if (d.inn) details.push(`<b>–ò–ù–ù:</b> ${escHtml(d.inn)}`);
    if (d.fullName && d.fullName !== d.name) details.push(`<b>–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ:</b> ${escHtml(d.fullName)}`);
    if (d.okved) details.push(`<b>–û–ö–í–≠–î:</b> ${escHtml(d.okved)}`);
    if (d.address) details.push(`<b>–ê–¥—Ä–µ—Å:</b> ${escHtml(d.address)}`);
    if (d.taxSystem) details.push(`<b>–°–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è:</b> ${escHtml(d.taxSystem)}`);
    if (d.status) {
        const statusMap = {ACTIVE:'–î–µ–π—Å—Ç–≤—É—é—â–∞—è', LIQUIDATING:'–õ–∏–∫–≤–∏–¥–∏—Ä—É–µ—Ç—Å—è', LIQUIDATED:'–õ–∏–∫–≤–∏–¥–∏—Ä–æ–≤–∞–Ω–∞', BANKRUPT:'–ë–∞–Ω–∫—Ä–æ—Ç', REORGANIZING:'–†–µ–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'};
        const statusText = statusMap[d.status] || d.status;
        const statusCls = d.status === 'ACTIVE' ? 'fin-status-active' : 'fin-status-warn';
        details.push(`<b>–°—Ç–∞—Ç—É—Å:</b> <span class="${statusCls}">${escHtml(statusText)}</span>`);
    }
    if (details.length > 0) {
        detailsHtml = `<details class="fin-snippets"><summary>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏</summary><div class="fin-details">${details.join('<br>')}</div></details>`;
    }

    return `
        <div class="fin-header">
            <h2>üìä ${escHtml(d.name || name)}</h2>
            <div class="fin-sub">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏${yearStr}</div>
        </div>
        ${metrics.length > 0 ? '<div class="fin-metrics">' + metrics.join('') + '</div>' : '<div class="fin-not-found">' + (d.checkoError === 'RATE_LIMIT' ? '‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Checko.ru (100/–¥–µ–Ω—å). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤—Ç—Ä–∞.' : d.checkoError === 'PAYMENT_REQUIRED' ? '‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞ —Ç–∞—Ä–∏—Ñ–∞ Checko.ru –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.' : d.checkoError === 'KEY_INVALID' ? '‚ö†Ô∏è –ö–ª—é—á Checko.ru –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API.' : d.checkoError === 'NO_KEY' ? '‚ö†Ô∏è –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API-–∫–ª—é—á Checko.ru' : d.checkoError ? '‚ö†Ô∏è –û—à–∏–±–∫–∞ Checko.ru: ' + escHtml(d.checkoError) : '–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ —Ä–µ–µ—Å—Ç—Ä–µ –§–ù–°') + '</div>'}
        ${sourceStr}
        ${detailsHtml}
        <div class="fm-actions" style="margin-top:14px">
            <button class="fm-cancel" id="fmCancel">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    `;
}

function finShowKeySetup(name) {
    const isAdmin = (() => {
        try { return JSON.parse(sessionStorage.getItem('vibeAuth') || '{}').role === 'admin'; } catch(e) { return false; }
    })();
    if (!isAdmin) {
        finOpenModal(`
            <div class="fin-header"><h2>üìä –§–∏–Ω–∞–Ω—Å—ã</h2></div>
            <div class="fin-not-found">
                <p>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å API-–∫–ª—é—á–∏.</p>
                <p>–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p>
            </div>
            <div class="fm-actions" style="margin-top:14px">
                <button class="fm-cancel" id="fmCancel">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        `);
        return;
    }
    finOpenModal(`
        <div class="fin-header"><h2>üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ API-–∫–ª—é—á–µ–π</h2></div>
        <div class="fin-key-setup">
            <p><b>1. DaData.ru</b> ‚Äî –ø–æ–∏—Å–∫ –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é (–ò–ù–ù, –∞–¥—Ä–µ—Å, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã)</p>
            <p style="font-size:12px;color:var(--dim)">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 10 000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å. <a href="https://dadata.ru/#registration_popup" target="_blank">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a> ‚Üí –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Üí API-–∫–ª—é—á–∏.</p>
            <label style="margin-top:8px;display:block">API-–∫–ª—é—á DaData</label>
            <input type="text" id="dadataKeyInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á DaData..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--text);font-size:14px;margin-top:4px">

            <p style="margin-top:16px"><b>2. Checko.ru</b> ‚Äî —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å (–≤—ã—Ä—É—á–∫–∞, –ø—Ä–∏–±—ã–ª—å, –∞–∫—Ç–∏–≤—ã)</p>
            <p style="font-size:12px;color:var(--dim)">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 100 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å. <a href="https://checko.ru/integration/api" target="_blank">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a> ‚Üí –ø–æ–ª—É—á–∏—Ç—å API-–∫–ª—é—á.</p>
            <label style="margin-top:8px;display:block">API-–∫–ª—é—á Checko</label>
            <input type="text" id="checkoKeyInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á Checko (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." style="width:100%;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--text);font-size:14px;margin-top:4px">

            <div style="margin-top:16px;padding:10px;border:1px solid var(--border);border-radius:8px;background:var(--hover-bg)">
                <p style="margin:0 0 6px"><b>3. LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã</b> ‚Äî AI-–∞–Ω–∞–ª–∏–∑ DPrice</p>
                <p style="font-size:11px;color:var(--dim);margin:0 0 8px">–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (—Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–æ–π):</p>
                <div style="display:flex;flex-direction:column;gap:6px">
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
                        <input type="radio" name="settingsLlmProvider" value="anthropic" ${dpActiveProvider === 'anthropic' ? 'checked' : ''} style="accent-color:var(--accent)">
                        <span style="width:110px"><b>Anthropic</b></span>
                        <input type="text" id="anthropicKeyInput2" placeholder="sk-ant-..." style="flex:1;padding:5px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:12px">
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
                        <input type="radio" name="settingsLlmProvider" value="openai" ${dpActiveProvider === 'openai' ? 'checked' : ''} style="accent-color:var(--accent)">
                        <span style="width:110px"><b>OpenAI</b></span>
                        <input type="text" id="openaiKeyInput2" placeholder="sk-..." style="flex:1;padding:5px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:12px">
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
                        <input type="radio" name="settingsLlmProvider" value="gemini" ${dpActiveProvider === 'gemini' ? 'checked' : ''} style="accent-color:var(--accent)">
                        <span style="width:110px"><b>Google Gemini</b></span>
                        <input type="text" id="geminiKeyInput2" placeholder="AI..." style="flex:1;padding:5px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:12px">
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
                        <input type="radio" name="settingsLlmProvider" value="grok" ${dpActiveProvider === 'grok' ? 'checked' : ''} style="accent-color:var(--accent)">
                        <span style="width:110px"><b>xAI Grok</b></span>
                        <input type="text" id="grokKeyInput2" placeholder="xai-..." style="flex:1;padding:5px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:12px">
                    </label>
                    <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer">
                        <input type="radio" name="settingsLlmProvider" value="ollama" ${dpActiveProvider === 'ollama' ? 'checked' : ''} style="accent-color:var(--accent)">
                        <span style="width:110px"><b>Ollama</b></span>
                        <input type="text" id="ollamaUrlInput2" placeholder="http://localhost:11434" style="flex:1;padding:5px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:12px">
                    </label>
                </div>
            </div>

            <div id="dadataKeyError" style="color:#e74c3c;font-size:12px;margin-top:8px;display:none"></div>
        </div>
        <div class="fm-actions" style="margin-top:14px">
            <button class="fm-ok" id="dadataKeySave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="fm-cancel" id="fmCancel">–û—Ç–º–µ–Ω–∞</button>
        </div>
    `);
    setTimeout(() => {
        const btn = document.getElementById('dadataKeySave');
        if (btn) btn.onclick = async () => {
            const dadataKey = document.getElementById('dadataKeyInput')?.value?.trim();
            const checkoKey = document.getElementById('checkoKeyInput')?.value?.trim();
            const anthropicKey = document.getElementById('anthropicKeyInput2')?.value?.trim();
            const openaiKey = document.getElementById('openaiKeyInput2')?.value?.trim();
            const geminiKey = document.getElementById('geminiKeyInput2')?.value?.trim();
            const grokKey = document.getElementById('grokKeyInput2')?.value?.trim();
            const ollamaUrl = document.getElementById('ollamaUrlInput2')?.value?.trim();
            const selectedProvider = document.querySelector('input[name="settingsLlmProvider"]:checked')?.value;
            if (!dadataKey || dadataKey.length < 10) {
                const errEl = document.getElementById('dadataKeyError');
                if (errEl) { errEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π API-–∫–ª—é—á DaData'; errEl.style.display = ''; }
                return;
            }
            btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            try {
                const creds = adminGetCallerCredentials();
                const resp = await gsFetch('set_dadata_key', { key: dadataKey, ...creds });
                if (resp && resp.ok) {
                    if (checkoKey && checkoKey.length >= 5) await gsFetch('set_checko_key', { key: checkoKey, ...creds });
                    if (anthropicKey) await gsFetch('set_anthropic_key', { key: anthropicKey, ...creds });
                    if (openaiKey) await gsFetch('set_openai_key', { key: openaiKey, ...creds });
                    if (geminiKey) await gsFetch('set_gemini_key', { key: geminiKey, ...creds });
                    if (grokKey) await gsFetch('set_grok_key', { key: grokKey, ...creds });
                    if (ollamaUrl) await gsFetch('set_ollama_url', { url: ollamaUrl, ...creds });
                    if (selectedProvider) {
                        await gsFetch('set_active_provider', { provider: selectedProvider, ...creds });
                        dpActiveProvider = selectedProvider;
                        localStorage.setItem('dp_provider', dpActiveProvider);
                        DP_MODELS = dpProviderModels[dpActiveProvider] || dpProviderModels.anthropic;
                    }
                    if (name) showFinanceModal(name);
                    else { closeFormModal(); document.getElementById('formModal')?.classList.remove('fin-modal'); }
                } else {
                    const errEl = document.getElementById('dadataKeyError');
                    if (errEl) { errEl.textContent = resp?.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'; errEl.style.display = ''; }
                    btn.disabled = false; btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            } catch(e) {
                const errEl = document.getElementById('dadataKeyError');
                if (errEl) { errEl.textContent = e.message; errEl.style.display = ''; }
                btn.disabled = false; btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        };
    }, 50);
}

async function showFinanceModal(name) {
    // Show loading state
    finOpenModal(`
        <div class="fin-header">
            <h2>üìä ${escHtml(name)}</h2>
            <div class="fin-sub">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
        <div class="fin-loading">
            <div class="fin-spinner"></div>
            <div style="margin-top:12px">–ó–∞–ø—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –∏–∑ DaData...</div>
        </div>
        <div class="fm-actions" style="margin-top:14px">
            <button class="fm-cancel" id="fmCancel">–û—Ç–º–µ–Ω–∞</button>
        </div>
    `);

    // Check cache
    if (finCache[name]) {
        finOpenModal(finRenderData(name, finCache[name]));
        return;
    }

    try {
        const resp = await gsFetch('get_finance', { name });
        if (resp && resp.ok && resp.data) {
            // Don't cache if Checko had an error (temporary, may work later)
            if (!resp.data.checkoError) finCache[name] = resp.data;
            finOpenModal(finRenderData(name, resp.data));
        } else {
            const err = resp?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            // Check if it's a missing key error
            if (err === 'NO_DADATA_KEY') {
                finShowKeySetup(name);
            } else if (err === 'DADATA_KEY_INVALID') {
                finOpenModal(`
                    <div class="fin-header"><h2>üìä ${escHtml(name)}</h2></div>
                    <div class="fin-not-found">
                        <p>API-–∫–ª—é—á DaData –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.</p>
                        <p><button class="fm-ok" onclick="finShowKeySetup('${escHtml(name).replace(/'/g,"\\'")}')">–û–±–Ω–æ–≤–∏—Ç—å –∫–ª—é—á</button></p>
                    </div>
                    <div class="fm-actions" style="margin-top:14px">
                        <button class="fm-cancel" id="fmCancel">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `);
            } else {
                finOpenModal(`
                    <div class="fin-header"><h2>üìä ${escHtml(name)}</h2></div>
                    <div class="fin-not-found">
                        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: ${escHtml(err)}</p>
                        <p><a href="https://www.google.com/search?q=${encodeURIComponent(name + ' –≤—ã—Ä—É—á–∫–∞ –ø—Ä–∏–±—ã–ª—å')}" target="_blank">–ò—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –≤ Google ‚Üí</a></p>
                    </div>
                    <div class="fm-actions" style="margin-top:14px">
                        <button class="fm-cancel" id="fmCancel">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `);
            }
        }
    } catch(e) {
        const errMsg = e.message || '';
        if (errMsg === 'NO_DADATA_KEY') {
            finShowKeySetup(name);
        } else {
            finOpenModal(`
                <div class="fin-header"><h2>üìä ${escHtml(name)}</h2></div>
                <div class="fin-not-found">
                    <p>–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${escHtml(errMsg)}</p>
                    <p><a href="https://www.google.com/search?q=${encodeURIComponent(name + ' –≤—ã—Ä—É—á–∫–∞ –ø—Ä–∏–±—ã–ª—å')}" target="_blank">–ò—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é –≤ Google ‚Üí</a></p>
                </div>
                <div class="fm-actions" style="margin-top:14px">
                    <button class="fm-cancel" id="fmCancel">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `);
        }
    }
}

// ===== DPrice AI Scoring =====
const DP_LS_KEY = 'vibeMarketing_dpCache';
const dpCache = (() => {
    try { return JSON.parse(localStorage.getItem(DP_LS_KEY) || '{}'); } catch(e) { return {}; }
})();
function dpSaveCache() {
    try { localStorage.setItem(DP_LS_KEY, JSON.stringify(dpCache)); } catch(e) {}
}
const LLM_PROVIDERS = {
    anthropic: { label: 'Anthropic Claude', keyAction: 'set_anthropic_key', keyPlaceholder: 'sk-ant-...', keyUrl: 'https://console.anthropic.com/settings/keys' },
    openai:    { label: 'OpenAI ChatGPT', keyAction: 'set_openai_key', keyPlaceholder: 'sk-...', keyUrl: 'https://platform.openai.com/api-keys' },
    gemini:    { label: 'Google Gemini', keyAction: 'set_gemini_key', keyPlaceholder: 'AI...', keyUrl: 'https://aistudio.google.com/app/apikey' },
    grok:      { label: 'xAI Grok', keyAction: 'set_grok_key', keyPlaceholder: 'xai-...', keyUrl: 'https://console.x.ai/' },
    ollama:    { label: 'Ollama (–ª–æ–∫–∞–ª—å–Ω—ã–π)', keyAction: 'set_ollama_url', keyPlaceholder: 'http://localhost:11434', keyUrl: 'https://ollama.com' }
};
let dpActiveProvider = localStorage.getItem('dp_provider') || 'anthropic';
let dpProviderModels = {
    anthropic: [
        { id: 'claude-sonnet-4-6', label: 'Claude Sonnet 4.6' },
        { id: 'claude-opus-4-6', label: 'Claude Opus 4.6' },
        { id: 'claude-haiku-4-5-20251001', label: 'Claude Haiku 4.5' }
    ],
    openai: [
        { id: 'gpt-4o', label: 'GPT-4o' },
        { id: 'gpt-4o-mini', label: 'GPT-4o Mini' },
        { id: 'o3-mini', label: 'o3-mini' }
    ],
    gemini: [
        { id: 'gemini-2.5-pro-preview-06-05', label: 'Gemini 2.5 Pro' },
        { id: 'gemini-2.5-flash-preview-05-20', label: 'Gemini 2.5 Flash' },
        { id: 'gemini-2.0-flash', label: 'Gemini 2.0 Flash' }
    ],
    grok: [
        { id: 'grok-3', label: 'Grok 3' },
        { id: 'grok-3-mini', label: 'Grok 3 Mini' }
    ],
    ollama: [
        { id: 'llama3.1', label: 'Llama 3.1' },
        { id: 'mistral', label: 'Mistral' },
        { id: 'qwen2.5', label: 'Qwen 2.5' }
    ]
};
let DP_MODELS = dpProviderModels[dpActiveProvider] || dpProviderModels.anthropic;
function dpGetDefaultModel() {
    const d = { anthropic:'claude-sonnet-4-6', openai:'gpt-4o', gemini:'gemini-2.0-flash', grok:'grok-3', ollama:'llama3.1' };
    return d[dpActiveProvider] || 'claude-sonnet-4-6';
}

function dpScoreColor(score) {
    if (score <= 3) return '#e74c3c';
    if (score <= 6) return '#f39c12';
    return '#27ae60';
}

function dpRenderScore(name, data) {
    const score = parseFloat(data.dprice) || 0;
    const color = dpScoreColor(score);
    const circumference = 2 * Math.PI * 52;
    const offset = circumference - (score / 10) * circumference;

    let factorsHtml = '';
    if (data.factors) {
        const factorNames = {
            financial_stability: '–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å',
            innovation_readiness: '–í–æ—Å–ø—Ä–∏–∏–º—á–∏–≤–æ—Å—Ç—å –∫ –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º',
            business_aggressiveness: '–ë–∏–∑–Ω–µ—Å-–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å',
            management_activity: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞',
            digital_presence: '–¶–∏—Ñ—Ä–æ–≤–æ–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ',
            dynamic_pricing_experience: '–û–ø—ã—Ç –¥–∏–Ω–∞–º–∏—á. —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è',
            it_team_strength: '–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ò–¢-–∫–æ–º–∞–Ω–¥–∞'
        };
        for (const [key, factor] of Object.entries(data.factors)) {
            const fname = factorNames[key] || key;
            const fs = parseFloat(factor.score) || 0;
            const fc = dpScoreColor(fs);
            const pct = fs * 10;
            factorsHtml += `
                <div class="dp-factor">
                    <div class="dp-factor-name">${escHtml(fname)}
                        ${factor.comment ? `<div class="dp-factor-comment">${escHtml(factor.comment)}</div>` : ''}
                    </div>
                    <div class="dp-factor-score" style="color:${fc}">${fs.toFixed(1)}</div>
                    <div class="dp-factor-bar"><div class="dp-factor-bar-fill" style="width:${pct}%;background:${fc}"></div></div>
                </div>`;
        }
    }

    const summaryHtml = data.summary ? `<div class="dp-summary">${escHtml(data.summary)}</div>` : '';
    const recHtml = data.recommendation ? `<div class="dp-recommendation">${escHtml(data.recommendation)}</div>` : '';
    const allModels = Object.values(dpProviderModels).flat();
    const modelLabel = allModels.find(m => m.id === data.model)?.label || data.model || '';
    const providerLabel = LLM_PROVIDERS[data.provider]?.label || data.provider || 'AI';

    return `
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px">
            <div class="fin-header" style="margin:0">
                <h2>üéØ DPrice: ${escHtml(name)}</h2>
                <div class="fin-sub">AI-–æ—Ü–µ–Ω–∫–∞ –≤–æ—Å–ø—Ä–∏–∏–º—á–∏–≤–æ—Å—Ç–∏ –∫ DPrice${modelLabel ? ' (' + escHtml(modelLabel) + ')' : ''}</div>
            </div>
            <button class="fm-ok" id="fmCancel" style="flex-shrink:0;padding:5px 18px;font-size:12px">OK</button>
        </div>
        <div class="dp-score-ring">
            <svg viewBox="0 0 120 120">
                <circle class="dp-ring-bg" cx="60" cy="60" r="52"/>
                <circle class="dp-ring-fg" cx="60" cy="60" r="52"
                    stroke="${color}" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/>
            </svg>
            <div class="dp-score-num">${score.toFixed(1)}<small>/10</small></div>
        </div>
        <div class="dp-factors">${factorsHtml}</div>
        ${summaryHtml}
        ${recHtml}
        <div class="fin-source">
            –ê–Ω–∞–ª–∏–∑: ${escHtml(providerLabel)} | <a href="https://dprice.ru" target="_blank">dprice.ru</a>
            ${data._sources ? `<br>–ò—Å—Ç–æ—á–Ω–∏–∫–∏: —Ñ–∏–Ω–∞–Ω—Å—ã ${data._sources.finance ? '‚úÖ' : '‚ùå'} ¬∑ —Å–∞–π—Ç ${data._sources.website > 0 ? '‚úÖ ' + data._sources.website + ' –∑–Ω.' : '‚ùå'} ¬∑ –Ω–æ–≤–æ—Å—Ç–∏ ${data._sources.news > 0 ? '‚úÖ ' + data._sources.news + ' –∑–Ω.' : '‚ùå –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}${data._sources.context > 0 ? ' ¬∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚úÖ' : ''}` : ''}
        </div>
    `;
}

function dpOpenModal(html) {
    const modal = document.getElementById('formModal');
    modal.classList.add('fin-modal', 'dp-modal');
    showFormModal(html);
    const closeBtn = document.getElementById('fmCancel');
    const closeFn = () => { modal.classList.remove('fin-modal', 'dp-modal'); closeFormModal(); };
    if (closeBtn) closeBtn.onclick = closeFn;
    // Strict modal: only close via button, not overlay click
    modal.onclick = e => { e.stopPropagation(); };
}

async function dpFetchModels() {
    try {
        const resp = await gsFetch('list_models', { provider: dpActiveProvider });
        if (resp && resp.ok && resp.models) {
            let filtered = resp.models.map(m => ({ id: m.id, label: m.label || m.id }));
            if (dpActiveProvider === 'anthropic') {
                filtered = filtered.filter(m => !m.id.includes('haiku-3') && !m.id.includes('claude-2') && !m.id.includes('claude-1'));
            }
            if (filtered.length === 0) filtered = [{ id: dpGetDefaultModel(), label: dpGetDefaultModel() }];
            dpProviderModels[dpActiveProvider] = filtered;
            DP_MODELS = filtered;
            return true;
        }
        return false;
    } catch(e) { return false; }
}

function dpUpdateModelSelect(selectId) {
    DP_MODELS = dpProviderModels[dpActiveProvider] || dpProviderModels.anthropic;
    const sel = document.getElementById(selectId);
    if (sel) {
        sel.innerHTML = DP_MODELS.map((m, i) =>
            `<option value="${m.id}"${i === 0 ? ' selected' : ''}>${escHtml(m.label)}</option>`
        ).join('');
    }
}

function dpProviderRadioHtml() {
    return Object.entries(LLM_PROVIDERS).map(([key, p]) =>
        `<label style="display:inline-flex;align-items:center;gap:4px;font-size:11px;cursor:pointer;padding:3px 8px;border-radius:4px;transition:background .15s">
            <input type="radio" name="dpProvider" value="${key}" ${key === dpActiveProvider ? 'checked' : ''} style="accent-color:var(--accent)">
            ${escHtml(p.label)}
        </label>`
    ).join('');
}

function dpBindProviderRadio(modelSelectId) {
    document.querySelectorAll('input[name="dpProvider"]').forEach(radio => {
        radio.onchange = () => {
            dpActiveProvider = radio.value;
            localStorage.setItem('dp_provider', dpActiveProvider);
            dpUpdateModelSelect(modelSelectId);
        };
    });
}

async function showDPriceModal(name) {
    DP_MODELS = dpProviderModels[dpActiveProvider] || dpProviderModels.anthropic;
    const modelOptions = DP_MODELS.map((m, i) =>
        `<option value="${m.id}"${i === 0 ? ' selected' : ''}>${escHtml(m.label)}</option>`
    ).join('');

    dpOpenModal(`
        <div class="fin-header" style="margin-bottom:10px">
            <h2>üéØ DPrice: ${escHtml(name)}</h2>
            <div class="fin-sub">AI-–æ—Ü–µ–Ω–∫–∞ –≤–æ—Å–ø—Ä–∏–∏–º—á–∏–≤–æ—Å—Ç–∏ –∫ –ø—Ä–æ–¥—É–∫—Ç—É DPrice</div>
        </div>
        <div style="margin-bottom:8px;padding:6px 8px;background:var(--hover-bg);border-radius:6px">
            <div style="font-size:10px;font-weight:600;color:var(--dim);margin-bottom:4px">LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä:</div>
            <div style="display:flex;flex-wrap:wrap;gap:4px 10px">${dpProviderRadioHtml()}</div>
        </div>
        <div class="dp-model-select">
            <label>–ú–æ–¥–µ–ª—å:</label>
            <select id="dpModelSelect">${modelOptions}</select>
            <button class="fm-ok" id="dpRunBtn" style="padding:4px 14px;font-size:12px">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            <button id="dpRefreshModelsBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏" style="padding:3px 8px;font-size:12px;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--dim);cursor:pointer">üîÑ</button>
        </div>
        <div style="margin-bottom:8px">
            <label style="font-size:11px;font-weight:600;color:var(--dim);display:block;margin-bottom:3px">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
            <textarea id="dpCustomContext" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∫–æ–º–ø–∞–Ω–∏—è –Ω–µ–¥–∞–≤–Ω–æ –≤–Ω–µ–¥—Ä–∏–ª–∞ BIM, —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω–æ –∏—â–µ—Ç IT-—Ä–µ—à–µ–Ω–∏—è, –µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç —Å CTO..." style="width:100%;min-height:50px;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--text);font-size:11px;resize:vertical;font-family:inherit"></textarea>
            <div style="font-size:10px;color:var(--dim);margin-top:1px">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–µ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–µ DPrice –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞</div>
        </div>
        <div id="dpResultArea">
            <div class="fin-not-found" style="padding:14px 0">
                <p>–ù–∞–∂–º–∏—Ç–µ ¬´–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å¬ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞.</p>
                <p style="font-size:11px;color:var(--dim)">AI –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ñ–∏–Ω–∞–Ω—Å—ã, —Å–∞–π—Ç –∏ –Ω–æ–≤–æ—Å—Ç–∏ –∫–æ–º–ø–∞–Ω–∏–∏.</p>
            </div>
        </div>
        <div class="fm-actions" style="margin-top:10px">
            <button class="fm-ok" id="fmCancel">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    `);

    setTimeout(() => {
        dpBindProviderRadio('dpModelSelect');
        const runBtn = document.getElementById('dpRunBtn');
        if (runBtn) runBtn.onclick = () => dpRunAnalysis(name);
        const refreshBtn = document.getElementById('dpRefreshModelsBtn');
        if (refreshBtn) refreshBtn.onclick = async () => {
            refreshBtn.disabled = true;
            refreshBtn.textContent = '‚è≥';
            const ok = await dpFetchModels();
            if (ok) {
                dpUpdateModelSelect('dpModelSelect');
                refreshBtn.textContent = '‚úÖ';
                setTimeout(() => { refreshBtn.textContent = 'üîÑ'; refreshBtn.disabled = false; }, 1500);
            } else {
                refreshBtn.textContent = '‚ùå';
                setTimeout(() => { refreshBtn.textContent = 'üîÑ'; refreshBtn.disabled = false; }, 2000);
            }
        };
    }, 50);
}

async function dpRunAnalysis(name) {
    const modelSelect = document.getElementById('dpModelSelect');
    const model = modelSelect ? modelSelect.value : (DP_MODELS[0]?.id || dpGetDefaultModel());
    const contextInput = document.getElementById('dpCustomContext');
    const customContext = contextInput ? contextInput.value.trim() : '';
    const resultArea = document.getElementById('dpResultArea');
    if (!resultArea) return;

    // Check cache (include provider in key)
    const cacheKey = name + '|' + dpActiveProvider + '|' + model + '|' + customContext;
    if (dpCache[cacheKey]) {
        dpOpenModal(dpRenderScore(name, dpCache[cacheKey]));
        return;
    }

    const provLabel = LLM_PROVIDERS[dpActiveProvider]?.label || dpActiveProvider;
    resultArea.innerHTML = `
        <div class="fin-loading">
            <div class="fin-spinner"></div>
            <div style="margin-top:12px">–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏ –∞–Ω–∞–ª–∏–∑ (${escHtml(provLabel)})...<br><span style="font-size:11px;color:var(--dim)">–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 15-30 —Å–µ–∫—É–Ω–¥</span></div>
        </div>
    `;

    try {
        const params = { name, model, provider: dpActiveProvider };
        if (customContext) params.context = customContext;
        const resp = await gsFetch('dprice_score', params);
        if (resp && resp.ok && resp.data) {
            resp.data.model = model;
            resp.data.provider = dpActiveProvider;
            dpCache[cacheKey] = resp.data;
            dpSaveCache();
            dpOpenModal(dpRenderScore(name, resp.data));
        } else {
            const err = resp?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            if (err.startsWith('NO_') && err.endsWith('_KEY')) {
                dpShowLLMKeySetup(name);
            } else {
                resultArea.innerHTML = `<div class="fin-not-found"><p>–û—à–∏–±–∫–∞: ${escHtml(err)}</p></div>`;
            }
        }
    } catch(e) {
        if (e.message && e.message.startsWith('NO_') && e.message.endsWith('_KEY')) {
            dpShowLLMKeySetup(name);
        } else {
            resultArea.innerHTML = `<div class="fin-not-found"><p>–û—à–∏–±–∫–∞: ${escHtml(e.message)}</p></div>`;
        }
    }
}

function dpShowKeySetup(name) { dpShowLLMKeySetup(name); }

function dpShowLLMKeySetup(name) {
    const isAdmin = (() => {
        try { return JSON.parse(sessionStorage.getItem('vibeAuth') || '{}').role === 'admin'; } catch(e) { return false; }
    })();
    if (!isAdmin) {
        dpOpenModal(`
            <div class="fin-header"><h2>üéØ DPrice</h2></div>
            <div class="fin-not-found"><p>–î–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º API-–∫–ª—é—á. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.</p></div>
            <div class="fm-actions" style="margin-top:10px"><button class="fm-ok" id="fmCancel">OK</button></div>
        `);
        return;
    }
    const providers = [
        { id:'anthropic', name:'Anthropic Claude', url:'https://console.anthropic.com/settings/keys', inputId:'llmKeyAnthropic', ph:'sk-ant-...' },
        { id:'openai', name:'OpenAI ChatGPT', url:'https://platform.openai.com/api-keys', inputId:'llmKeyOpenai', ph:'sk-...' },
        { id:'gemini', name:'Google Gemini', url:'https://aistudio.google.com/app/apikey', inputId:'llmKeyGemini', ph:'AI...' },
        { id:'grok', name:'xAI Grok', url:'https://console.x.ai/', inputId:'llmKeyGrok', ph:'xai-...' },
        { id:'ollama', name:'Ollama (–ª–æ–∫–∞–ª—å–Ω—ã–π)', url:'https://ollama.com', inputId:'llmUrlOllama', ph:'http://localhost:11434' }
    ];
    const inputsHtml = providers.map(p => `
        <div style="margin-top:8px;padding:8px;border:1px solid var(--border);border-radius:6px;background:var(--hover-bg)">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12px">
                <input type="radio" name="llmActiveProvider" value="${p.id}" ${p.id === dpActiveProvider ? 'checked' : ''} style="accent-color:var(--accent)">
                <b>${p.name}</b>
            </label>
            <div style="font-size:10px;color:var(--dim);margin:2px 0 4px 22px"><a href="${p.url}" target="_blank">–ü–æ–ª—É—á–∏—Ç—å –∫–ª—é—á ‚Üí</a></div>
            <input type="text" id="${p.inputId}" placeholder="${p.ph}" style="width:100%;padding:6px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:12px">
        </div>
    `).join('');

    dpOpenModal(`
        <div class="fin-header"><h2>üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤</h2></div>
        <div class="fin-key-setup">
            <p style="font-size:12px;color:var(--dim)">–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á–∏ –¥–ª—è –Ω—É–∂–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–∏–≤–Ω—ã–π:</p>
            ${inputsHtml}
            <div id="llmKeyError" style="color:#e74c3c;font-size:12px;margin-top:8px;display:none"></div>
        </div>
        <div class="fm-actions" style="margin-top:14px">
            <button class="fm-ok" id="llmKeySave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="fm-cancel" id="fmCancel">–û—Ç–º–µ–Ω–∞</button>
        </div>
    `);
    setTimeout(() => {
        const btn = document.getElementById('llmKeySave');
        if (btn) btn.onclick = async () => {
            btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
            try {
                const creds = adminGetCallerCredentials();
                const selectedProvider = document.querySelector('input[name="llmActiveProvider"]:checked')?.value || 'anthropic';
                const anthropicKey = document.getElementById('llmKeyAnthropic')?.value?.trim();
                const openaiKey = document.getElementById('llmKeyOpenai')?.value?.trim();
                const geminiKey = document.getElementById('llmKeyGemini')?.value?.trim();
                const grokKey = document.getElementById('llmKeyGrok')?.value?.trim();
                const ollamaUrl = document.getElementById('llmUrlOllama')?.value?.trim();

                if (anthropicKey) await gsFetch('set_anthropic_key', { key: anthropicKey, ...creds });
                if (openaiKey) await gsFetch('set_openai_key', { key: openaiKey, ...creds });
                if (geminiKey) await gsFetch('set_gemini_key', { key: geminiKey, ...creds });
                if (grokKey) await gsFetch('set_grok_key', { key: grokKey, ...creds });
                if (ollamaUrl) await gsFetch('set_ollama_url', { url: ollamaUrl, ...creds });
                await gsFetch('set_active_provider', { provider: selectedProvider, ...creds });

                dpActiveProvider = selectedProvider;
                localStorage.setItem('dp_provider', dpActiveProvider);
                DP_MODELS = dpProviderModels[dpActiveProvider] || dpProviderModels.anthropic;

                if (name) showDPriceModal(name);
                else { closeFormModal(); document.getElementById('formModal')?.classList.remove('fin-modal', 'dp-modal'); }
            } catch(e) {
                const errEl = document.getElementById('llmKeyError');
                if (errEl) { errEl.textContent = e.message; errEl.style.display = ''; }
                btn.disabled = false; btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            }
        };
    }, 50);
}

// ===== Batch DPrice Analysis =====
let dpBatchRunning = false;

function dpGetCachedScore(name) {
    // Prefer cache from current provider
    for (const key of Object.keys(dpCache)) {
        if (key.startsWith(name + '|' + dpActiveProvider + '|')) return dpCache[key];
    }
    // Fall back to any provider
    for (const key of Object.keys(dpCache)) {
        if (key.startsWith(name + '|')) return dpCache[key];
    }
    return null;
}

function dpBatchStart() {
    if (!curData || !curData.companies || curData.companies.length === 0) {
        alert('–ù–µ—Ç –∫–æ–º–ø–∞–Ω–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞');
        return;
    }
    if (dpBatchRunning) {
        alert('–ê–Ω–∞–ª–∏–∑ —É–∂–µ –∑–∞–ø—É—â–µ–Ω');
        return;
    }
    DP_MODELS = dpProviderModels[dpActiveProvider] || dpProviderModels.anthropic;
    const modelOptions = DP_MODELS.map((m, i) =>
        `<option value="${m.id}"${i === 0 ? ' selected' : ''}>${escHtml(m.label)}</option>`
    ).join('');

    dpOpenModal(`
        <div class="fin-header" style="margin-bottom:10px">
            <h2>üéØ DPrice ‚Äî –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π</h2>
            <div class="fin-sub">–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π AI-–∞–Ω–∞–ª–∏–∑ ${curData.companies.length} –∫–æ–º–ø–∞–Ω–∏–π</div>
        </div>
        <div style="margin-bottom:8px;padding:6px 8px;background:var(--hover-bg);border-radius:6px">
            <div style="font-size:10px;font-weight:600;color:var(--dim);margin-bottom:4px">LLM-–ø—Ä–æ–≤–∞–π–¥–µ—Ä:</div>
            <div style="display:flex;flex-wrap:wrap;gap:4px 10px">${dpProviderRadioHtml()}</div>
        </div>
        <div class="dp-model-select">
            <label>–ú–æ–¥–µ–ª—å:</label>
            <select id="dpBatchModelSelect">${modelOptions}</select>
            <button id="dpBatchRefreshBtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏" style="padding:3px 8px;font-size:12px;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--dim);cursor:pointer">üîÑ</button>
        </div>
        <div style="font-size:11px;color:var(--dim);text-align:center;margin-bottom:10px">–ê–Ω–∞–ª–∏–∑ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç</div>
        <div class="fm-actions" style="margin-top:10px">
            <button class="fm-cancel" id="fmCancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="fm-ok" id="dpBatchRunBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
    `);

    setTimeout(() => {
        dpBindProviderRadio('dpBatchModelSelect');
        const runBtn = document.getElementById('dpBatchRunBtn');
        if (runBtn) runBtn.onclick = () => {
            const sel = document.getElementById('dpBatchModelSelect');
            const model = sel ? sel.value : DP_MODELS[0].id;
            closeFormModal();
            document.getElementById('formModal')?.classList.remove('fin-modal', 'dp-modal');
            dpBatchAnalysis(model);
        };
        const refreshBtn = document.getElementById('dpBatchRefreshBtn');
        if (refreshBtn) refreshBtn.onclick = async () => {
            refreshBtn.disabled = true; refreshBtn.textContent = '‚è≥';
            const ok = await dpFetchModels();
            if (ok) {
                dpUpdateModelSelect('dpBatchModelSelect');
                refreshBtn.textContent = '‚úÖ';
                setTimeout(() => { refreshBtn.textContent = 'üîÑ'; refreshBtn.disabled = false; }, 1500);
            } else {
                refreshBtn.textContent = '‚ùå';
                setTimeout(() => { refreshBtn.textContent = 'üîÑ'; refreshBtn.disabled = false; }, 2000);
            }
        };
    }, 50);
}

async function dpBatchAnalysis(model) {
    const companies = curData.companies;
    const total = companies.length;

    const overlay = document.createElement('div');
    overlay.className = 'dp-batch-overlay';
    overlay.innerHTML = `
        <div class="dp-batch-box">
            <h3>üéØ DPrice ‚Äî –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –∫–æ–º–ø–∞–Ω–∏–π</h3>
            <div class="dp-batch-counter"><span id="dpBatchCur">1</span> / ${total}</div>
            <div class="dp-batch-progress"><div class="dp-batch-progress-fill" id="dpBatchBar" style="width:0%"></div></div>
            <div class="dp-batch-current" id="dpBatchName">${escHtml(companies[0].name)}</div>
            <div style="margin-top:16px">
                <button class="fm-cancel" id="dpBatchCancel" style="padding:6px 20px;border-radius:6px;font-size:12px;cursor:pointer;border:1px solid var(--border);background:var(--panel);color:var(--dim)">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
            </div>
        </div>
    `;
    document.body.appendChild(overlay);

    dpBatchRunning = true;
    let cancelled = false;
    document.getElementById('dpBatchCancel').onclick = () => { cancelled = true; };

    const barEl = document.getElementById('dpBatchBar');
    const curEl = document.getElementById('dpBatchCur');
    const nameEl = document.getElementById('dpBatchName');
    let errors = 0;

    for (let i = 0; i < total; i++) {
        if (cancelled) break;
        const name = companies[i].name;
        const cacheKey = name + '|' + dpActiveProvider + '|' + model + '|';

        curEl.textContent = i + 1;
        nameEl.textContent = name;
        barEl.style.width = ((i / total) * 100) + '%';

        if (dpCache[cacheKey]) continue;

        try {
            console.log('[DPBatch] Analyzing:', name, 'provider:', dpActiveProvider, 'model:', model);
            const resp = await gsFetch('dprice_score', { name, model, provider: dpActiveProvider });
            if (resp && resp.ok && resp.data) {
                resp.data.model = model;
                resp.data.provider = dpActiveProvider;
                dpCache[cacheKey] = resp.data;
                dpSaveCache();
            } else {
                errors++;
            }
        } catch(e) {
            errors++;
        }

        if (i < total - 1 && !cancelled) {
            await new Promise(r => setTimeout(r, 1000));
        }
    }

    dpBatchRunning = false;
    barEl.style.width = '100%';
    curEl.textContent = total;
    nameEl.textContent = cancelled ? '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ' : `–ì–æ—Ç–æ–≤–æ!${errors ? ' (–æ—à–∏–±–æ–∫: ' + errors + ')' : ''}`;
    const cancelBtn = document.getElementById('dpBatchCancel');
    cancelBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
    cancelBtn.onclick = () => {
        overlay.remove();
        if (currentView === 'companies') buildCompaniesView();
    };
}

function openEditCompanyModal(idx) {
    const co = curData.companies[idx];
    if (!co) return;
    const oldName = co.name;
    showFormModal(`
        <h2>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</h2>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
        <input type="text" id="fmCoName" value="${co.name.replace(/"/g, '&quot;')}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <label>–†–µ–≥–∏–æ–Ω</label>
        <input type="text" id="fmCoRegion" value="${(co.region || '').replace(/"/g, '&quot;')}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞">
        <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
        <input type="text" id="fmCoContact" value="${(co.contact || '').replace(/"/g, '&quot;')}" placeholder="–§–ò–û">
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <input type="text" id="fmCoPos" value="${(co.pos || '').replace(/"/g, '&quot;')}" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
        <div class="fm-actions">
            <button class="fm-cancel" id="fmCancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="fm-ok" id="fmOk">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    `);

    document.getElementById('fmCancel').onclick = closeFormModal;
    document.getElementById('fmOk').onclick = () => {
        const name = document.getElementById('fmCoName').value.trim();
        if (!name) { document.getElementById('fmCoName').style.borderColor = 'var(--error-border)'; return; }
        // Check duplicate (only if name changed)
        if (name !== oldName && curData.companies.some(c => c.name === name)) {
            document.getElementById('fmCoName').style.borderColor = 'var(--error-border)';
            document.getElementById('fmCoName').value = '';
            document.getElementById('fmCoName').placeholder = '–¢–∞–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è —É–∂–µ –µ—Å—Ç—å!';
            return;
        }
        const region = document.getElementById('fmCoRegion').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω';
        const contact = document.getElementById('fmCoContact').value.trim();
        const pos = document.getElementById('fmCoPos').value.trim();

        // Update activities if name changed
        if (name !== oldName) {
            curData.activities.forEach(a => {
                if (a.company === oldName) a.company = name;
            });
            // Update logo cache
            if (logoCache[oldName]) {
                logoCache[name] = logoCache[oldName];
                delete logoCache[oldName];
            } else {
                logoCache[name] = generateInitialsLogo(name);
            }
        }

        co.name = name;
        co.region = region;
        co.contact = contact;
        co.pos = pos;

        markDirty();
        build(curData, true);
        rebuildCurrentView();
        closeFormModal();
    };
}

function openAddCompanyModal() {
    showFormModal(`
        <h2>+ –ù–æ–≤–∞—è –∫–æ–º–ø–∞–Ω–∏—è</h2>
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</label>
        <input type="text" id="fmCoName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <label>–†–µ–≥–∏–æ–Ω</label>
        <input type="text" id="fmCoRegion" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞">
        <label>–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</label>
        <input type="text" id="fmCoContact" placeholder="–§–ò–û">
        <label>–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
        <input type="text" id="fmCoPos" placeholder="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
        <div class="fm-actions">
            <button class="fm-cancel" id="fmCancel">–û—Ç–º–µ–Ω–∞</button>
            <button class="fm-ok" id="fmOk">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    `);

    document.getElementById('fmCancel').onclick = closeFormModal;
    document.getElementById('fmOk').onclick = () => {
        const name = document.getElementById('fmCoName').value.trim();
        if (!name) { document.getElementById('fmCoName').style.borderColor = 'var(--error-border)'; return; }
        if (!curData) return;
        // Check duplicate
        if (curData.companies.some(c => c.name === name)) {
            document.getElementById('fmCoName').style.borderColor = 'var(--error-border)';
            document.getElementById('fmCoName').value = '';
            document.getElementById('fmCoName').placeholder = '–¢–∞–∫–∞—è –∫–æ–º–ø–∞–Ω–∏—è —É–∂–µ –µ—Å—Ç—å!';
            return;
        }
        const region = document.getElementById('fmCoRegion').value.trim() || '–ù–µ —É–∫–∞–∑–∞–Ω';
        const contact = document.getElementById('fmCoContact').value.trim();
        const pos = document.getElementById('fmCoPos').value.trim();

        curData.companies.push({ name, region, contact, pos });
        // Generate logo
        logoCache[name] = generateInitialsLogo(name);

        markDirty();
        build(curData, true);
        rebuildCurrentView();
        closeFormModal();
    };
}

// Wire +–ú and +–ö buttons
document.getElementById('bAddEvent').onclick = openAddEventModal;
document.getElementById('bAddCompany').onclick = () => {
    if (!curData) return;
    openAddCompanyModal();
};

// ============================
// EVENTS VIEW
// ============================
function buildEventsView() {
    const ve = document.getElementById('viewEvents');
    const acts = curData ? curData.activities : [];
    let html = '<div class="list-view"><h2>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è</h2>';

    EVENTS_META.forEach((em, idx) => {
        const coSet = new Set();
        acts.filter(a => a.event === em.name).forEach(a => coSet.add(a.company));
        const coCount = coSet.size;
        const durLabel = em.duration >= 99 ? '–ø–æ—Å—Ç–æ—è–Ω–Ω–æ' : em.duration + ' –Ω–µ–¥.';
        const notes = em.notes || '';

        html += `<div class="lv-card">`;
        html += `<div class="lv-color" style="background:${em.color}"></div>`;
        html += `<div class="lv-body">`;
        html += `<div class="lv-title">${em.name}</div>`;
        html += `<div class="lv-meta">–ù–∞—á–∞–ª–æ: <b>${em.weekStart + 1}w</b> ¬∑ –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <b>${durLabel}</b> ¬∑ –ö–æ–º–ø–∞–Ω–∏–π: <b>${coCount}</b></div>`;
        html += `<textarea class="lv-notes" data-ev-idx="${idx}" placeholder="–ó–∞–º–µ—Ç–∫–∏...">${notes}</textarea>`;
        html += `</div>`;
        html += `<div class="lv-actions">`;
        html += `<button class="lv-del" data-ev-del="${idx}">–£–¥–∞–ª–∏—Ç—å</button>`;
        html += `</div>`;
        html += `</div>`;
    });

    html += `<button class="lv-add-btn" id="evAddBtn">+ –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ</button>`;
    html += '</div>';
    ve.innerHTML = html;

    // Wire events
    ve.querySelectorAll('.lv-notes[data-ev-idx]').forEach(ta => {
        ta.addEventListener('blur', () => {
            const i = parseInt(ta.dataset.evIdx);
            if (EVENTS_META[i]) { EVENTS_META[i].notes = ta.value; markDirty(); }
        });
    });
    ve.querySelectorAll('[data-ev-del]').forEach(btn => {
        btn.onclick = () => {
            const i = parseInt(btn.dataset.evDel);
            const em = EVENTS_META[i];
            if (!em) return;
            customConfirm(`–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ ¬´${em.name}¬ª –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ.\n–ö–æ–º–ø–∞–Ω–∏–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º, –ø–æ—Ç–µ—Ä—è—é—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.`, '–£–¥–∞–ª–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ?').then(ok => {
                if (!ok) return;
                // Remove activities linked to this event
                if (curData) {
                    curData.activities = curData.activities.filter(a => a.event !== em.name);
                }
                EVENTS_META.splice(i, 1);
                rebuildEventsDerived();
                markDirty();
                if (curData) build(curData, true);
                buildEventsView();
            });
        };
    });
    const addBtn = document.getElementById('evAddBtn');
    if (addBtn) addBtn.onclick = () => { openAddEventModal(); };
}

// ============================
// COMPANIES VIEW
// ============================
function buildCompaniesView() {
    const vc = document.getElementById('viewCompanies');
    if (!curData) { vc.innerHTML = '<div class="list-view"><h2>–ö–æ–º–ø–∞–Ω–∏–∏</h2><p style="color:var(--dim)">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</p></div>'; return; }
    const { companies, activities } = curData;

    let html = '<div class="list-view"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px"><h2 style="margin:0">–ö–æ–º–ø–∞–Ω–∏–∏</h2><button class="btn lv-dprice" id="dpBatchStartBtn" style="padding:5px 14px;font-size:12px">üéØ DPrice ‚Äî –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö</button></div>';

    companies.forEach((co, idx) => {
        const coActs = activities.filter(a => a.company === co.name).sort((a, b) => new Date(a.date) - new Date(b.date));
        const initEvent = coActs.length > 0 ? coActs[0].event : '‚Äî';
        const evColor = EVENT_COLORS[initEvent] || '#555';
        // Find max stage
        let maxStage = null, maxOrder = 0;
        coActs.forEach(a => {
            const si = STAGES.findIndex(s => s.id === a.stage);
            if (si >= 0 && STAGES[si].order > maxOrder) { maxOrder = STAGES[si].order; maxStage = STAGES[si]; }
        });
        const stageLabel = maxStage ? maxStage.name : '‚Äî';
        const stageColor = maxStage ? SCOLORS[STAGES.indexOf(maxStage)] : '#555';
        const notes = co.notes || '';

        // Logo
        const logoUrl = LOGO_URLS[co.name];
        let logoHtml;
        if (logoUrl) {
            logoHtml = `<img class="lv-logo" src="${logoUrl}" onerror="this.style.display='none'">`;
        } else {
            const parts = co.name.replace(/[^\w–ê-–Ø–∞-—è–Å—ë]/g, ' ').trim().split(/\s+/);
            const init = parts.length > 1 ? (parts[0][0] + parts[1][0]).toUpperCase() : co.name.substring(0, 2).toUpperCase();
            let hash = 0; for (let i = 0; i < co.name.length; i++) hash = co.name.charCodeAt(i) + ((hash << 5) - hash);
            const hue = Math.abs(hash) % 360;
            logoHtml = `<div class="lv-logo-init" style="background:hsl(${hue},55%,45%)">${init}</div>`;
        }

        // DPrice score circle
        const dpData = dpGetCachedScore(co.name);
        let dpCircleHtml = '';
        if (dpData) {
            const dpScore = parseFloat(dpData.dprice) || 0;
            const dpColor = dpScoreColor(dpScore);
            dpCircleHtml = `<div class="lv-dp-scores"><div class="dp-mini" data-dp-show="${idx}" style="background:${dpColor}" title="DPrice: ${dpScore.toFixed(1)}/10">${dpScore.toFixed(1)}</div></div>`;
        }

        html += `<div class="lv-card">`;
        html += `<div style="display:flex;flex-direction:column;align-items:center;gap:4px;flex-shrink:0">`;
        html += logoHtml;
        html += dpCircleHtml;
        html += `</div>`;
        html += `<div class="lv-body">`;
        html += `<div class="lv-title">${co.name}</div>`;
        html += `<div class="lv-meta">`;
        html += `${co.region || ''} ¬∑ ${co.contact || ''} ${co.pos ? '(' + co.pos + ')' : ''}`;
        html += `<br>–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: <span class="lv-badge" style="background:${evColor}">${initEvent}</span>`;
        html += ` ¬∑ –≠—Ç–∞–ø: <span class="lv-badge" style="background:${stageColor}">${stageLabel}</span>`;
        html += ` ¬∑ –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π: <b>${coActs.length}</b>`;
        html += `</div>`;
        html += `<textarea class="lv-notes" data-co-idx="${idx}" placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ –∫–æ–º–ø–∞–Ω–∏–∏...">${notes}</textarea>`;
        html += `</div>`;
        html += `<div class="lv-actions">`;
        html += `<button class="lv-news" data-co-fin="${idx}">üìä –§–∏–Ω–∞–Ω—Å—ã</button>`;
        html += `<button class="lv-news lv-dprice" data-co-dprice="${idx}">üéØ DPrice</button>`;
        html += `<button class="lv-news" data-co-edit="${idx}">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>`;
        html += `<button class="lv-news" data-co-news-co="${idx}">üîç –û –∫–æ–º–ø–∞–Ω–∏–∏</button>`;
        html += `<button class="lv-news" data-co-news-person="${idx}">üë§ –û –ø–µ—Ä—Å–æ–Ω–∞–ª–∏—è—Ö</button>`;
        html += `<button class="lv-del" data-co-del="${idx}">–£–¥–∞–ª–∏—Ç—å</button>`;
        html += `</div>`;
        html += `</div>`;
    });

    html += `<button class="lv-add-btn" id="coAddBtn">+ –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é</button>`;
    html += '</div>';
    vc.innerHTML = html;

    // Wire events
    vc.querySelectorAll('.lv-notes[data-co-idx]').forEach(ta => {
        ta.addEventListener('blur', () => {
            const i = parseInt(ta.dataset.coIdx);
            if (curData.companies[i]) { curData.companies[i].notes = ta.value; markDirty(); }
        });
    });
    // Finance
    vc.querySelectorAll('[data-co-fin]').forEach(btn => {
        btn.onclick = () => {
            const i = parseInt(btn.dataset.coFin);
            const co = curData.companies[i];
            if (co) showFinanceModal(co.name);
        };
    });
    // DPrice scoring
    vc.querySelectorAll('[data-co-dprice]').forEach(btn => {
        btn.onclick = () => {
            const i = parseInt(btn.dataset.coDprice);
            const co = curData.companies[i];
            if (co) showDPriceModal(co.name);
        };
    });
    // DPrice mini score circles ‚Äî click to show full analysis
    vc.querySelectorAll('[data-dp-show]').forEach(el => {
        el.onclick = () => {
            const i = parseInt(el.dataset.dpShow);
            const co = curData.companies[i];
            if (!co) return;
            const cached = dpGetCachedScore(co.name);
            if (cached) {
                dpOpenModal(dpRenderScore(co.name, cached));
            } else {
                showDPriceModal(co.name);
            }
        };
    });
    // Edit company
    vc.querySelectorAll('[data-co-edit]').forEach(btn => {
        btn.onclick = () => {
            const i = parseInt(btn.dataset.coEdit);
            const co = curData.companies[i];
            if (!co) return;
            openEditCompanyModal(i);
        };
    });
    // News: about company
    vc.querySelectorAll('[data-co-news-co]').forEach(btn => {
        btn.onclick = () => {
            const i = parseInt(btn.dataset.coNewsCo);
            const co = curData.companies[i];
            if (!co) return;
            const q = encodeURIComponent(co.name + ' –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –Ω–æ–≤–æ—Å—Ç–∏');
            openNews(`https://www.google.com/search?q=${q}&tbm=nws&tbs=qdr:m`);
        };
    });
    // News: about personnel
    vc.querySelectorAll('[data-co-news-person]').forEach(btn => {
        btn.onclick = () => {
            const i = parseInt(btn.dataset.coNewsPerson);
            const co = curData.companies[i];
            if (!co) return;
            const contact = co.contact || '';
            const q = encodeURIComponent((contact ? contact + ' ' : '') + co.name + ' –Ω–æ–≤–æ—Å—Ç–∏');
            openNews(`https://www.google.com/search?q=${q}&tbm=nws&tbs=qdr:m`);
        };
    });
    vc.querySelectorAll('[data-co-del]').forEach(btn => {
        btn.onclick = () => {
            const i = parseInt(btn.dataset.coDel);
            const co = curData.companies[i];
            if (!co) return;
            customConfirm(`–ö–æ–º–ø–∞–Ω–∏—è ¬´${co.name}¬ª –∏ –≤—Å–µ –µ—ë –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`, '–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é?').then(ok => {
                if (!ok) return;
                curData.activities = curData.activities.filter(a => a.company !== co.name);
                curData.companies.splice(i, 1);
                markDirty();
                build(curData, true);
                buildCompaniesView();
            });
        };
    });
    const addBtn = document.getElementById('coAddBtn');
    if (addBtn) addBtn.onclick = () => { openAddCompanyModal(); };
    const batchBtn = document.getElementById('dpBatchStartBtn');
    if (batchBtn) batchBtn.onclick = () => dpBatchStart();
}

// ============================
// NEWS ‚Äî open in new browser tab
// ============================
function openNews(url) {
    window.open(url, '_blank');
}

function build2D() {
    if (!curData) return;
    const v2 = document.getElementById('view2d');
    const { companies, activities } = curData;
    const coNames = [...new Set(companies.map(c => c.name))];

    // nWeeks is global
    const allDates = activities.map(a => new Date(a.date)).filter(d => !isNaN(d));
    const minDate = new Date(Math.min(...allDates));
    const dayOfWeek = minDate.getDay();
    const weekStart = new Date(minDate);
    weekStart.setDate(weekStart.getDate() - ((dayOfWeek + 6) % 7));

    function dateToWeek(dateStr) {
        const d = new Date(dateStr);
        return Math.floor((d - weekStart) / (7 * 24 * 60 * 60 * 1000));
    }

    // Each company has ONE event (the one that initiated contact = earliest activity)
    const companyEvent = {};
    coNames.forEach(co => {
        const coActs = activities.filter(a => a.company === co);
        if (coActs.length === 0) return;
        coActs.sort((a, b) => new Date(a.date) - new Date(b.date));
        companyEvent[co] = coActs[0].event;
    });

    // Filters:
    // Events ‚Äî keep only companies whose event is in the filter
    // Regions ‚Äî keep only companies from checked regions
    const filteredCoNames = coNames.filter(co => {
        const comp = companies.find(c => c.name === co);
        if (!comp || !filters.regions.has(comp.region)) return false;
        const ev = companyEvent[co];
        if (!ev || !filters.events.has(ev)) return false;
        return true;
    });

    // Build cell map: company|week ‚Üí single activity
    // Apply stage filter on individual cells
    const cellMap = {}; // key: "company|week" ‚Üí {act, si}
    let actualMaxWeek2D = 0;
    activities.forEach(act => {
        // Stage filter
        if (!filters.stages.has(act.stage)) return;
        // Only include companies that passed filters above
        if (!filteredCoNames.includes(act.company)) return;
        const wi = dateToWeek(act.date);
        if (wi < 0 || wi >= nWeeks) return;
        const si = STAGES.findIndex(s => s.id === act.stage);
        cellMap[`${act.company}|${wi}`] = { ...act, si: si >= 0 ? si : 0 };
        if (wi > actualMaxWeek2D) actualMaxWeek2D = wi;
    });

    // Table
    let html = '<table><tr><th class="corner"></th>';
    for (let w = 0; w < nWeeks; w++) html += `<th>${w + 1}w</th>`;
    html += '</tr>';

    filteredCoNames.forEach(co => {
        const logoUrl = LOGO_URLS[co] || '';
        const logoHtml = logoUrl ? `<img class="co-logo" src="${logoUrl}" onerror="this.style.display='none'">` : '';
        const ev = companyEvent[co] || '';
        const comp = companies.find(c => c.name === co);
        const titleAttr = `${co}${comp ? ' [' + comp.region + ']' : ''}&#10;–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ: ${ev}`;
        html += `<tr><th class="co-header" title="${titleAttr}">${logoHtml}${co}</th>`;
        for (let w = 0; w < nWeeks; w++) {
            const cell = cellMap[`${co}|${w}`];
            if (cell) {
                const color = SCOLORS[cell.si];
                const isLastWeek = (w === actualMaxWeek2D) && blinkEnabled;
                const blinkCls = isLastWeek ? ' blink2d' : '';
                html += `<td><div class="cell2d filled${blinkCls}" style="background:${color}" data-co="${co}" data-wi="${w}" data-filled="1" title="${cell.event}&#10;${cell.stageName} ¬∑ ${cell.date}"></div></td>`;
            } else {
                html += `<td><div class="cell2d empty-cell" data-co="${co}" data-wi="${w}" data-filled="0" title="–î–æ–±–∞–≤–∏—Ç—å: ${co}, –Ω–µ–¥.${w+1}"></div></td>`;
            }
        }
        html += '</tr>';
    });
    html += '</table>';
    v2.innerHTML = html;

    // Cell clicks
    v2.querySelectorAll('.cell2d').forEach(cell => {
        cell.onclick = () => {
            const co = cell.dataset.co;
            const wi = parseInt(cell.dataset.wi);
            const isFilled = cell.dataset.filled === '1';
            const comp = companies.find(c => c.name === co);

            if (isFilled) {
                const act = cellMap[`${co}|${wi}`];
                if (act) openEditPanel({ userData: act }, false);
            } else {
                // Add new ‚Äî use this company's event
                const ev = companyEvent[co] || '';
                const newDate = new Date(weekStart);
                newDate.setDate(newDate.getDate() + wi * 7);
                openEditPanel({
                    userData: {
                        company: co, event: ev, wi,
                        region: comp ? comp.region : '',
                        contact: comp ? comp.contact : '',
                        position: comp ? comp.pos : '',
                        stage: STAGES[0].id,
                        date: newDate.toISOString().slice(0, 10),
                    }
                }, true);
            }
        };

        // Right-click on filled cells ‚Äî custom confirm delete
        if (cell.dataset.filled === '1') {
            cell.oncontextmenu = (e) => {
                e.preventDefault();
                const co = cell.dataset.co;
                const wi = parseInt(cell.dataset.wi);
                const act = cellMap[`${co}|${wi}`];
                if (act && curData) {
                    customConfirm(
                        `${act.company} ‚Äî ${act.event}\n${act.stageName} (–Ω–µ–¥.${wi+1})`,
                        '–£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?'
                    ).then(ok => {
                        if (ok) {
                            const di = curData.activities.findIndex(a =>
                                a.company === act.company && a.event === act.event &&
                                a.stage === act.stage && a.date === act.date
                            );
                            if (di >= 0) { curData.activities.splice(di, 1); markDirty(); build(curData, true); rebuildCurrentView(); }
                        }
                    });
                }
            };
        }
    });
}

// ============================
// TIMELINE VIEW (Gantt-like)
// ============================
function buildTimeline() {
    if (!curData) return;
    const vt = document.getElementById('viewTimeline');
    const { companies, activities } = curData;

    const allDates = activities.map(a => new Date(a.date)).filter(d => !isNaN(d));
    const minDate = new Date(Math.min(...allDates));
    const dayOfWeek = minDate.getDay();
    const weekStart = new Date(minDate);
    weekStart.setDate(weekStart.getDate() - ((dayOfWeek + 6) % 7));

    function dateToWeek(dateStr) {
        const d = new Date(dateStr);
        return Math.floor((d - weekStart) / (7 * 24 * 60 * 60 * 1000));
    }

    const weekPx = 32; // match 2D cell width (28px cell + 2*2px padding)
    const totalW = nWeeks * weekPx;

    // Build event bars from ALL EVENTS_META (not just used ones)
    // Show every event as a timeline bar, even if no companies assigned yet
    const eventBars = EVENTS_META
        .filter(em => filters.events.has(em.name))
        .map(em => ({
            name: em.name,
            color: em.color,
            startW: em.weekStart,
            endW: Math.min(em.weekStart + em.duration, nWeeks),
            // Count companies that came from this event
            companyCount: activities.filter(a => a.event === em.name)
                .reduce((s, a) => { s.add(a.company); return s; }, new Set()).size,
        }));

    // Build per-company pipeline bars (stages over time)
    const coNames = [...new Set(companies.map(c => c.name))];

    // Week grid lines
    let gridLines = '';
    for (let w = 0; w <= nWeeks; w++) {
        gridLines += `<div class="tl-grid-line" style="left:${w * weekPx}px"></div>`;
    }

    // Header with week numbers
    let html = '<div class="tl-container">';
    html += '<div class="tl-header">';
    for (let w = 0; w < nWeeks; w++) {
        html += `<div class="tl-week-label" style="width:${weekPx}px">${w + 1}w</div>`;
    }
    html += '</div>';

    // Section 1: Marketing Activities (events as horizontal bars)
    html += '<div class="tl-section">';
    html += '<div class="tl-section-title">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</div>';
    eventBars.forEach(eb => {
        const left = eb.startW * weekPx;
        const width = (eb.endW - eb.startW) * weekPx - 2;
        const label = eb.companyCount;
        html += `<div class="tl-row">`;
        html += `<div class="tl-row-label" title="${eb.name} (${eb.companyCount} –∫–æ–º–ø.)">${eb.name}</div>`;
        html += `<div class="tl-row-bars" style="width:${totalW}px">`;
        html += gridLines;
        html += `<div class="tl-bar tl-ev-bar" data-event="${eb.name}" style="left:${left}px;width:${Math.max(width, 8)}px;background:${eb.color};cursor:pointer" title="${eb.name}: –Ω–µ–¥.${eb.startW+1}‚Äì${eb.endW}, ${eb.companyCount} –∫–æ–º–ø.">${width > 20 ? label : ''}</div>`;
        html += `</div></div>`;
    });
    html += '</div>';

    // Section 2: Company pipelines (each company's stage progression)
    html += '<div class="tl-section">';
    html += '<div class="tl-section-title">–í–æ—Ä–æ–Ω–∫–∞ –ø–æ –∫–æ–º–ø–∞–Ω–∏—è–º</div>';

    const filteredCo = coNames.filter(co => {
        const comp = companies.find(c => c.name === co);
        if (!comp || !filters.regions.has(comp.region)) return false;
        const coActs = activities.filter(a => a.company === co);
        if (coActs.length === 0) return false;
        const initEv = coActs.sort((a, b) => new Date(a.date) - new Date(b.date))[0].event;
        return filters.events.has(initEv);
    });

    filteredCo.forEach(co => {
        const coActs = activities.filter(a => a.company === co && filters.stages.has(a.stage))
            .sort((a, b) => new Date(a.date) - new Date(b.date));
        if (coActs.length === 0) return;

        const logoUrl = LOGO_URLS[co] || '';
        const logoHtml = logoUrl ? `<img class="co-logo" src="${logoUrl}" onerror="this.style.display='none'">` : '';
        const comp = companies.find(c => c.name === co);
        const initEv = coActs[0].event;
        html += `<div class="tl-row tl-co-row" data-event="${initEv}">`;
        html += `<div class="tl-row-label" title="${co} [${comp?.region||''}]\n${initEv}">${logoHtml}${co}</div>`;
        html += `<div class="tl-row-bars" style="width:${totalW}px" data-co="${co}" data-event="${initEv}">`;
        html += gridLines;

        // Collect occupied weeks
        const occupiedWeeks = new Set();
        coActs.forEach(act => {
            const wi = dateToWeek(act.date);
            if (wi >= 0 && wi < nWeeks) occupiedWeeks.add(wi);
        });

        // Empty clickable cells for adding activities
        for (let w = 0; w < nWeeks; w++) {
            if (!occupiedWeeks.has(w)) {
                html += `<div class="tl-empty-cell" data-week="${w}" style="left:${w * weekPx}px;width:${weekPx - 2}px" title="+ –î–æ–±–∞–≤–∏—Ç—å (–Ω–µ–¥. ${w+1})"></div>`;
            }
        }

        // Each stage as a colored block at its week position
        coActs.forEach(act => {
            const wi = dateToWeek(act.date);
            if (wi < 0 || wi >= nWeeks) return;
            const si = STAGES.findIndex(s => s.id === act.stage);
            const color = SCOLORS[si >= 0 ? si : 0];
            const left = wi * weekPx;
            const isLast = (wi === maxWeekIdx) && blinkEnabled;
            const blinkStyle = isLast ? 'animation:blink2d 1.2s ease-in-out infinite;' : '';
            html += `<div class="tl-bar" style="left:${left}px;width:${weekPx - 2}px;background:${color};${blinkStyle}" title="${act.stageName}\n${act.event} ¬∑ ${act.date}">${si >= 0 ? STAGES[si].order : ''}</div>`;
        });

        html += `</div></div>`;
    });
    html += '</div>';

    html += '</div>';
    vt.innerHTML = html;

    // Interactive highlight: mousedown on event bar ‚Üí dim non-matching companies
    vt.querySelectorAll('.tl-ev-bar').forEach(bar => {
        bar.addEventListener('mousedown', e => {
            e.preventDefault();
            const evName = bar.dataset.event;
            vt.querySelectorAll('.tl-co-row').forEach(row => {
                if (row.dataset.event !== evName) row.classList.add('tl-dimmed');
            });
        });
    });
    // mouseup anywhere ‚Üí restore all
    function restoreAll() {
        vt.querySelectorAll('.tl-co-row.tl-dimmed').forEach(row => row.classList.remove('tl-dimmed'));
    }
    vt.addEventListener('mouseup', restoreAll);
    vt.addEventListener('mouseleave', restoreAll);

    // Click on empty timeline cells ‚Üí add activity (like 2D)
    vt.querySelectorAll('.tl-empty-cell').forEach(cell => {
        cell.onclick = () => {
            const barsDiv = cell.parentElement;
            const co = barsDiv.dataset.co;
            const ev = barsDiv.dataset.event;
            const w = parseInt(cell.dataset.week);
            if (!co) return;
            const comp = companies.find(c => c.name === co);
            const newDate = new Date(weekStart);
            newDate.setDate(newDate.getDate() + w * 7);
            openEditPanel({
                userData: {
                    company: co, event: ev, wi: w,
                    region: comp ? comp.region : '',
                    contact: comp ? comp.contact : '',
                    position: comp ? comp.pos : '',
                    stage: STAGES[0].id,
                    date: newDate.toISOString().slice(0, 10),
                }
            }, true);
        };
    });

    // Click on filled timeline bars ‚Üí edit existing activity
    vt.querySelectorAll('.tl-co-row .tl-bar:not(.tl-ev-bar)').forEach(bar => {
        if (!bar.closest('.tl-co-row')) return;
        bar.style.cursor = 'pointer';
        bar.onclick = () => {
            const barsDiv = bar.parentElement;
            const co = barsDiv.dataset.co;
            if (!co) return;
            const left = parseInt(bar.style.left);
            const wi = Math.round(left / weekPx);
            const act = activities.find(a => {
                if (a.company !== co) return false;
                const aw = dateToWeek(a.date);
                return aw === wi;
            });
            if (act) openEditPanel({ userData: act }, false);
        };
        // Right-click ‚Üí delete
        bar.oncontextmenu = (e) => {
            e.preventDefault();
            const barsDiv = bar.parentElement;
            const co = barsDiv.dataset.co;
            if (!co) return;
            const left = parseInt(bar.style.left);
            const wi = Math.round(left / weekPx);
            const act = activities.find(a => {
                if (a.company !== co) return false;
                const aw = dateToWeek(a.date);
                return aw === wi;
            });
            if (act && curData) {
                customConfirm(
                    `${act.company} ‚Äî ${act.event}\n${act.stageName || act.stage} (–Ω–µ–¥.${wi+1})`,
                    '–£–¥–∞–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å?'
                ).then(ok => {
                    if (ok) {
                        const di = curData.activities.findIndex(a =>
                            a.company === act.company && a.event === act.event &&
                            a.stage === act.stage && a.date === act.date
                        );
                        if (di >= 0) { curData.activities.splice(di, 1); markDirty(); build(curData, true); rebuildCurrentView(); }
                    }
                });
            }
        };
    });
}

// ============================
// AUTH MODULE
// ============================
let authUser = null; // { login, name, role }

async function sha256(str) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

function setAuthUI(user) {
    const name = user.name || user.login || '';
    const parts = name.split(/\s+/);
    const initials = parts.map(p => p.charAt(0).toUpperCase()).join('').substring(0, 2);
    document.getElementById('userMenuBtn').textContent = initials || '?';
    document.getElementById('ddUserName').textContent = name;
    document.getElementById('authBar').style.display = '';
}

async function doAuth() {
    const login = document.getElementById('authLogin').value.trim();
    const pass = document.getElementById('authPass').value;
    const errEl = document.getElementById('authErr');
    const btn = document.getElementById('authBtn');
    errEl.textContent = '';
    if (!login || !pass) { errEl.textContent = '–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; return; }
    if (!gsUrl) { errEl.textContent = 'Google Sheets –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω'; return; }
    btn.disabled = true;
    btn.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
    try {
        const passHash = await sha256(pass);
        const data = await gsFetch('auth', { login, passHash });
        if (data && data.ok) {
            authUser = { login, name: data.name || login, role: data.role || 'user' };
            sessionStorage.setItem('vibeAuth', JSON.stringify(authUser));
            sessionStorage.setItem('vibeAuthHash', passHash);
            document.getElementById('authScreen').classList.add('gone');
            setAuthUI(authUser);
            if (authUser.role === 'admin') {
                document.getElementById('adminMenu').style.display = '';
                document.getElementById('gsStatus').style.display = '';
            }
            errEl.textContent = '';
        } else {
            errEl.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
        }
    } catch (e) {
        errEl.textContent = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ' + e.message;
    } finally {
        btn.disabled = false;
        btn.textContent = '–í–æ–π—Ç–∏';
    }
}

function authLogout() {
    authUser = null;
    sessionStorage.removeItem('vibeAuth');
    sessionStorage.removeItem('vibeAuthHash');
    document.getElementById('authScreen').classList.remove('gone');
    document.getElementById('authBar').style.display = 'none';
    document.getElementById('adminMenu').style.display = 'none';
    document.getElementById('gsStatus').style.display = 'none';
    document.getElementById('gsModal').classList.remove('show');
    document.getElementById('authPass').value = '';
    document.getElementById('authErr').textContent = '';
    authCheckFirstSetup();
}

function authCheckSession() {
    const saved = sessionStorage.getItem('vibeAuth');
    if (saved) {
        try {
            authUser = JSON.parse(saved);
            document.getElementById('authScreen').classList.add('gone');
            setAuthUI(authUser);
            if (authUser.role === 'admin') {
                document.getElementById('adminMenu').style.display = '';
                document.getElementById('gsStatus').style.display = '';
            }
            return true;
        } catch(e) {}
    }
    return false;
}

function authShowLoginIfNeeded() {
    // Show login screen only if GS is connected and no valid session
    if (gsUrl && !authUser) {
        document.getElementById('authScreen').classList.remove('gone');
        authCheckFirstSetup();
    }
}

async function authCheckFirstSetup() {
    if (!gsUrl) return;
    try {
        const data = await gsFetch('ping');
        const el = document.getElementById('authFirstSetup');
        if (el) el.style.display = (data && data.hasUsers === false) ? '' : 'none';
    } catch(e) {
        // On error, keep the setup section hidden
    }
}

// ============================
// ADMIN MODULE
// ============================

function escHtml(s) {
    const d = document.createElement('div');
    d.textContent = s || '';
    return d.innerHTML;
}

function adminShowPanel() {
    document.getElementById('adminModal').classList.add('show');
    document.getElementById('adminMsg').textContent = '';
    adminLoadUsers();
}

function adminClosePanel() {
    document.getElementById('adminModal').classList.remove('show');
}

function adminGetCallerCredentials() {
    const stored = sessionStorage.getItem('vibeAuthHash');
    return { callerLogin: authUser ? authUser.login : '', callerPassHash: stored || '' };
}

async function adminLoadUsers() {
    const tbody = document.getElementById('adminUsersTbody');
    tbody.innerHTML = '<tr><td colspan="4" style="color:var(--dim)">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
    try {
        const creds = adminGetCallerCredentials();
        const data = await gsFetch('list_users', creds);
        if (!data || !data.ok) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:var(--del-text)">' + escHtml(data?.error || '–û—à–∏–±–∫–∞') + '</td></tr>';
            return;
        }
        const users = data.users || [];
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="color:var(--dim)">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</td></tr>';
            return;
        }
        tbody.innerHTML = '';
        users.forEach(u => {
            const tr = document.createElement('tr');
            const isSelf = u.login === (authUser ? authUser.login : '');
            tr.innerHTML = '<td>' + escHtml(u.login) + '</td><td>' + escHtml(u.name) + '</td><td>' + escHtml(u.role) + '</td><td>' +
                (isSelf ? '' : '<button class="admin-del-btn" data-login="' + escHtml(u.login) + '">‚úï</button>') + '</td>';
            tbody.appendChild(tr);
        });
        // Attach delete handlers
        tbody.querySelectorAll('.admin-del-btn').forEach(btn => {
            btn.onclick = () => adminDeleteUser(btn.dataset.login);
        });
    } catch(e) {
        tbody.innerHTML = '<tr><td colspan="4" style="color:var(--del-text)">–û—à–∏–±–∫–∞: ' + escHtml(e.message) + '</td></tr>';
    }
}

async function adminAddUser() {
    const login = document.getElementById('adminNewLogin').value.trim();
    const pass = document.getElementById('adminNewPass').value;
    const name = document.getElementById('adminNewName').value.trim();
    const role = document.getElementById('adminNewRole').value;
    const msgEl = document.getElementById('adminMsg');
    msgEl.textContent = '';
    msgEl.className = 'admin-msg';

    if (!login || !pass) { msgEl.textContent = '–£–∫–∞–∂–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å'; msgEl.className = 'admin-msg err'; return; }

    try {
        const passHash = await sha256(pass);
        const creds = adminGetCallerCredentials();
        const data = await gsFetch('add_user', {
            ...creds, login, passHash, name, role
        });
        if (data && data.ok) {
            msgEl.textContent = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω';
            msgEl.className = 'admin-msg ok';
            document.getElementById('adminNewLogin').value = '';
            document.getElementById('adminNewPass').value = '';
            document.getElementById('adminNewName').value = '';
            adminLoadUsers();
        } else {
            msgEl.textContent = data?.error || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è';
            msgEl.className = 'admin-msg err';
        }
    } catch(e) {
        msgEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
        msgEl.className = 'admin-msg err';
    }
}

async function adminDeleteUser(login) {
    const ok = await customConfirm(
        '–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <b>' + escHtml(login) + '</b>?',
        '–£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'
    );
    if (!ok) return;

    const msgEl = document.getElementById('adminMsg');
    try {
        const creds = adminGetCallerCredentials();
        const data = await gsFetch('delete_user', { ...creds, login });
        if (data && data.ok) {
            msgEl.textContent = '‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω';
            msgEl.className = 'admin-msg ok';
            adminLoadUsers();
        } else {
            msgEl.textContent = data?.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è';
            msgEl.className = 'admin-msg err';
        }
    } catch(e) {
        msgEl.textContent = '–û—à–∏–±–∫–∞: ' + e.message;
        msgEl.className = 'admin-msg err';
    }
}

// ============================
// GOOGLE SHEETS SYNC MODULE
// ============================
const GS_DEFAULT_URL = 'https://script.google.com/macros/s/AKfycbyLDjISh08ffHw4A1JH2TgjGpqdD7-sey76RIj5Jw_LkYaT1ILQN5O4A6g1AkyXHeV13Q/exec';
let gsUrl = localStorage.getItem('vibeGS_url') || GS_DEFAULT_URL;
let gsAutoSync = localStorage.getItem('vibeGS_auto') !== 'false';
let gsInterval = parseInt(localStorage.getItem('vibeGS_interval')) || 30;
let gsPollTimer = null;
let gsDataHash = ''; // hash of last known remote data

const GS_APPS_SCRIPT_CODE = `// VibeMarketing ‚Äî Google Sheets Backend v14
// –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ Apps Script –≤–∞—à–µ–π Google –¢–∞–±–ª–∏—Ü—ã
// –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å 4 –ª–∏—Å—Ç–∞: companies, activities, meta, users

var C_HEADERS = ['name','region','contact','pos','notes'];
var A_HEADERS = ['company','region','contact','position','event','stage','stageName','stageOrder','date'];

function verifyAdmin(callerLogin, callerPassHash) {
  if (!callerLogin || !callerPassHash) return false;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var us = ss.getSheetByName('users');
  if (!us || us.getLastRow() < 2) return false;
  var data = us.getDataRange().getValues();
  var headers = data[0];
  var li = headers.indexOf('login'), pi = headers.indexOf('passHash'), ri = headers.indexOf('role');
  if (li < 0 || pi < 0 || ri < 0) return false;
  for (var i = 1; i < data.length; i++) {
    if (String(data[i][li]).trim() === callerLogin
        && String(data[i][pi]).trim() === callerPassHash
        && String(data[i][ri]).trim() === 'admin') {
      return true;
    }
  }
  return false;
}

function doGet(e) {
  var p = e && e.parameter ? e.parameter : {};
  var action = p.action || 'load';

  if (action === 'ping') {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var us = ss.getSheetByName('users');
    var hasUsers = !!(us && us.getLastRow() >= 2);
    return jsonResp({ok:true, ts: new Date().toISOString(), hasUsers: hasUsers});
  }

  if (action === 'auth') {
    // Authenticate user: check login + passHash against users sheet
    var d = p.d ? JSON.parse(p.d) : {};
    var login = d.login || '';
    var passHash = d.passHash || '';
    if (!login || !passHash) return jsonResp({ok:false, error:'missing credentials'});
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var us = ss.getSheetByName('users');
    if (!us || us.getLastRow() < 2) return jsonResp({ok:false, error:'no users sheet'});
    var data = us.getDataRange().getValues();
    var headers = data[0];
    var li = headers.indexOf('login'), pi = headers.indexOf('passHash');
    var ni = headers.indexOf('name'), ri = headers.indexOf('role');
    if (li < 0 || pi < 0) return jsonResp({ok:false, error:'invalid users sheet'});
    for (var i = 1; i < data.length; i++) {
      if (String(data[i][li]).trim() === login && String(data[i][pi]).trim() === passHash) {
        return jsonResp({ok:true, name: ni>=0 ? data[i][ni] : login, role: ri>=0 ? data[i][ri] : 'user'});
      }
    }
    return jsonResp({ok:false, error:'wrong credentials'});
  }

  // ---- admin: user management ----
  if (action === 'list_users') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var us = ss.getSheetByName('users');
    if (!us || us.getLastRow() < 2) return jsonResp({ok:true, users:[]});
    var data = us.getDataRange().getValues();
    var headers = data[0];
    var li = headers.indexOf('login'), ni = headers.indexOf('name'), ri = headers.indexOf('role');
    var result = [];
    for (var i = 1; i < data.length; i++) {
      result.push({
        login: li >= 0 ? String(data[i][li]) : '',
        name: ni >= 0 ? String(data[i][ni]) : '',
        role: ri >= 0 ? String(data[i][ri]) : 'user'
      });
    }
    return jsonResp({ok:true, users: result});
  }

  if (action === 'add_user') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.login || !d.passHash) return jsonResp({ok:false, error:'missing login or passHash'});
    var lock2 = LockService.getScriptLock();
    lock2.waitLock(10000);
    try {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var us = ss.getSheetByName('users');
      if (!us) return jsonResp({ok:false, error:'no users sheet'});
      if (us.getLastRow() >= 2) {
        var existing = us.getDataRange().getValues();
        var eli = existing[0].indexOf('login');
        for (var i = 1; i < existing.length; i++) {
          if (String(existing[i][eli]).trim() === d.login.trim())
            return jsonResp({ok:false, error:'login already exists'});
        }
      }
      us.appendRow([d.login.trim(), d.passHash, d.name || '', d.role || 'user']);
      return jsonResp({ok:true});
    } finally { lock2.releaseLock(); }
  }

  if (action === 'delete_user') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.login) return jsonResp({ok:false, error:'missing login'});
    if (d.login.trim() === d.callerLogin.trim())
      return jsonResp({ok:false, error:'cannot delete yourself'});
    var lock3 = LockService.getScriptLock();
    lock3.waitLock(10000);
    try {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var us = ss.getSheetByName('users');
      if (!us || us.getLastRow() < 2) return jsonResp({ok:false, error:'no users'});
      var data = us.getDataRange().getValues();
      var li = data[0].indexOf('login');
      for (var i = 1; i < data.length; i++) {
        if (String(data[i][li]).trim() === d.login.trim()) {
          us.deleteRow(i + 1);
          return jsonResp({ok:true});
        }
      }
      return jsonResp({ok:false, error:'user not found'});
    } finally { lock3.releaseLock(); }
  }

  if (action === 'check_dadata_key') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    var key = getDadataKey();
    return jsonResp({ok:true, hasKey: !!key, keyPreview: key ? key.substring(0,4) + '...' : ''});
  }

  if (action === 'set_dadata_key') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.key) return jsonResp({ok:false, error:'no key provided'});
    setDadataKey(d.key.trim());
    return jsonResp({ok:true});
  }

  if (action === 'set_checko_key') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.key) return jsonResp({ok:false, error:'no key provided'});
    setCheckoKey(d.key.trim());
    return jsonResp({ok:true});
  }

  if (action === 'set_anthropic_key') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.key) return jsonResp({ok:false, error:'no key provided'});
    setMetaKey('anthropicKey', d.key.trim());
    return jsonResp({ok:true});
  }

  if (action === 'set_openai_key') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.key) return jsonResp({ok:false, error:'no key provided'});
    setMetaKey('openaiKey', d.key.trim());
    return jsonResp({ok:true});
  }

  if (action === 'set_gemini_key') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.key) return jsonResp({ok:false, error:'no key provided'});
    setMetaKey('geminiKey', d.key.trim());
    return jsonResp({ok:true});
  }

  if (action === 'set_grok_key') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    if (!d.key) return jsonResp({ok:false, error:'no key provided'});
    setMetaKey('grokKey', d.key.trim());
    return jsonResp({ok:true});
  }

  if (action === 'set_ollama_url') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    setMetaKey('ollamaUrl', (d.url || '').trim());
    return jsonResp({ok:true});
  }

  if (action === 'set_active_provider') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    var validProviders = ['anthropic','openai','gemini','grok','ollama'];
    if (validProviders.indexOf(d.provider) < 0) return jsonResp({ok:false, error:'invalid provider'});
    setMetaKey('activeProvider', d.provider);
    return jsonResp({ok:true});
  }

  if (action === 'get_llm_keys_status') {
    var d = p.d ? JSON.parse(p.d) : {};
    if (!verifyAdmin(d.callerLogin, d.callerPassHash))
      return jsonResp({ok:false, error:'access denied'});
    return jsonResp({ok:true,
      anthropic: !!getMetaKey('anthropicKey'),
      openai: !!getMetaKey('openaiKey'),
      gemini: !!getMetaKey('geminiKey'),
      grok: !!getMetaKey('grokKey'),
      ollamaUrl: getMetaKey('ollamaUrl') || '',
      activeProvider: getMetaKey('activeProvider') || 'anthropic'
    });
  }

  if (action === 'list_models') {
    var d = p.d ? JSON.parse(p.d) : {};
    var lmProvider = d.provider || getMetaKey('activeProvider') || 'anthropic';
    try {
      if (lmProvider === 'anthropic') {
        var anthropicKey = getMetaKey('anthropicKey');
        if (!anthropicKey) return jsonResp({ok:false, error:'NO_ANTHROPIC_KEY'});
        var resp = UrlFetchApp.fetch('https://api.anthropic.com/v1/models?limit=50', {
          method: 'get',
          headers: {'x-api-key': anthropicKey, 'anthropic-version': '2023-06-01'},
          muteHttpExceptions: true
        });
        if (resp.getResponseCode() !== 200) throw new Error('API error: ' + resp.getResponseCode());
        var json = JSON.parse(resp.getContentText());
        var models = [];
        for (var i = 0; i < json.data.length; i++) {
          var m = json.data[i];
          models.push({id: m.id, label: m.display_name || m.id, created: m.created_at});
        }
        return jsonResp({ok:true, models: models});
      } else if (lmProvider === 'openai') {
        var openaiKey = getMetaKey('openaiKey');
        if (!openaiKey) return jsonResp({ok:false, error:'NO_OPENAI_KEY'});
        var resp = UrlFetchApp.fetch('https://api.openai.com/v1/models', {
          method: 'get',
          headers: {'Authorization': 'Bearer ' + openaiKey},
          muteHttpExceptions: true
        });
        if (resp.getResponseCode() !== 200) throw new Error('OpenAI API error: ' + resp.getResponseCode());
        var json = JSON.parse(resp.getContentText());
        var models = [];
        for (var i = 0; i < json.data.length; i++) {
          var mid = json.data[i].id;
          if (mid.indexOf('gpt') >= 0 || mid.indexOf('o1') >= 0 || mid.indexOf('o3') >= 0 || mid.indexOf('o4') >= 0) {
            models.push({id: mid, label: mid});
          }
        }
        models.sort(function(a,b){ return a.id < b.id ? 1 : -1; });
        return jsonResp({ok:true, models: models});
      } else if (lmProvider === 'gemini') {
        return jsonResp({ok:true, models: [
          {id:'gemini-2.5-pro-preview-06-05', label:'Gemini 2.5 Pro'},
          {id:'gemini-2.5-flash-preview-05-20', label:'Gemini 2.5 Flash'},
          {id:'gemini-2.0-flash', label:'Gemini 2.0 Flash'},
          {id:'gemini-2.0-flash-lite', label:'Gemini 2.0 Flash Lite'}
        ]});
      } else if (lmProvider === 'grok') {
        return jsonResp({ok:true, models: [
          {id:'grok-3', label:'Grok 3'},
          {id:'grok-3-mini', label:'Grok 3 Mini'},
          {id:'grok-2', label:'Grok 2'}
        ]});
      } else if (lmProvider === 'ollama') {
        var ollamaUrl = getMetaKey('ollamaUrl') || 'http://localhost:11434';
        try {
          var resp = UrlFetchApp.fetch(ollamaUrl + '/api/tags', {muteHttpExceptions: true});
          if (resp.getResponseCode() !== 200) throw new Error('Ollama unavailable');
          var json = JSON.parse(resp.getContentText());
          var models = [];
          if (json.models) {
            for (var i = 0; i < json.models.length; i++) {
              models.push({id: json.models[i].name, label: json.models[i].name});
            }
          }
          return jsonResp({ok:true, models: models});
        } catch(olErr) {
          return jsonResp({ok:true, models: [{id:'llama3.1', label:'Llama 3.1'}, {id:'mistral', label:'Mistral'}, {id:'qwen2.5', label:'Qwen 2.5'}]});
        }
      }
      return jsonResp({ok:false, error:'Unknown provider: ' + lmProvider});
    } catch(err) {
      return jsonResp({ok:false, error: err.message});
    }
  }

  if (action === 'dprice_score') {
    var d = p.d ? JSON.parse(p.d) : {};
    var name = d.name || '';
    var provider = d.provider || getMetaKey('activeProvider') || 'anthropic';
    var model = d.model || getDefaultModelForProvider(provider);
    var context = d.context || '';
    if (!name) return jsonResp({ok:false, error:'no company name'});
    try {
      var result = scoreDPrice(name, provider, model, context);
      return jsonResp({ok:true, data: result});
    } catch(err) {
      return jsonResp({ok:false, error: err.message});
    }
  }

  if (action === 'get_finance') {
    var d = p.d ? JSON.parse(p.d) : {};
    var name = d.name || '';
    if (!name) return jsonResp({ok:false, error:'no company name'});
    try {
      var result = fetchFinanceData(name);
      return jsonResp({ok:true, data: result});
    } catch(err) {
      return jsonResp({ok:false, error: err.message});
    }
  }

  if (action === 'load') return loadData();

  // ---- write actions (all use lock) ----
  var lock = LockService.getScriptLock();
  lock.waitLock(15000);
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();

    if (action === 'save_companies') {
      var rows = p.d ? JSON.parse(p.d) : [];
      writeSheet(ss.getSheetByName('companies'), C_HEADERS, rows);
      return jsonResp({ok:true});
    }

    if (action === 'append_companies') {
      var rows = p.d ? JSON.parse(p.d) : [];
      appendSheet(ss.getSheetByName('companies'), C_HEADERS, rows);
      return jsonResp({ok:true});
    }

    if (action === 'save_activities') {
      // clear + write first chunk
      var rows = p.d ? JSON.parse(p.d) : [];
      writeSheet(ss.getSheetByName('activities'), A_HEADERS, rows);
      return jsonResp({ok:true});
    }

    if (action === 'append_activities') {
      // append without clearing
      var rows = p.d ? JSON.parse(p.d) : [];
      appendSheet(ss.getSheetByName('activities'), A_HEADERS, rows);
      return jsonResp({ok:true});
    }

    if (action === 'save_meta') {
      var meta = p.d ? JSON.parse(p.d) : {};
      saveMeta(ss, meta);
      return jsonResp({ok:true});
    }

    if (action === 'save_all') {
      // Full save: companies + activities + meta in one request (via POST)
      var all = p.d ? JSON.parse(p.d) : {};
      if (all.companies) writeSheet(ss.getSheetByName('companies'), C_HEADERS, all.companies);
      if (all.activities) writeSheet(ss.getSheetByName('activities'), A_HEADERS, all.activities);
      if (all.meta) saveMeta(ss, all.meta);
      return jsonResp({ok:true, ts: new Date().toISOString()});
    }
  } finally {
    lock.releaseLock();
  }
  return jsonResp({error:'unknown action'});
}

function doPost(e) {
  try {
    var raw = e.postData.contents;
    var ct = e.postData.type || '';
    var body;
    // Form POST sends url-encoded: postData=JSON
    if (ct.indexOf('form') >= 0) {
      // In url-encoded format, + means space. Replace before decoding.
      var decoded = decodeURIComponent(raw.replace(/\\+/g, '%20'));
      // Format: postData=JSON_STRING
      var eqIdx = decoded.indexOf('=');
      if (eqIdx >= 0) {
        body = JSON.parse(decoded.substring(eqIdx + 1));
      }
      if (!body) return jsonResp({error: 'no postData field'});
    } else {
      body = JSON.parse(raw);
    }
    // body = {action: '...', d: 'json string'}
    var action = body.action || 'save';
    var p = {action: action};
    if (body.d) p.d = body.d;
    return doGet({parameter: p});
  } catch(err) {
    return jsonResp({error: err.message});
  }
}

function loadData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var companies = sheetToArray(ss.getSheetByName('companies'), C_HEADERS);
  var activities = sheetToArray(ss.getSheetByName('activities'), A_HEADERS);
  var metaSheet = ss.getSheetByName('meta');
  var meta = {};
  if (metaSheet && metaSheet.getLastRow() > 1) {
    var mData = metaSheet.getRange(2, 1, metaSheet.getLastRow()-1, 2).getValues();
    mData.forEach(function(r){ meta[r[0]] = r[1]; });
  }
  return jsonResp({companies:companies, activities:activities, meta:meta});
}

function writeSheet(sheet, headers, rows) {
  sheet.clear();
  var data = [headers];
  for (var i = 0; i < rows.length; i++) {
    var row = [];
    for (var j = 0; j < headers.length; j++) {
      row.push(rows[i][headers[j]] !== undefined ? String(rows[i][headers[j]]) : '');
    }
    data.push(row);
  }
  sheet.getRange(1, 1, data.length, headers.length).setValues(data);
}

function saveMeta(ss, meta) {
  var ms = ss.getSheetByName('meta');
  // Preserve protected keys (like dadataKey) that shouldn't be overwritten by save_all
  var protectedKeys = ['dadataKey', 'checkoKey', 'anthropicKey', 'openaiKey', 'geminiKey', 'grokKey', 'ollamaUrl', 'activeProvider'];
  var preserved = {};
  if (ms.getLastRow() >= 2) {
    var existing = ms.getRange(2, 1, ms.getLastRow()-1, 2).getValues();
    for (var p = 0; p < existing.length; p++) {
      var pk = String(existing[p][0]).trim();
      if (protectedKeys.indexOf(pk) >= 0 && !meta[pk]) {
        preserved[pk] = existing[p][1];
      }
    }
  }
  ms.clear();
  ms.appendRow(['key','value']);
  var keys = Object.keys(meta);
  for (var i = 0; i < keys.length; i++) {
    var k = keys[i], v = meta[k];
    ms.appendRow([k, typeof v === 'object' ? JSON.stringify(v) : String(v)]);
  }
  // Re-add preserved keys
  var pKeys = Object.keys(preserved);
  for (var j = 0; j < pKeys.length; j++) {
    ms.appendRow([pKeys[j], preserved[pKeys[j]]]);
  }
}

function appendSheet(sheet, headers, rows) {
  if (!rows || rows.length === 0) return;
  var data = [];
  for (var i = 0; i < rows.length; i++) {
    var row = [];
    for (var j = 0; j < headers.length; j++) {
      row.push(rows[i][headers[j]] !== undefined ? String(rows[i][headers[j]]) : '');
    }
    data.push(row);
  }
  var lastRow = sheet.getLastRow();
  sheet.getRange(lastRow + 1, 1, data.length, headers.length).setValues(data);
}

function sheetToArray(sheet, expectedHeaders) {
  if (!sheet || sheet.getLastRow() < 2) return [];
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  var result = [];
  for (var i = 1; i < data.length; i++) {
    var obj = {};
    for (var j = 0; j < headers.length; j++) {
      obj[headers[j]] = data[i][j];
      if (headers[j] === 'stageOrder') obj[headers[j]] = parseInt(data[i][j]) || 0;
    }
    result.push(obj);
  }
  return result;
}

function getMetaKey(keyName) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ms = ss.getSheetByName('meta');
  if (!ms || ms.getLastRow() < 2) return '';
  var data = ms.getRange(2, 1, ms.getLastRow()-1, 2).getValues();
  for (var i = 0; i < data.length; i++) {
    if (String(data[i][0]).trim() === keyName) return String(data[i][1]).trim();
  }
  return '';
}

function setMetaKey(keyName, value) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var ms = ss.getSheetByName('meta');
  if (!ms) return;
  if (ms.getLastRow() >= 2) {
    var data = ms.getRange(2, 1, ms.getLastRow()-1, 2).getValues();
    for (var i = 0; i < data.length; i++) {
      if (String(data[i][0]).trim() === keyName) {
        ms.getRange(i + 2, 2).setValue(value);
        return;
      }
    }
  }
  ms.appendRow([keyName, value]);
}

function getDadataKey() { return getMetaKey('dadataKey'); }
function setDadataKey(key) { setMetaKey('dadataKey', key); }
function getCheckoKey() { return getMetaKey('checkoKey'); }
function setCheckoKey(key) { setMetaKey('checkoKey', key); }

function fetchFinanceData(companyName) {
  var apiKey = getDadataKey();
  if (!apiKey) throw new Error('NO_DADATA_KEY');

  var result = {found: false, name: companyName, inn: null, fullName: null,
    year: null, revenue: null, income: null, expense: null, assets: null,
    employees: null, taxSystem: null, debt: null, penalty: null,
    okved: null, address: null, status: null, source: 'dadata.ru'};

  var dadataHeaders = {
    'Content-Type': 'application/json',
    'Accept': 'application/json',
    'Authorization': 'Token ' + apiKey
  };
  var dadataOpts = {muteHttpExceptions: true, headers: dadataHeaders, method: 'post'};

  // Step 1: DaData ‚Äî search company by name ‚Üí get INN + details
  var suggestUrl = 'https://suggestions.dadata.ru/suggestions/api/4_1/rs/suggest/party';
  dadataOpts.payload = JSON.stringify({query: companyName, count: 5});
  var resp1 = UrlFetchApp.fetch(suggestUrl, dadataOpts);
  var code1 = resp1.getResponseCode();
  if (code1 === 403) throw new Error('DADATA_KEY_INVALID');
  if (code1 !== 200) throw new Error('DaData suggest error: ' + code1);
  var json1 = JSON.parse(resp1.getContentText());
  if (!json1.suggestions || json1.suggestions.length === 0) return result;

  // Pick first active company (prefer ACTIVE status)
  var chosen = json1.suggestions[0];
  for (var i = 0; i < json1.suggestions.length; i++) {
    var s = json1.suggestions[i];
    if (s.data && s.data.state && s.data.state.status === 'ACTIVE') {
      chosen = s;
      break;
    }
  }

  var inn = chosen.data.inn;
  result.inn = inn;
  result.fullName = chosen.data.name ? chosen.data.name.full_with_opf : chosen.value;
  result.name = chosen.data.name ? (chosen.data.name.short_with_opf || chosen.value) : chosen.value;
  if (chosen.data.okved) result.okved = chosen.data.okved;
  if (chosen.data.address && chosen.data.address.value) result.address = chosen.data.address.value;
  if (chosen.data.state && chosen.data.state.status) result.status = chosen.data.state.status;
  result.found = true;
  result.source = 'dadata.ru';

  // Step 2: checko.ru ‚Äî get financial data by INN (100 free requests/day)
  var checkoKey = getCheckoKey();
  if (checkoKey && inn) {
    try {
      var finUrl = 'https://api.checko.ru/v2/finances?key=' + checkoKey + '&inn=' + inn;
      var finOpts = {muteHttpExceptions: true};
      var finResp = UrlFetchApp.fetch(finUrl, finOpts);
      var finCode = finResp.getResponseCode();
      if (finCode === 200) {
        var finJson = JSON.parse(finResp.getContentText());
        if (finJson && finJson.data) {
          var fd = finJson.data;
          var years = Object.keys(fd).filter(function(k){ return /^\\d{4}$/.test(k); }).sort().reverse();
          if (years.length > 0) {
            var latestYear = years[0];
            var yd = fd[latestYear];
            result.year = parseInt(latestYear);
            if (yd['2110'] !== undefined) result.revenue = parseFloat(yd['2110']);
            if (yd['2400'] !== undefined) result.income = parseFloat(yd['2400']);
            if (yd['2120'] !== undefined) result.expense = Math.abs(parseFloat(yd['2120']));
            if (yd['1600'] !== undefined) result.assets = parseFloat(yd['1600']);
            result.source = '–§–ù–° (checko.ru)';
          }
        }
      } else if (finCode === 429) {
        result.checkoError = 'RATE_LIMIT';
      } else if (finCode === 402) {
        result.checkoError = 'PAYMENT_REQUIRED';
      } else if (finCode === 403) {
        var body403 = '';
        try { body403 = finResp.getContentText().toLowerCase(); } catch(e403){}
        if (body403.indexOf('–ª–∏–º–∏—Ç') >= 0 || body403.indexOf('limit') >= 0 || body403.indexOf('rate') >= 0 || body403.indexOf('100') >= 0) {
          result.checkoError = 'RATE_LIMIT';
        } else {
          result.checkoError = 'KEY_INVALID';
        }
      } else {
        result.checkoError = 'HTTP_' + finCode;
      }
    } catch(checkoErr) {
      result.checkoError = checkoErr.message;
    }
  } else if (!checkoKey) {
    result.checkoError = 'NO_KEY';
  }

  return result;
}

function fetchCompanyWebsite(companyName, inn) {
  var opts = {muteHttpExceptions: true, followRedirects: true};
  var siteUrl = '';

  // Strategy 1: Checko API ‚Äî get company website by INN (contacts)
  if (inn) {
    var checkoKey = getCheckoKey();
    if (checkoKey) {
      try {
        var cUrl = 'https://api.checko.ru/v2/company?key=' + checkoKey + '&inn=' + inn + '&extra=contacts';
        var cResp = UrlFetchApp.fetch(cUrl, {muteHttpExceptions: true});
        if (cResp.getResponseCode() === 200) {
          var cText = cResp.getContentText();
          // Find company URL in JSON response (skip API/service URLs)
          var urls = cText.match(/https?:\\/\\/[^"\\\\\\s]+/g);
          if (urls) {
            for (var ui = 0; ui < urls.length; ui++) {
              var u = urls[ui];
              if (u.indexOf('checko') < 0 && u.indexOf('api.') < 0 && u.indexOf('nalog') < 0) {
                siteUrl = u;
                break;
              }
            }
          }
        }
      } catch(e) {}
    }
  }

  // Strategy 2: DaData ‚Äî derive domain from company email
  if (!siteUrl && inn) {
    var dadataKey = getDadataKey();
    if (dadataKey) {
      try {
        var dResp = UrlFetchApp.fetch('https://suggestions.dadata.ru/suggestions/api/4_1/rs/findById/party', {
          muteHttpExceptions: true, method: 'post',
          headers: {'Content-Type':'application/json','Accept':'application/json','Authorization':'Token ' + dadataKey},
          payload: JSON.stringify({query: inn})
        });
        if (dResp.getResponseCode() === 200) {
          var dJson = JSON.parse(dResp.getContentText());
          if (dJson.suggestions && dJson.suggestions.length > 0 && dJson.suggestions[0].data.emails) {
            var emails = dJson.suggestions[0].data.emails;
            if (emails.length > 0) {
              var domain = emails[0].value.split('@')[1];
              if (domain && domain.indexOf('mail.') < 0 && domain.indexOf('yandex') < 0 && domain.indexOf('gmail') < 0 && domain.indexOf('rambler') < 0) {
                siteUrl = 'https://' + domain;
              }
            }
          }
        }
      } catch(e) {}
    }
  }

  // Fetch and parse site content
  if (siteUrl) {
    if (siteUrl.indexOf('http') !== 0) siteUrl = 'https://' + siteUrl;
    try {
      var sResp = UrlFetchApp.fetch(siteUrl, opts);
      if (sResp.getResponseCode() === 200) {
        var sHtml = sResp.getContentText();
        if (sHtml.length > 500) {
          var text = sHtml.replace(/<script[^>]*>[\\s\\S]*?<\\/script>/gi, '')
                          .replace(/<style[^>]*>[\\s\\S]*?<\\/style>/gi, '')
                          .replace(/<[^>]+>/g, ' ').replace(/&nbsp;/g, ' ').replace(/\\s+/g, ' ').trim();
          if (text.length > 100) return text.substring(0, 3000);
        }
      }
    } catch(e) {}
  }
  return '';
}

function fetchCompanyNews(companyName) {
  var allTitles = [];
  var opts = {muteHttpExceptions: true, followRedirects: true};

  // Source 1: Google News RSS ‚Äî general company news
  try {
    var rssUrl = 'https://news.google.com/rss/search?q=' + encodeURIComponent(companyName + ' –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫') + '&hl=ru&gl=RU&ceid=RU:ru';
    var rssResp = UrlFetchApp.fetch(rssUrl, opts);
    if (rssResp.getResponseCode() === 200) {
      var rssText = rssResp.getContentText();
      var titles = rssText.match(/<title[^>]*>([\\s\\S]*?)<\\/title>/gi);
      if (titles) {
        for (var i = 1; i < titles.length && i < 20; i++) {
          var t = titles[i].replace(/<[^>]+>/g, '').replace(/<!\\[CDATA\\[|\\]\\]>/g, '').trim();
          if (t.length > 20) allTitles.push(t);
        }
      }
      var descs = rssText.match(/<description[^>]*>([\\s\\S]*?)<\\/description>/gi);
      if (descs) {
        for (var j = 1; j < descs.length && j < 15; j++) {
          var desc = descs[j].replace(/<[^>]+>/g, '').replace(/<!\\[CDATA\\[|\\]\\]>/g, '')
                             .replace(/&[a-z#0-9]+;/gi, ' ').replace(/\\s+/g, ' ').trim();
          if (desc.length > 30 && desc.length < 500) allTitles.push(desc);
        }
      }
    }
  } catch(e) {}

  // Source 2: Google News RSS ‚Äî financial news specifically
  try {
    var rssUrl2 = 'https://news.google.com/rss/search?q=' + encodeURIComponent(companyName + ' —Ñ–∏–Ω–∞–Ω—Å—ã –¥–æ–ª–≥–∏') + '&hl=ru&gl=RU&ceid=RU:ru';
    var rssResp2 = UrlFetchApp.fetch(rssUrl2, opts);
    if (rssResp2.getResponseCode() === 200) {
      var rssText2 = rssResp2.getContentText();
      var titles2 = rssText2.match(/<title[^>]*>([\\s\\S]*?)<\\/title>/gi);
      if (titles2) {
        for (var k = 1; k < titles2.length && k < 10; k++) {
          var t2 = titles2[k].replace(/<[^>]+>/g, '').replace(/<!\\[CDATA\\[|\\]\\]>/g, '').trim();
          if (t2.length > 20) allTitles.push(t2);
        }
      }
    }
  } catch(e) {}

  // Deduplicate
  var seen = {};
  var unique = [];
  for (var u = 0; u < allTitles.length; u++) {
    var key = allTitles[u].substring(0, 40).toLowerCase();
    if (!seen[key]) { seen[key] = true; unique.push(allTitles[u]); }
  }
  return unique.join(' | ').substring(0, 3000);
}

function callClaude(apiKey, model, systemPrompt, userMessage) {
  var url = 'https://api.anthropic.com/v1/messages';
  var payload = {
    model: model,
    max_tokens: 2000,
    system: systemPrompt,
    messages: [{role: 'user', content: userMessage}]
  };
  var opts = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01'
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  var resp = UrlFetchApp.fetch(url, opts);
  var code = resp.getResponseCode();
  if (code === 401) throw new Error('ANTHROPIC_KEY_INVALID');
  if (code !== 200) throw new Error('Claude API error: ' + code + ' ' + resp.getContentText().substring(0, 200));
  var json = JSON.parse(resp.getContentText());
  if (!json.content || json.content.length === 0) throw new Error('Empty Claude response');
  return json.content[0].text;
}

function callOpenAI(apiKey, model, systemPrompt, userMessage) {
  var url = 'https://api.openai.com/v1/chat/completions';
  var payload = {
    model: model,
    max_tokens: 2000,
    messages: [
      {role: 'system', content: systemPrompt},
      {role: 'user', content: userMessage}
    ]
  };
  var opts = {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + apiKey },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  var resp = UrlFetchApp.fetch(url, opts);
  var code = resp.getResponseCode();
  if (code === 401) throw new Error('OPENAI_KEY_INVALID');
  if (code !== 200) throw new Error('OpenAI API error: ' + code + ' ' + resp.getContentText().substring(0, 200));
  var json = JSON.parse(resp.getContentText());
  if (!json.choices || json.choices.length === 0) throw new Error('Empty OpenAI response');
  return json.choices[0].message.content;
}

function callGemini(apiKey, model, systemPrompt, userMessage) {
  var url = 'https://generativelanguage.googleapis.com/v1beta/models/' + model + ':generateContent?key=' + apiKey;
  var payload = {
    systemInstruction: { parts: [{ text: systemPrompt }] },
    contents: [{ role: 'user', parts: [{ text: userMessage }] }],
    generationConfig: { maxOutputTokens: 2000 }
  };
  var opts = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  var resp = UrlFetchApp.fetch(url, opts);
  var code = resp.getResponseCode();
  if (code === 400 || code === 403) throw new Error('GEMINI_KEY_INVALID');
  if (code !== 200) throw new Error('Gemini API error: ' + code + ' ' + resp.getContentText().substring(0, 200));
  var json = JSON.parse(resp.getContentText());
  if (!json.candidates || json.candidates.length === 0) throw new Error('Empty Gemini response');
  return json.candidates[0].content.parts[0].text;
}

function callGrok(apiKey, model, systemPrompt, userMessage) {
  var url = 'https://api.x.ai/v1/chat/completions';
  var payload = {
    model: model,
    max_tokens: 2000,
    messages: [
      {role: 'system', content: systemPrompt},
      {role: 'user', content: userMessage}
    ]
  };
  var opts = {
    method: 'post',
    contentType: 'application/json',
    headers: { 'Authorization': 'Bearer ' + apiKey },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  var resp = UrlFetchApp.fetch(url, opts);
  var code = resp.getResponseCode();
  if (code === 401) throw new Error('GROK_KEY_INVALID');
  if (code !== 200) throw new Error('Grok API error: ' + code + ' ' + resp.getContentText().substring(0, 200));
  var json = JSON.parse(resp.getContentText());
  if (!json.choices || json.choices.length === 0) throw new Error('Empty Grok response');
  return json.choices[0].message.content;
}

function callOllama(baseUrl, model, systemPrompt, userMessage) {
  var url = (baseUrl || 'http://localhost:11434') + '/api/chat';
  var payload = {
    model: model,
    messages: [
      {role: 'system', content: systemPrompt},
      {role: 'user', content: userMessage}
    ],
    stream: false
  };
  var opts = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };
  var resp = UrlFetchApp.fetch(url, opts);
  var code = resp.getResponseCode();
  if (code !== 200) throw new Error('Ollama error: ' + code + ' ' + resp.getContentText().substring(0, 200));
  var json = JSON.parse(resp.getContentText());
  if (!json.message || !json.message.content) throw new Error('Empty Ollama response');
  return json.message.content;
}

function callLLM(provider, model, systemPrompt, userMessage) {
  if (provider === 'anthropic') {
    var aKey = getMetaKey('anthropicKey');
    if (!aKey) throw new Error('NO_ANTHROPIC_KEY');
    return callClaude(aKey, model, systemPrompt, userMessage);
  } else if (provider === 'openai') {
    var oKey = getMetaKey('openaiKey');
    if (!oKey) throw new Error('NO_OPENAI_KEY');
    return callOpenAI(oKey, model, systemPrompt, userMessage);
  } else if (provider === 'gemini') {
    var gKey = getMetaKey('geminiKey');
    if (!gKey) throw new Error('NO_GEMINI_KEY');
    return callGemini(gKey, model, systemPrompt, userMessage);
  } else if (provider === 'grok') {
    var xKey = getMetaKey('grokKey');
    if (!xKey) throw new Error('NO_GROK_KEY');
    return callGrok(xKey, model, systemPrompt, userMessage);
  } else if (provider === 'ollama') {
    var olUrl = getMetaKey('ollamaUrl');
    return callOllama(olUrl, model, systemPrompt, userMessage);
  }
  throw new Error('UNKNOWN_PROVIDER: ' + provider);
}

function getDefaultModelForProvider(provider) {
  var defaults = {
    anthropic: 'claude-sonnet-4-6',
    openai: 'gpt-4o',
    gemini: 'gemini-2.0-flash',
    grok: 'grok-3',
    ollama: 'llama3.1'
  };
  return defaults[provider] || 'claude-sonnet-4-6';
}

function scoreDPrice(companyName, provider, model, customContext) {
  provider = provider || getMetaKey('activeProvider') || 'anthropic';

  // 1. Get financial data (reuse existing)
  var finData = {};
  try { finData = fetchFinanceData(companyName); } catch(e) {}

  // 2. Get website content (pass INN from finData for Checko lookup)
  var websiteText = fetchCompanyWebsite(companyName, finData.inn);

  // 3. Get news
  var newsText = fetchCompanyNews(companyName);

  // 4. Build prompt
  var systemPrompt = '–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ –≤ –æ–±–ª–∞—Å—Ç–∏ PropTech –∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å–Ω–æ–π –æ—Ç—Ä–∞—Å–ª–∏ –†–æ—Å—Å–∏–∏. ' +
    '–ö–æ–º–ø–∞–Ω–∏—è DPrice (dprice.ru) —Ä–∞–∑—Ä–∞–±–æ—Ç–∞–ª–∞ —Å–∏—Å—Ç–µ–º—É –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–æ–≤. ' +
    'DPrice –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—É—â–∏–π –∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Å–ø—Ä–æ—Å –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–æ–Ω –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–µ–Ω –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–±—ã–ª–∏ –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞. ' +
    '–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –æ—Ü–µ–Ω–∏—Ç—å –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Ç–æ–≥–æ, —á—Ç–æ –¥–∞–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è-–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫ –±—É–¥–µ—Ç –≤–æ—Å–ø—Ä–∏–∏–º—á–∏–≤–∞ –∫ –ø–æ–∫—É–ø–∫–µ —Å–∏—Å—Ç–µ–º—ã DPrice. ' +
    '–¢—ã –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–∞–Ω–∏—é –ø–æ —Å–ª–µ–¥—É—é—â–∏–º —Ñ–∞–∫—Ç–æ—Ä–∞–º –∏ –¥–∞—Ç—å –∫–∞–∂–¥–æ–º—É –æ—Ü–µ–Ω–∫—É –æ—Ç 0 –¥–æ 10:\\n\\n' +
    '1. financial_stability - –¢–µ–∫—É—â–∞—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å. –®–∫–∞–ª–∞:\\n' +
    '   10: –æ—Ç–ª–∏—á–Ω–æ, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–æ—Å—Ç –±–µ–∑ –ø—Ä–æ–±–ª–µ–º\\n' +
    '   7-9: —Ö–æ—Ä–æ—à–æ, –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏\\n' +
    '   4-6: —Å—Ä–µ–¥–Ω–µ, –µ—Å—Ç—å –∑–∞–º–µ—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (—Å–Ω–∏–∂–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏, —Ä–æ—Å—Ç –¥–æ–ª–≥–æ–≤)\\n' +
    '   1-3: –ø–ª–æ—Ö–æ, —Å–µ—Ä—å—ë–∑–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏ (–∑–∞–ø—Ä–æ—Å –ø–æ–º–æ—â–∏, —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –¥–æ–ª–≥–æ–≤, —É–≥—Ä–æ–∑–∞ –±–∞–Ω–∫—Ä–æ—Ç—Å—Ç–≤–∞)\\n' +
    '   –ü–†–ê–í–ò–õ–û: –ï—Å–ª–∏ –∫–æ–º–ø–∞–Ω–∏—è –∑–∞–ø—Ä–∞—à–∏–≤–∞–ª–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –ø–æ–º–æ—â—å —É –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–∞, —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∏—Ä—É–µ—Ç –¥–æ–ª–≥–∏, –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∫—Ä–∏–∑–∏—Å–µ ‚Äî –æ—Ü–µ–Ω–∫–∞ –ù–ï –ú–û–ñ–ï–¢ –±—ã—Ç—å –≤—ã—à–µ 3, –¥–∞–∂–µ –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –±–æ–ª—å—à–∞—è. –†–∞–∑–º–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏ –ù–ï —Ä–∞–≤–µ–Ω —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏!\\n' +
    '2. innovation_readiness - –í–æ—Å–ø—Ä–∏–∏–º—á–∏–≤–æ—Å—Ç—å –∫ –∏–Ω–Ω–æ–≤–∞—Ü–∏—è–º –∏ —Ü–∏—Ñ—Ä–æ–≤–∏–∑–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ IT, BIM, CRM, PropTech)\\n' +
    '3. business_aggressiveness - –ë–∏–∑–Ω–µ—Å-–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ—Å—Ç—å, —Å—Ç—Ä–µ–º–ª–µ–Ω–∏–µ –∫ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º\\n' +
    '4. management_activity - –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç–∞ (–ø—É–±–ª–∏—á–Ω–æ—Å—Ç—å —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–∞, —É—á–∞—Å—Ç–∏–µ –≤ –æ—Ç—Ä–∞—Å–ª–µ–≤—ã—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è—Ö)\\n' +
    '5. digital_presence - –ü—Ä–∏—Å—É—Ç—Å—Ç–≤–∏–µ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ (—Å–∞–π—Ç, —Å–æ—Ü—Å–µ—Ç–∏, —Ü–∏—Ñ—Ä–æ–≤–æ–π –º–∞—Ä–∫–µ—Ç–∏–Ω–≥)\\n' +
    '6. dynamic_pricing_experience - –û–ø—ã—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ —Ü–µ–Ω–æ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –ª–∏ —Ä–∞–Ω–µ–µ, –∫–∞–∫–æ–π –æ–ø—ã—Ç)\\n' +
    '7. it_team_strength - –ù–∞–ª–∏—á–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –ò–¢-–∫–æ–º–∞–Ω–¥—ã (–µ—Å–ª–∏ —Å–∏–ª—å–Ω–∞—è - –º–æ–≥—É—Ç –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–¥–µ–ª–∞—Ç—å –î–¶–û —Å–∞–º–∏, —ç—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏)\\n\\n' +
    '–í–ê–ñ–ù–û: –û—Ü–µ–Ω–∫–∞ it_team_strength –æ–±—Ä–∞—Ç–Ω–∞—è - —á–µ–º —Å–∏–ª—å–Ω–µ–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ò–¢-–∫–æ–º–∞–Ω–¥–∞, —Ç–µ–º –ù–ò–ñ–ï –æ—Ü–µ–Ω–∫–∞ (—Ç.–∫. –æ–Ω–∏ –º–æ–≥—É—Ç —Å–¥–µ–ª–∞—Ç—å —Å–≤–æ—ë —Ä–µ—à–µ–Ω–∏–µ).\\n\\n' +
    '–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –¥–ª—è financial_stability: –ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∞—è –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–µ–π (–∑–∞ –ø—Ä–æ—à–ª—ã–π –≥–æ–¥). –ù–æ–≤–æ—Å—Ç–∏ –∏ —Ç–µ–∫—É—â–∏–µ —Å–æ–±—ã—Ç–∏—è –ü–†–ò–û–†–ò–¢–ï–¢–ù–ï–ï —Ñ–æ—Ä–º–∞–ª—å–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π. –ï—Å–ª–∏ –≤ –Ω–æ–≤–æ—Å—Ç—è—Ö —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è: –∑–∞–ø—Ä–æ—Å—ã –æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø–æ–º–æ—â–∏, —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è –¥–æ–ª–≥–æ–≤, –ø—Ä–æ–±–ª–µ–º—ã —Å –∫—Ä–µ–¥–∏—Ç–æ—Ä–∞–º–∏, –ø–∞–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–∞–∂, —Å—É–¥–µ–±–Ω—ã–µ –∏—Å–∫–∏, –∑–∞–¥–µ—Ä–∂–∫–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ ‚Äî –æ—Ü–µ–Ω–∫–∞ financial_stability –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ù–ò–ó–ö–û–ô (1-4), –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ñ–æ—Ä–º–∞–ª—å–Ω–æ–π –≤—ã—Ä—É—á–∫–∏ –∏ –∞–∫—Ç–∏–≤–æ–≤. –í—ã—Å–æ–∫–∞—è –≤—ã—Ä—É—á–∫–∞ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º ‚Äî —ç—Ç–æ –ù–ï —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å.\\n\\n' +
    '–¢—ã –æ–±—è–∑–∞–Ω —É—á–∏—Ç—ã–≤–∞—Ç—å –í–°–Æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –≤–∫–ª—é—á–∞—è —Ä–∞–∑–¥–µ–ª—ã –ù–û–í–û–°–¢–ò –∏ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –Ω–æ–≤–æ—Å—Ç–µ–π –∏ –æ—Ç –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏–º–µ–µ—Ç –ë–û–õ–¨–®–ò–ô –≤–µ—Å, —á–µ–º —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–µ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏, —Ç.–∫. –æ–Ω–∞ –±–æ–ª–µ–µ –∞–∫—Ç—É–∞–ª—å–Ω–∞.\\n\\n' +
    '–ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª dprice (0-10) - –∏–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∫—É–ø–∫–∏ DPrice –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.\\n\\n' +
    '–û—Ç–≤–µ—Ç—å —Å—Ç—Ä–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON –±–µ–∑ markdown-–æ–±–µ—Ä—Ç–∫–∏:\\n' +
    '{"dprice": —á–∏—Å–ª–æ, "factors": {"financial_stability": {"score": —á–∏—Å–ª–æ, "comment": "–∫—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"}, ' +
    '"innovation_readiness": {"score": —á–∏—Å–ª–æ, "comment": "..."}, "business_aggressiveness": {"score": —á–∏—Å–ª–æ, "comment": "..."}, ' +
    '"management_activity": {"score": —á–∏—Å–ª–æ, "comment": "..."}, "digital_presence": {"score": —á–∏—Å–ª–æ, "comment": "..."}, ' +
    '"dynamic_pricing_experience": {"score": —á–∏—Å–ª–æ, "comment": "..."}, "it_team_strength": {"score": —á–∏—Å–ª–æ, "comment": "..."}}, ' +
    '"summary": "–æ–±—â–∏–π –∞–Ω–∞–ª–∏–∑ 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è", "recommendation": "—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø—Ä–æ–¥–∞–∂–µ 1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è"}';

  var userMessage = '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–æ–º–ø–∞–Ω–∏—é-–∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞. –ò—Å–ø–æ–ª—å–∑—É–π –í–°–ï —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –æ–± —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º. –û–±—Ä–∞—â–∞–π –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Ç–µ–∫—É—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã, —Å–∫–∞–Ω–¥–∞–ª—ã, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ç—Ä—É–¥–Ω–æ—Å—Ç–∏, –∑–∞–ø—Ä–æ—Å—ã –≥–æ—Å–ø–æ–º–æ—â–∏.\\n\\n';
  userMessage += '=== –†–ï–ö–í–ò–ó–ò–¢–´ ===\\n';
  userMessage += '–ù–∞–∑–≤–∞–Ω–∏–µ: ' + companyName + '\\n';
  if (finData.inn) userMessage += '–ò–ù–ù: ' + finData.inn + '\\n';
  if (finData.fullName) userMessage += '–ü–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ: ' + finData.fullName + '\\n';
  if (finData.okved) userMessage += '–û–ö–í–≠–î: ' + finData.okved + '\\n';
  if (finData.address) userMessage += '–ê–¥—Ä–µ—Å: ' + finData.address + '\\n';
  if (finData.status) userMessage += '–°—Ç–∞—Ç—É—Å: ' + finData.status + '\\n';

  userMessage += '\\n=== –§–ò–ù–ê–ù–°–´ ===\\n';
  if (finData.year) userMessage += '–ì–æ–¥: ' + finData.year + '\\n';
  if (finData.revenue !== null && finData.revenue !== undefined) userMessage += '–í—ã—Ä—É—á–∫–∞: ' + finData.revenue + ' —Ä—É–±.\\n';
  if (finData.income !== null && finData.income !== undefined) userMessage += '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å: ' + finData.income + ' —Ä—É–±.\\n';
  if (finData.expense !== null && finData.expense !== undefined) userMessage += '–†–∞—Å—Ö–æ–¥—ã: ' + finData.expense + ' —Ä—É–±.\\n';
  if (finData.assets !== null && finData.assets !== undefined) userMessage += '–ê–∫—Ç–∏–≤—ã: ' + finData.assets + ' —Ä—É–±.\\n';
  if (finData.employees) userMessage += '–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏: ' + finData.employees + '\\n';
  if (!finData.found) userMessage += '(–§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ä–µ–µ—Å—Ç—Ä–µ)\\n';

  if (websiteText) {
    userMessage += '\\n=== –ö–û–ù–¢–ï–ù–¢ –°–ê–ô–¢–ê –ö–û–ú–ü–ê–ù–ò–ò ===\\n' + websiteText + '\\n';
  }
  if (newsText) {
    userMessage += '\\n=== –ù–û–í–û–°–¢–ò –ò –£–ü–û–ú–ò–ù–ê–ù–ò–Ø ===\\n' + newsText + '\\n';
  }

  if (customContext) {
    userMessage += '\\n=== –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –û–¢ –ê–ù–ê–õ–ò–¢–ò–ö–ê ===\\n' + customContext + '\\n';
  }

  // 5. Call LLM
  var responseText = callLLM(provider, model, systemPrompt, userMessage);

  // 6. Parse JSON response
  // Remove potential markdown wrapping
  responseText = responseText.replace(/^\`\`\`json\\s*/i, '').replace(/\`\`\`\\s*$/i, '').trim();
  var parsed;
  try {
    parsed = JSON.parse(responseText);
  } catch(e) {
    // Try to extract JSON from text
    var jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);
    if (jsonMatch) {
      parsed = JSON.parse(jsonMatch[0]);
    } else {
      throw new Error('Failed to parse LLM response');
    }
  }
  // Add info about data sources
  parsed._sources = {
    finance: !!finData.found,
    website: websiteText.length,
    news: newsText.length,
    context: customContext ? customContext.length : 0
  };
  return parsed;
}

function jsonResp(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}`;

function gsSetDot(state, title) {
    const dot = document.getElementById('gsDot');
    const status = document.getElementById('gsStatus');
    if (dot) { dot.className = 'gs-dot ' + state; }
    if (status) { status.title = 'Google Sheets: ' + (title || state); }
}

function gsShowMsg(text, cls) {
    const el = document.getElementById('gsMsg');
    if (!el) return;
    el.textContent = text;
    el.className = 'gs-msg ' + cls;
}

// Apps Script fetch: GET for reads, POST-via-form for writes
// GET requests with redirect:'follow' work for small payloads (ping, load)
// For write operations, we use a hidden form POST + iframe to avoid CORS
// and URL length limits on the Apps Script 302 redirect chain
async function gsFetch(action, data) {
    const jsonData = data !== undefined ? (typeof data === 'string' ? data : JSON.stringify(data)) : '';

    // For read operations and small-data actions ‚Äî use simple GET (can read response)
    // POST-via-iframe can't read cross-origin response, so all actions needing response go through GET
    if (!jsonData || ['ping','load','debug','auth','list_users','add_user','delete_user','get_finance','check_dadata_key','set_dadata_key','set_checko_key','set_anthropic_key','set_openai_key','set_gemini_key','set_grok_key','set_ollama_url','set_active_provider','get_llm_keys_status','dprice_score','list_models'].includes(action)) {
        const url = new URL(gsUrl);
        url.searchParams.set('action', action);
        if (jsonData) url.searchParams.set('d', jsonData);
        const timeoutMs = (action === 'dprice_score') ? 120000 : 30000;
        console.log('[GS] GET:', action, 'URL length:', url.toString().length, 'timeout:', timeoutMs);
        const controller = new AbortController();
        const tid = setTimeout(() => controller.abort(), timeoutMs);
        let r;
        try {
            r = await fetch(url.toString(), { redirect: 'follow', signal: controller.signal });
        } finally { clearTimeout(tid); }
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const json = await r.json();
        if (json.error) throw new Error(json.error);
        return json;
    }

    // For write operations ‚Äî use form POST via hidden iframe
    // This avoids CORS issues because form submissions don't trigger CORS
    // We use a unique callback to get the response back
    console.log('[GS] POST-form:', action, 'data length:', jsonData.length);
    return gsPostViaForm(action, jsonData);
}

// POST data via hidden form + iframe to bypass CORS
// Apps Script doPost receives the data in e.postData.contents
function gsPostViaForm(action, jsonData) {
    return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
            cleanup();
            reject(new Error('Timeout'));
        }, 30000);

        const iframeName = 'gsFrame_' + Date.now();
        const iframe = document.createElement('iframe');
        iframe.name = iframeName;
        iframe.style.display = 'none';
        document.body.appendChild(iframe);

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = gsUrl;
        form.target = iframeName;
        form.style.display = 'none';

        // Send action and data as form field
        const input = document.createElement('textarea');
        input.name = 'postData';
        input.value = JSON.stringify({ action, d: jsonData });
        form.appendChild(input);

        document.body.appendChild(form);

        function cleanup() {
            clearTimeout(timeout);
            try { document.body.removeChild(form); } catch(e) {}
            setTimeout(() => {
                try { document.body.removeChild(iframe); } catch(e) {}
            }, 100);
        }

        // We can't read cross-origin iframe content, so we just wait for load
        // and assume success. The next gsLoad poll will verify.
        iframe.onload = () => {
            cleanup();
            resolve({ ok: true });
        };
        iframe.onerror = () => {
            cleanup();
            reject(new Error('Network error'));
        };

        form.submit();
    });
}

async function gsTest() {
    if (!gsUrl) { gsShowMsg('–í–≤–µ–¥–∏—Ç–µ URL', 'err'); return false; }
    gsSetDot('pending', '–ø—Ä–æ–≤–µ—Ä–∫–∞...');
    try {
        const data = await gsFetch('ping');
        if (data && data.ok) {
            gsSetDot('ok', '–ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
            gsShowMsg('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ! ' + data.ts, 'ok');
            return true;
        }
        gsSetDot('error', '–æ—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞');
        gsShowMsg('–û—à–∏–±–∫–∞: –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç', 'err');
        return false;
    } catch (e) {
        gsSetDot('error', '–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        gsShowMsg('–û—à–∏–±–∫–∞: ' + e.message, 'err');
        return false;
    }
}

async function gsLoad(silent) {
    if (!gsUrl) return;
    if (silent && gsSaving) return; // don't auto-load while saving (partial data risk)
    if (!silent) gsSetDot('pending', '–∑–∞–≥—Ä—É–∑–∫–∞...');
    try {
        const data = await gsFetch('load');
        if (data.error) throw new Error(data.error);
        const remoteComps = data.companies || [];
        const remoteActs = data.activities || [];

        // Safety: don't overwrite local data with empty/partial remote data during auto-sync
        if (silent && remoteComps.length === 0) {
            // Remote is empty ‚Äî nothing to sync, keep local data
            gsSetDot('ok', '—Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞');
            return;
        }
        if (silent && curData && curData.activities && curData.activities.length > 0 && remoteActs.length === 0) {
            // Remote has companies but no activities ‚Äî partial data, skip auto-sync
            // (likely save-in-progress or failed activities upload)
            gsSetDot('ok', '–Ω–µ–ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
            console.log('[GS] Skipping auto-sync: remote has no activities but local has', curData.activities.length);
            return;
        }

        // Check if data has changed
        const hash = JSON.stringify(remoteComps) + JSON.stringify(remoteActs);
        if (silent && hash === gsDataHash) return; // no changes
        gsDataHash = hash;

        // Apply data
        if (remoteComps.length > 0) {
            const newData = { companies: remoteComps, activities: remoteActs };
            // Restore meta
            if (data.meta) {
                if (data.meta.nWeeks) nWeeks = parseInt(data.meta.nWeeks) || 12;
                if (data.meta.eventsMeta) {
                    try {
                        const em = typeof data.meta.eventsMeta === 'string' ? JSON.parse(data.meta.eventsMeta) : data.meta.eventsMeta;
                        if (Array.isArray(em) && em.length > 0) {
                            EVENTS_META.length = 0;
                            em.forEach(e => EVENTS_META.push(e));
                            rebuildEventsDerived();
                        }
                    } catch(e) {}
                }
            }
            build(newData, true);
            rebuildCurrentView();
            // Update localStorage cache
            localStorage.setItem(LS_KEY, JSON.stringify({ curData, nWeeks, eventsMeta: EVENTS_META }));
            document.getElementById('upload').classList.add('gone');
        }
        gsSetDot('ok', '—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');
        if (!silent) gsShowMsg('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ —Ç–∞–±–ª–∏—Ü—ã (' + remoteComps.length + ' –∫–æ–º–ø., ' + remoteActs.length + ' –∞–∫—Ç.)', 'ok');
    } catch (e) {
        gsSetDot('error', '–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
        if (!silent) gsShowMsg('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + e.message, 'err');
    }
}

// Save all data to Google Sheets via form POST (no URL size limit)
let gsSaving = false; // lock to prevent gsLoad during save
async function gsSave(silent) {
    if (!gsUrl || !curData) return;
    if (gsSaving) return;
    gsSaving = true;
    gsSetDot('pending', '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    try {
        console.log('[GS] Starting save. Companies:', curData.companies?.length, 'Activities:', curData.activities?.length);

        // Send everything in one POST via form (no size limit!)
        const payload = {
            companies: curData.companies || [],
            activities: curData.activities || [],
            meta: { nWeeks, eventsMeta: EVENTS_META }
        };
        await gsFetch('save_all', payload);
        console.log('[GS] save_all done');

        // Update hash so polling doesn't reload our own changes
        gsDataHash = JSON.stringify(curData.companies) + JSON.stringify(curData.activities);
        gsSetDot('ok', '—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ' + new Date().toLocaleTimeString());
        if (!silent) gsShowMsg('‚úÖ –î–∞–Ω–Ω—ã–µ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É', 'ok');
    } catch (e) {
        gsSetDot('error', '–æ—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        if (!silent) gsShowMsg('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 'err');
    } finally {
        gsSaving = false;
    }
}

function gsStartPoll() {
    gsStopPoll();
    if (gsUrl && gsAutoSync && gsInterval >= 5) {
        gsPollTimer = setInterval(() => gsLoad(true), gsInterval * 1000);
    }
}

function gsStopPoll() {
    if (gsPollTimer) { clearInterval(gsPollTimer); gsPollTimer = null; }
}

function gsDisconnect() {
    gsUrl = '';
    localStorage.removeItem('vibeGS_url');
    gsStopPoll();
    gsSetDot('off', '–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
    gsShowMsg('–û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç Google Sheets', 'info');
    document.getElementById('gsUrlInput').value = '';
    gsDataHash = '';
}

// Init Google Sheets UI
document.addEventListener('DOMContentLoaded', () => {
    const urlInput = document.getElementById('gsUrlInput');
    if (gsUrl) {
        urlInput.value = gsUrl;
        gsSetDot('ok', '–ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
        gsStartPoll();
    }
    document.getElementById('gsIntervalInput').value = gsInterval;
    document.getElementById('gsAutoCheck').checked = gsAutoSync;

    // Open/close modal
    document.getElementById('ddGS').onclick = () => {
        document.getElementById('adminMenuList').classList.remove('open');
        document.getElementById('gsModal').classList.add('show');
        document.getElementById('gsMsg').className = 'gs-msg'; // hide msg
    };
    document.getElementById('gsClose').onclick = () => document.getElementById('gsModal').classList.remove('show');

    // Test connection
    document.getElementById('gsTestBtn').onclick = () => {
        gsUrl = urlInput.value.trim();
        if (gsUrl) { localStorage.setItem('vibeGS_url', gsUrl); gsStartPoll(); }
        gsTest();
    };

    // Load from Sheets
    document.getElementById('gsLoadBtn').onclick = () => {
        gsUrl = urlInput.value.trim();
        if (gsUrl) { localStorage.setItem('vibeGS_url', gsUrl); gsStartPoll(); }
        gsLoad(false);
    };

    // Save to Sheets
    document.getElementById('gsSaveBtn').onclick = () => {
        gsUrl = urlInput.value.trim();
        if (gsUrl) { localStorage.setItem('vibeGS_url', gsUrl); gsStartPoll(); }
        gsSave(false);
    };

    // Disconnect
    document.getElementById('gsDisconnect').onclick = gsDisconnect;

    // Auto-sync toggle
    document.getElementById('gsAutoCheck').onchange = (e) => {
        gsAutoSync = e.target.checked;
        localStorage.setItem('vibeGS_auto', gsAutoSync);
        if (gsAutoSync) gsStartPoll(); else gsStopPoll();
    };
    document.getElementById('gsIntervalInput').onchange = (e) => {
        gsInterval = Math.max(5, parseInt(e.target.value) || 30);
        e.target.value = gsInterval;
        localStorage.setItem('vibeGS_interval', gsInterval);
        if (gsAutoSync) gsStartPoll();
    };

    // Show/copy Apps Script code
    document.getElementById('gsShowCode').onclick = () => {
        const box = document.getElementById('gsCodeBox');
        box.classList.toggle('show');
        if (box.classList.contains('show')) {
            document.getElementById('gsCodePre').textContent = GS_APPS_SCRIPT_CODE;
        }
    };
    document.getElementById('gsCopyCode').onclick = () => {
        navigator.clipboard.writeText(GS_APPS_SCRIPT_CODE).then(() => {
            const btn = document.getElementById('gsCopyCode');
            btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => btn.textContent = 'üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥', 1500);
        });
    };
    document.getElementById('gsCodeClose').onclick = () => {
        document.getElementById('gsCodeBox').classList.remove('show');
    };

    // Hash generator button
    document.getElementById('gsHashBtn').onclick = async () => {
        const pass = document.getElementById('gsPassInput').value;
        if (!pass) return;
        const hash = await sha256(pass);
        document.getElementById('gsHashResult').textContent = hash;
        navigator.clipboard.writeText(hash).then(() => {
            document.getElementById('gsHashResult').textContent = hash + ' ‚úÖ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
        });
    };

    // Auth: Enter in password field ‚Üí submit
    document.getElementById('authPass').addEventListener('keydown', e => {
        if (e.key === 'Enter') doAuth();
    });
    document.getElementById('authLogin').addEventListener('keydown', e => {
        if (e.key === 'Enter') document.getElementById('authPass').focus();
    });

    // Close all dropdowns on outside click
    document.addEventListener('click', () => {
        document.querySelectorAll('.tb-dropdown-menu').forEach(m => m.classList.remove('open'));
    });

    // Admin Settings dropdown
    document.getElementById('adminMenuBtn').onclick = (e) => {
        e.stopPropagation();
        document.getElementById('userMenuList').classList.remove('open');
        document.getElementById('adminMenuList').classList.toggle('open');
    };
    document.getElementById('ddUsers').onclick = () => {
        document.getElementById('adminMenuList').classList.remove('open');
        adminShowPanel();
    };
    document.getElementById('ddApiKeys').onclick = () => {
        document.getElementById('adminMenuList').classList.remove('open');
        finShowKeySetup(null);
    };
    document.getElementById('ddTheme').onclick = (e) => {
        e.stopPropagation();
        setTheme(!isDarkTheme());
    };

    // User avatar dropdown
    document.getElementById('userMenuBtn').onclick = (e) => {
        e.stopPropagation();
        document.getElementById('adminMenuList').classList.remove('open');
        document.getElementById('userMenuList').classList.toggle('open');
    };
    document.getElementById('ddLogout').onclick = () => {
        document.getElementById('userMenuList').classList.remove('open');
        authLogout();
    };
    document.getElementById('adminCloseBtn').onclick = adminClosePanel;
    document.getElementById('adminAddBtn').onclick = adminAddUser;
    document.getElementById('adminModal').onclick = (e) => {
        if (e.target.id === 'adminModal') adminClosePanel();
    };

    // Auth: check session on load, show login if GS connected
    authCheckSession();
    authShowLoginIfNeeded();
});

// beforeunload ‚Äî warn if unsaved changes
window.addEventListener('beforeunload', e => {
    if (dirty) {
        e.preventDefault();
        e.returnValue = '';
    }
});

// INIT
init3D();

// Auto-load from localStorage on startup
(async function autoLoad() {
    const saved = loadFromStorage();
    if (saved) {
        document.getElementById('upload').classList.add('gone');
        if (saved.nWeeks) nWeeks = saved.nWeeks;
        // Restore custom events if saved
        if (saved.eventsMeta && Array.isArray(saved.eventsMeta)) {
            EVENTS_META.length = 0;
            saved.eventsMeta.forEach(e => EVENTS_META.push(e));
            rebuildEventsDerived();
        }
        if (!logosReady) await preloadLogos();
        build(saved.curData);
        if (currentView === '3d') switchView('2d');
        markClean();
    }
})();
</script>
</body>
</html>
